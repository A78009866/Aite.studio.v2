name: Smart Flutter Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name (safe filename)'
        required: true
      display_name:
        description: 'Display Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Request ID'
        required: false
      flutter_version:
        description: 'Flutter Version'
        required: false
        default: '3.24.0'
      build_mode:
        description: 'Build Mode'
        required: false
        default: 'release'

env:
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  analyze:
    name: Analyze Project
    runs-on: ubuntu-latest
    outputs:
      flutter_version: ${{ steps.detect.outputs.flutter_version }}
      app_name: ${{ steps.vars.outputs.app_name }}
      package_name: ${{ steps.vars.outputs.package_name }}
      request_id: ${{ steps.vars.outputs.request_id }}
      icon_url: ${{ steps.vars.outputs.icon_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "app_name=${{ github.event.client_payload.app_name }}" >> $GITHUB_OUTPUT
            echo "package_name=${{ github.event.client_payload.package_name }}" >> $GITHUB_OUTPUT
            echo "request_id=${{ github.event.client_payload.request_id }}" >> $GITHUB_OUTPUT
            echo "flutter_version=${{ github.event.client_payload.flutter_version || '3.24.0' }}" >> $GITHUB_OUTPUT
            echo "zip_url=${{ github.event.client_payload.zip_url }}" >> $GITHUB_OUTPUT
            echo "icon_url=${{ github.event.client_payload.icon_url }}" >> $GITHUB_OUTPUT
          else
            echo "app_name=${{ github.event.inputs.app_name }}" >> $GITHUB_OUTPUT
            echo "package_name=${{ github.event.inputs.package_name }}" >> $GITHUB_OUTPUT
            echo "request_id=${{ github.event.inputs.request_id || github.run_id }}" >> $GITHUB_OUTPUT
            echo "flutter_version=${{ github.event.inputs.flutter_version || '3.24.0' }}" >> $GITHUB_OUTPUT
            echo "zip_url=${{ github.event.inputs.zip_url }}" >> $GITHUB_OUTPUT
            echo "icon_url=${{ github.event.inputs.icon_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Download Project ZIP
        run: |
          mkdir -p project
          cd project
          curl -L -o project.zip "${{ steps.vars.outputs.zip_url }}"
          unzip -q project.zip
          rm project.zip

      - name: Detect Project Configuration
        id: detect
        run: |
          cd project
          PUBSPEC=$(find . -name "pubspec.yaml" -not -path "*/.*" | head -1)
          PROJECT_DIR=$(dirname "$PUBSPEC")
          cd "$PROJECT_DIR"
          
          FLUTTER_VERSION="${{ steps.vars.outputs.flutter_version }}"
          if [ "$FLUTTER_VERSION" == "stable" ] || [ "$FLUTTER_VERSION" == "beta" ] || [ "$FLUTTER_VERSION" == "dev" ]; then
            FLUTTER_VERSION="3.24.0"
          fi
          
          echo "flutter_version=$FLUTTER_VERSION" >> $GITHUB_OUTPUT

      - name: Upload Project Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-project-${{ steps.vars.outputs.request_id }}
          path: project/
          retention-days: 1

  build:
    name: Build APK
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ needs.analyze.outputs.flutter_version }}
          cache: true

      - name: Download Project
        uses: actions/download-artifact@v4
        with:
          name: flutter-project-${{ needs.analyze.outputs.request_id }}
          path: project

      - name: Locate Project Directory
        run: |
          cd project
          PUBSPEC=$(find . -name "pubspec.yaml" -not -path "*/.*" | head -1)
          PROJECT_DIR=$(dirname "$PUBSPEC")
          echo "PROJECT_PATH=$PROJECT_DIR" >> $GITHUB_ENV

      - name: Fix Android Embedding
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          PKG_NAME="${{ needs.analyze.outputs.package_name }}"
          PKG_PATH=$(echo "$PKG_NAME" | tr '.' '/')
          
          # Fix AndroidManifest.xml for V2 Embedding only if needed
          if grep -q 'android:name="io.flutter.app.FlutterApplication"' android/app/src/main/AndroidManifest.xml 2>/dev/null; then
            sed -i 's/android:name="io.flutter.app.FlutterApplication"/android:name="${applicationName}"/' android/app/src/main/AndroidManifest.xml
          fi
          
          # Add flutterEmbedding meta-data if missing
          if ! grep -q "flutterEmbedding" android/app/src/main/AndroidManifest.xml 2>/dev/null; then
            sed -i '/<\/activity>/a\        <meta-data android:name="flutterEmbedding" android:value="2" />' android/app/src/main/AndroidManifest.xml 2>/dev/null || true
          fi
          
          # Create MainActivity.kt for V2 Embedding only if not exists
          mkdir -p "android/app/src/main/kotlin/$PKG_PATH"
          if [ ! -f "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt" ]; then
            echo "package $PKG_NAME" > "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "import io.flutter.embedding.android.FlutterActivity" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "class MainActivity: FlutterActivity()" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
          fi
          
          # Remove old MainActivity.java if exists
          find android -name "MainActivity.java" -delete 2>/dev/null || true
          
          # Update package name only if different
          CURRENT_PKG=$(grep "applicationId" android/app/build.gradle | head -1 | sed 's/.*applicationId "\(.*\)".*/\1/')
          if [ "$CURRENT_PKG" != "$PKG_NAME" ]; then
            sed -i "s/applicationId \".*\"/applicationId \"$PKG_NAME\"/" android/app/build.gradle
          fi

      - name: Setup App Icon
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-mdpi
          
          curl -L -o icon.png "${{ needs.analyze.outputs.icon_url }}" 2>/dev/null || echo "Icon download failed, using default"
          
          if [ -f "icon.png" ]; then
            cp icon.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png 2>/dev/null || true
            cp icon.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png 2>/dev/null || true
            cp icon.png android/app/src/main/res/mipmap-xhdpi/ic_launcher.png 2>/dev/null || true
            cp icon.png android/app/src/main/res/mipmap-hdpi/ic_launcher.png 2>/dev/null || true
            cp icon.png android/app/src/main/res/mipmap-mdpi/ic_launcher.png 2>/dev/null || true
          fi

      - name: Get Dependencies
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          flutter config --no-analytics 2>/dev/null || true
          
          # Try to get dependencies without modifying pubspec.yaml
          flutter pub get 2>&1 || {
            echo "Initial pub get failed, trying with upgrade..."
            flutter pub upgrade 2>&1 || {
              echo "Upgrade failed, trying to remove lock file..."
              rm -f pubspec.lock
              flutter pub get 2>&1 || {
                echo "All attempts failed, continuing anyway..."
                exit 0
              }
            }
          }

      - name: Build APK
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          # Try build with error tolerance
          flutter build apk --release \
            --target-platform=android-arm64,android-arm,android-x64 \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }} 2>&1 || {
            echo "Build failed, trying with --no-tree-shake-icons..."
            flutter build apk --release \
              --target-platform=android-arm64,android-arm,android-x64 \
              --build-name=1.0.0 \
              --build-number=${{ github.run_number }} \
              --no-tree-shake-icons 2>&1 || {
              echo "Build failed completely"
              exit 1
            }
          }

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ needs.analyze.outputs.request_id }}
          path: project/${{ env.PROJECT_PATH }}/build/app/outputs/flutter-apk/*.apk
          retention-days: 7
          if-no-files-found: ignore

  release:
    name: Create Release
    needs: [analyze, build]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: apk-${{ needs.analyze.outputs.request_id }}
          path: release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.analyze.outputs.request_id }}
          name: "${{ needs.analyze.outputs.app_name }} - Build ${{ github.run_number }}"
          files: release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
