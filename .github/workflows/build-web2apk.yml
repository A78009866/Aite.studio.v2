# =============================================================================
# Aite.studio - Web to APK Builder (Simplified)
# =============================================================================

name: Build Web to APK

on:
  repository_dispatch:
    types: [build-web2apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        default: 'MyApp'
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.example.app'
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Build ID'
        required: false
        default: 'manual'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Project
        run: |
          mkdir -p project && cd project
          curl -sL "${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}" -o project.zip
          unzip -q project.zip && rm project.zip
          ls -la

      - name: Download Icon
        run: |
          mkdir -p project/icon
          curl -sL "${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}" -o project/icon/icon.png

      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java & Android
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      - name: Build APK
        run: |
          # Create Capacitor project
          mkdir -p build && cd build
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android

          # Create config
          cat > capacitor.config.json <<EOF
          {
            "appId": "${{ github.event.client_payload.package_name || github.event.inputs.package_name }}",
            "appName": "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}",
            "webDir": "www"
          }
          EOF

          # Setup www folder
          mkdir -p www
          if [ -f "../project/index.html" ]; then
            cp -r ../project/* www/
          else
            cp -r ../project/*/* www/ 2>/dev/null || cp -r ../project/* www/
          fi

          # Add Android and build
          npx cap add android
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Sign APK
        run: |
          cd build/android
          APK=$(find app/build/outputs/apk -name "*.apk" | head -1)
          
          # Create keystore
          keytool -genkey -v -keystore key.jks -alias key -storepass 123456 -keypass 123456 \
            -keyalg RSA -validity 10000 -dname "CN=Android" 2>/dev/null
          
          # Sign
          jarsigner -keystore key.jks -storepass 123456 -keypass 123456 \
            -sigalg SHA256withRSA -digestalg SHA-256 "$APK" key 2>/dev/null
          
          cp "$APK" ../../app.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id || github.event.inputs.request_id }}
          name: "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          files: app.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
