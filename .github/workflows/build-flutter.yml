name: Smart Flutter Cloud Build (Universal v3.3)

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url }}

jobs:
  universal-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: 1. Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick openjdk-17-jdk

      - name: 2. Download and Extract
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: 3. Analyze Project Structure
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cat <<EOF > detect_version.py
          import re, os
          is_legacy = False
          flutter_ver = "" 
          if os.path.exists("pubspec.yaml"):
              with open("pubspec.yaml", "r") as f:
                  content = f.read()
                  match = re.search(r'sdk:\s*["\']?([><=^0-9\.\s-]+)["\']?', content)
                  if match:
                      ver_str = match.group(1)
                      if "2.12" not in ver_str and "3." not in ver_str and ("<3.0.0" in ver_str or "2." in ver_str):
                          is_legacy = True
                          flutter_ver = "3.7.12"
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"IS_LEGACY={str(is_legacy).lower()}\n")
              f.write(f"FLUTTER_VER={flutter_ver}\n")
          EOF
          python3 detect_version.py

      - name: 4. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VER }}
          cache: true

      - name: 5. Auto-Fix Gradle & Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # 1. Mock firebase_options
          if grep -r "firebase_options.dart" lib/ > /dev/null; then
            if [ ! -f "lib/firebase_options.dart" ]; then
              mkdir -p lib
              echo "class DefaultFirebaseOptions{static get currentPlatform{return null;}}" > lib/firebase_options.dart
            fi
          fi

          # 2. Key Generation
          mkdir -p android/app
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
          # 3. Clean & Sanitize build.gradle (CRITICAL)
          APP_GRADLE="android/app/build.gradle"
          GRADLE_FILE="android/build.gradle"
          WRAPPER="android/gradle/wrapper/gradle-wrapper.properties"
          
          # Remove broken script references
          sed -i '/signing\.gradle/d' $APP_GRADLE
          sed -i '/key\.properties/d' $APP_GRADLE
          
          if [ "${{ env.IS_LEGACY }}" == "true" ]; then
            echo "üîß Mode: LEGACY"
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip" > $WRAPPER
            sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:7.3.0/g' $GRADLE_FILE 2>/dev/null || true
            echo "BUILD_ARGS=--release --no-shrink --no-sound-null-safety" >> $GITHUB_ENV
          else
            echo "‚ú® Mode: MODERN"
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.10.2-all.zip" > $WRAPPER
            
            # Update Root Gradle
            if [ -f "$GRADLE_FILE" ]; then
              sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.5.0/g' $GRADLE_FILE 2>/dev/null || true
              sed -i "s/ext.kotlin_version = .*/ext.kotlin_version = '1.9.24'/" $GRADLE_FILE 2>/dev/null || true
            fi

            # Force re-write Signing & BuildTypes using Python for precision
            python3 -c "
          import re
          path = '$APP_GRADLE'
          with open(path, 'r') as f: content = f.read()
          # Remove existing blocks to prevent duplication errors
          content = re.sub(r'signingConfigs\s*\{.*?\}', '', content, flags=re.DOTALL)
          content = re.sub(r'buildTypes\s*\{.*?\}', '', content, flags=re.DOTALL)
          # Inject new clean config
          new_block = \"\"\"
          signingConfigs {
              release {
                  storeFile file('debug.keystore')
                  storePassword 'android'
                  keyAlias 'androiddebugkey'
                  keyPassword 'android'
              }
          }
          buildTypes {
              release {
                  signingConfig signingConfigs.release
                  minifyEnabled false
                  shrinkResources false
              }
          }
          \"\"\"
          content = re.sub(r'(android\s*\{)', r'\1' + new_block, content)
          with open(path, 'w') as f: f.write(content)
          "
            # Add Namespace if missing (Required by AGP 8+)
            if ! grep -q "namespace" $APP_GRADLE; then
              sed -i "/android {/a \    namespace '${PACKAGE_NAME}'" $APP_GRADLE
            fi
            
            # Set Args with dependency validation skip
            echo "BUILD_ARGS=--release --no-shrink --android-skip-build-dependency-validation" >> $GITHUB_ENV
          fi

          # Final metadata fixes
          sed -i 's/compileSdkVersion [0-9]\+/compileSdkVersion 34/g' $APP_GRADLE 2>/dev/null || true
          sed -i '/flutterVersion/d' android/local.properties 2>/dev/null || true

      - name: 6. Refactor Package Name & Icon
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cat <<EOF > refactor.py
          import os, re
          pkg = "${PACKAGE_NAME}"; name = "${APP_NAME}"; path = pkg.replace('.', '/')
          m = "android/app/src/main/AndroidManifest.xml"
          if os.path.exists(m):
              with open(m, 'r') as f: s = f.read()
              s = re.sub(r'package="[^"]+"', f'package="{pkg}"', s)
              s = re.sub(r'android:label="[^"]+"', 'android:label="@string/app_name"', s)
              with open(m, 'w') as f: f.write(s)
          s_path = "android/app/src/main/res/values/strings.xml"
          os.makedirs(os.path.dirname(s_path), exist_ok=True)
          with open(s_path, 'w') as f: f.write(f'<resources><string name="app_name">{name}</string></resources>')
          g = "android/app/build.gradle"
          if os.path.exists(g):
              with open(g, 'r') as f: s = f.read()
              s = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{pkg}"', s)
              with open(g, 'w') as f: f.write(s)
          for root, dirs, files in os.walk("android/app/src/main"):
              if "MainActivity.java" in files or "MainActivity.kt" in files:
                  f_name = "MainActivity.kt" if "MainActivity.kt" in files else "MainActivity.java"
                  old = os.path.join(root, f_name); new_dir = os.path.join("android/app/src/main", "java" if "java" in root else "kotlin", path)
                  os.makedirs(new_dir, exist_ok=True)
                  with open(old, 'r') as f: c = f.read()
                  c = re.sub(r'package\s+[\w\.]+', f'package {pkg}', c)
                  with open(os.path.join(new_dir, f_name), 'w') as f: f.write(c)
                  break
          EOF
          python3 refactor.py
          wget -q -O icon.png "$ICON_URL"
          rm -rf android/app/src/main/res/mipmap-*
          for s in "mdpi 48" "hdpi 72" "xhdpi 96" "xxhdpi 144" "xxxhdpi 192"; do
             read -r n d <<< "$s"
             mkdir -p android/app/src/main/res/mipmap-$n
             convert icon.png -resize ${d}x${d} android/app/src/main/res/mipmap-$n/ic_launcher.png
          done

      - name: 7. Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter pub get
          flutter build apk ${{ env.BUILD_ARGS }}
          APK=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          mv "$APK" "${SAFE_NAME}.apk"
          echo "APK_PATH=$(pwd)/${SAFE_NAME}.apk" >> $GITHUB_ENV

      - name: 8. Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: "Build ID: ${{ env.BUILD_ID }}\nMode: ${{ env.IS_LEGACY == 'true' && 'Legacy üèöÔ∏è' || 'Modern ‚ú®' }}"
          files: ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
