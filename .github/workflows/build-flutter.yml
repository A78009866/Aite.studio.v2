name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup System Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick
          
      # Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø§ÙØ§ 17 Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          # Ù†Ù‚Ù„ Ø°ÙƒÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª ÙÙŠ Ø§Ù„Ø¬Ø°Ø± Ø£Ùˆ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ)
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      # Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ù†Ø§Ø© stable Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
      - name: Setup Flutter (Universal)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          # ØªÙ… Ø¥Ø²Ø§Ù„Ø© flutter-version Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© SDK 3.7.2)

      - name: ğŸ› ï¸ Smart Auto-Fix & Configuration
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # --- 1. Fix Missing Firebase Options (Dummy File) ---
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "âš ï¸ firebase_options.dart missing. Generating dummy file."
            mkdir -p lib
            cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, TargetPlatform, kIsWeb;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) return android;
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: throw UnsupportedError('DefaultFirebaseOptions have not been configured for ios.');
                default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform.');
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'DUMMY_KEY', appId: '1:123:android:123', messagingSenderId: '123', projectId: 'dummy', storageBucket: 'dummy'
            );
          }
          EOF
          fi

          # --- 2. Smart Project Migrator (Upgrade Gradle/Kotlin if old) ---
          # Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¶Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹ Ø¨ÙŠØ¦Ø© ÙÙ„Ø§ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          
          # ØªØ­Ø¯ÙŠØ« Kotlin Version ÙÙŠ build.gradle
          sed -i 's/ext.kotlin_version = .*/ext.kotlin_version = "1.9.10"/' android/build.gradle || true
          
          # ØªØ­Ø¯ÙŠØ« Gradle Distribution (Ø£Ù‡Ù… Ø®Ø·ÙˆØ© Ù„Ù„ØªÙˆØ§ÙÙ‚)
          if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
             sed -i 's/gradle-.*-all.zip/gradle-7.6.3-all.zip/' android/gradle/wrapper/gradle-wrapper.properties || true
          fi
          
          # ØªØ­Ø¯ÙŠØ« AGP (Android Gradle Plugin) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¯ÙŠÙ…Ø§Ù‹ Ø¬Ø¯Ø§Ù‹
          sed -i 's/com.android.tools.build:gradle:[3-6].*/com.android.tools.build:gradle:7.4.2"/' android/build.gradle || true

          # --- 3. Update App Name, Package & Icon (Python) ---
          cat <<EOF > update_project_info.py
          import os
          import xml.etree.ElementTree as ET
          import re

          app_name = os.environ.get('APP_NAME', 'MyApp')
          package_name = os.environ.get('PACKAGE_NAME', 'com.example.app')
          
          print(f"ğŸ”§ Configuring: {app_name} | {package_name}")

          # Update strings.xml (utf-8 enforced for Arabic)
          strings_path = 'android/app/src/main/res/values/strings.xml'
          os.makedirs(os.path.dirname(strings_path), exist_ok=True)
          xml_content = f'''<?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">{app_name}</string>
          </resources>'''
          with open(strings_path, 'w', encoding='utf-8') as f: f.write(xml_content)

          # Update AndroidManifest.xml
          manifest_path = 'android/app/src/main/AndroidManifest.xml'
          ET.register_namespace('android', 'http://schemas.android.com/apk/res/android')
          try:
              tree = ET.parse(manifest_path)
              root = tree.getroot()
              android_ns = '{http://schemas.android.com/apk/res/android}'
              
              application = root.find('application')
              if application is not None:
                  application.attrib[f'{android_ns}label'] = '@string/app_name'
                  # Force Icon
                  application.attrib[f'{android_ns}icon'] = '@mipmap/ic_launcher'
                  application.attrib[f'{android_ns}roundIcon'] = '@mipmap/ic_launcher'
                  
              tree.write(manifest_path, encoding='utf-8', xml_declaration=True)
          except Exception as e: print(f"Manifest Warning: {e}")

          # Update build.gradle (IDs & Namespaces)
          gradle_path = 'android/app/build.gradle'
          if os.path.exists(gradle_path):
              with open(gradle_path, 'r') as f: content = f.read()
              content = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{package_name}"', content)
              content = re.sub(r'namespace\s+["\'].*?["\']', f'namespace "{package_name}"', content)
              # Ensure MinSDK is decent (21+) for modern Flutter
              content = re.sub(r'minSdkVersion\s+\d+', 'minSdkVersion 21', content)
              with open(gradle_path, 'w') as f: f.write(content)
          EOF
          python3 update_project_info.py

      - name: Setup Signing Key & Optimization
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          if [ ! -f "debug.keystore" ]; then
            keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi
          
          # ØªÙƒÙˆÙŠÙ† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ + ØªÙØ¹ÙŠÙ„ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… (Optimization)
          cat > signing/signing.gradle << 'EOF'
          signingConfigs {
              release {
                  storeFile file("../debug.keystore")
                  storePassword "android"
                  keyAlias "androiddebugkey"
                  keyPassword "android"
              }
          }
          buildTypes {
              release {
                  signingConfig signingConfigs.release
                  minifyEnabled true   // ØªÙØ¹ÙŠÙ„ Ø¶ØºØ· Ø§Ù„ÙƒÙˆØ¯
                  shrinkResources true // Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
                  proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
              }
          }
          EOF

      - name: Process Icon
        run: |
          # ØªÙ†Ø¸ÙŠÙ Ø«Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
          rm -rf $PROJECT_DIR/android/app/src/main/res/mipmap-*
          declare -a sizes=("48x48:mdpi" "72x72:hdpi" "96x96:xhdpi" "144x144:xxhdpi" "192x192:xxxhdpi")
          wget -q -O icon.png "$ICON_URL"
          
          for size in "${sizes[@]}"; do
             IFS=":" read -r px name <<< "$size"
             mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-$name
             convert icon.png -resize $px $PROJECT_DIR/android/app/src/main/res/mipmap-$name/ic_launcher.png
          done

      - name: Get Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: Build Optimized APK (Universal)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… --obfuscate Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… ÙˆØªØµØ¹ÙŠØ¨ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©
          flutter build apk --$BUILD_MODE --target-platform=android-arm,android-arm64 --obfuscate --split-debug-info=symbols/
          
          APK_DIR="build/app/outputs/flutter-apk"
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„Ù€ APK Ø§Ù„Ù†Ø§ØªØ¬ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          GENERATED_APK=$(find $APK_DIR -name "*.apk" | head -n 1)
          FINAL_APK="$APK_DIR/${SAFE_NAME}.apk"
          
          if [ -f "$GENERATED_APK" ]; then
            mv "$GENERATED_APK" "$FINAL_APK"
            echo "âœ… Build Successful: $FINAL_APK"
            echo "APK_PATH=$FINAL_APK" >> $GITHUB_ENV
          else
            echo "âŒ Build Failed: APK not found"
            exit 1
          fi

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            âœ… **ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ (Universal Engine)**
            ğŸ“± **Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** ${{ env.APP_NAME }}
            ğŸ“¦ **Ø§Ù„Ø­Ø²Ù…Ø©:** ${{ env.PACKAGE_NAME }}
          files: |
            ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
