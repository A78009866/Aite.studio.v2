name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url }}
  BUILD_MODE: 'release'

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: 1. Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick openjdk-17-jdk

      - name: 2. Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          # ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø°ÙƒØ§Ø¡ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: 3. Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.22.x' # Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© Ø­Ø¯ÙŠØ«Ø©
          cache: true

      # ========================================================
      # AUTO-FIXER SCRIPT: ÙŠØ­Ù„ Ù…Ø´Ø§ÙƒÙ„ Gradle ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
      # ========================================================
      - name: 4. Auto-Fix Gradle & Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ”§ Starting Auto-Fix process..."
          
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù firebase_options.dart ÙˆÙ‡Ù…ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø§Ù‚ØµØ§Ù‹ Ù„ØªØ¬Ø§ÙˆØ² Ø®Ø·Ø£ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
          if grep -r "firebase_options.dart" lib/ > /dev/null; then
            if [ ! -f "lib/firebase_options.dart" ]; then
              echo "âš ï¸ Mocking missing firebase_options.dart..."
              cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart';
          import 'package:flutter/foundation.dart';
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              return const FirebaseOptions(
                apiKey: 'dummy-api-key',
                appId: 'dummy-app-id',
                messagingSenderId: 'dummy-sender-id',
                projectId: 'dummy-project-id',
              );
            }
          }
          EOF
            fi
          fi

          # 2. ØªØ±Ù‚ÙŠØ© Gradle Wrapper Ø¥Ù„Ù‰ 8.0 (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Flutter Ø§Ù„Ø¬Ø¯ÙŠØ¯)
          mkdir -p android/gradle/wrapper
          echo "distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists" > android/gradle/wrapper/gradle-wrapper.properties

          # 3. ØªØ­Ø¯ÙŠØ« build.gradle Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… AGP Ø£Ø­Ø¯Ø« Ùˆ Kotlin Ø£Ø­Ø¯Ø«
          GRADLE_FILE="android/build.gradle"
          if [ -f "$GRADLE_FILE" ]; then
            # ØªØ­Ø¯ÙŠØ« AGP Ø¥Ù„Ù‰ 8.1.0 ÙˆØªØ­Ø¯ÙŠØ« Kotlin
            sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.1.0/g' $GRADLE_FILE
            sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.10/g' $GRADLE_FILE
            # Ø¥Ø¶Ø§ÙØ© namespace Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Gradle Ø§Ù„Ø¬Ø¯ÙŠØ¯)
            if ! grep -q "namespace" android/app/build.gradle; then
              sed -i "/android {/a \    namespace '${PACKAGE_NAME}'" android/app/build.gradle
            fi
            # Ø­Ø°Ù binding.VERSION_NAME Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„Ø°ÙŠ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„
            sed -i '/flutterVersionName/d' android/local.properties 2>/dev/null || true
            sed -i '/flutterVersionCode/d' android/local.properties 2>/dev/null || true
          fi

      # ========================================================
      # SMART REFACTORING: ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø²Ù…Ø© ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø§Ø³Ù…
      # ========================================================
      - name: 5. Refactor Package & Icon
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ“¦ Refactoring Package to: $PACKAGE_NAME"
          
          # Ø£Ø¯Ø§Ø© Python Ù‚ÙˆÙŠØ© Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
          cat <<EOF > refactor_engine.py
          import os
          import shutil
          import fileinput
          import re

          new_package = "${PACKAGE_NAME}"
          app_name = "${APP_NAME}"
          new_path = new_package.replace('.', '/')
          android_root = "android/app/src/main"
          
          # 1. Update AndroidManifest.xml
          manifest_path = os.path.join(android_root, "AndroidManifest.xml")
          if os.path.exists(manifest_path):
              with open(manifest_path, 'r', encoding='utf-8') as f: content = f.read()
              # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø²Ù…Ø©
              content = re.sub(r'package="[^"]+"', f'package="{new_package}"', content)
              # ØªØ­Ø¯ÙŠØ« Label (Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
              content = re.sub(r'android:label="[^"]+"', 'android:label="@string/app_name"', content)
              with open(manifest_path, 'w', encoding='utf-8') as f: f.write(content)

          # 2. Update Strings.xml (Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
          strings_path = os.path.join(android_root, "res/values/strings.xml")
          os.makedirs(os.path.dirname(strings_path), exist_ok=True)
          with open(strings_path, 'w', encoding='utf-8') as f:
              f.write(f'''<?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">{app_name}</string>
          </resources>''')

          # 3. Update build.gradle (applicationId)
          gradle_path = "android/app/build.gradle"
          if os.path.exists(gradle_path):
              with open(gradle_path, 'r') as f: content = f.read()
              content = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{new_package}"', content)
              content = re.sub(r'namespace\s+["\'].*?["\']', f'namespace "{new_package}"', content)
              with open(gradle_path, 'w') as f: f.write(content)

          # 4. MOVE KOTLIN/JAVA FILES (The most critical part)
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† MainActivity
          java_src = os.path.join(android_root, "java")
          kotlin_src = os.path.join(android_root, "kotlin")
          
          src_dir = kotlin_src if os.path.exists(kotlin_src) else java_src
          if os.path.exists(src_dir):
              # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
              old_package_path = ""
              main_activity_file = ""
              for root, dirs, files in os.walk(src_dir):
                  if "MainActivity.kt" in files or "MainActivity.java" in files:
                      old_package_path = root
                      main_activity_file = "MainActivity.kt" if "MainActivity.kt" in files else "MainActivity.java"
                      break
              
              if old_package_path:
                  # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                  new_full_path = os.path.join(src_dir, new_path)
                  os.makedirs(new_full_path, exist_ok=True)
                  
                  # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ø¯ÙŠØ« Ø³Ø·Ø± package
                  old_file = os.path.join(old_package_path, main_activity_file)
                  new_file = os.path.join(new_full_path, main_activity_file)
                  
                  with open(old_file, 'r', encoding='utf-8') as f: code = f.read()
                  code = re.sub(r'package\s+[\w\.]+', f'package {new_package}', code)
                  
                  with open(new_file, 'w', encoding='utf-8') as f: f.write(code)
                  
                  print(f"âœ… Moved {main_activity_file} from {old_package_path} to {new_full_path}")
                  
                  # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ÙØ§Ø±ØºØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù†ØªØ®Ø·Ø§Ù‡ Ù„Ù„Ø£Ù…Ø§Ù†)

          EOF
          python3 refactor_engine.py

      - name: 6. Process Icon (Force Replace)
        run: |
          wget -q -O icon_original.png "$ICON_URL"
          
          # Ø­Ø°Ù Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙ„Ø§ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø£ÙŠÙ‚ÙˆÙ†ØªÙ†Ø§
          rm -rf $PROJECT_DIR/android/app/src/main/res/mipmap-*
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-hdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xhdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xxhdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi
          
          # ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
          convert icon_original.png -resize 48x48 $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert icon_original.png -resize 72x72 $PROJECT_DIR/android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert icon_original.png -resize 96x96 $PROJECT_DIR/android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert icon_original.png -resize 144x144 $PROJECT_DIR/android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert icon_original.png -resize 192x192 $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          echo "âœ… Icons replaced successfully"

      - name: 7. Setup Signing & Build
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
          cat > android/app/signing.gradle << 'EOF'
          signingConfigs {
              release {
                  storeFile file("debug.keystore")
                  storePassword "android"
                  keyAlias "androiddebugkey"
                  keyPassword "android"
              }
          }
          buildTypes {
              release {
                  signingConfig signingConfigs.release
                  minifyEnabled false # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØµØºÙŠØ± Ù„ØªÙØ§Ø¯ÙŠ Ø£Ø®Ø·Ø§Ø¡ R8 ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                  shrinkResources false
              }
          }
          EOF
          
          # Ø­Ù‚Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙÙŠ build.gradle Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if ! grep -q "apply from: 'signing.gradle'" android/app/build.gradle; then
             sed -i "/apply plugin: 'com.android.application'/a apply from: 'signing.gradle'" android/app/build.gradle
          fi

          # Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡
          flutter pub get
          
          # Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ØµØ§Ø±Ù…Ø©
          flutter build apk --release --no-shrink

          # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
          APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          mv "$APK_PATH" "build/app/outputs/flutter-apk/${SAFE_NAME}.apk"
          echo "APK_PATH=$(pwd)/build/app/outputs/flutter-apk/${SAFE_NAME}.apk" >> $GITHUB_ENV

      - name: 8. Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            âœ… **Build Success**
            **ID:** ${{ env.BUILD_ID }}
            **Package:** ${{ env.PACKAGE_NAME }}
          files: ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
