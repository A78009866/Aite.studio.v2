name: Aite Smart Logic Engine (optimized & faster)

on:
  repository_dispatch:
    types: [build-flutter]

permissions:
  contents: write

jobs:
  analyze_and_build:
    name: Analyze & Build
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ runner.temp }}/.gradle_cache
      DEFAULT_FLUTTER_VERSION: "3.10.6" # قابل للتعديل
      ANDROID_COMPILE_SDK: "33"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python (for pubspec parsing)
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Download & extract uploaded ZIP
        run: |
          mkdir -p temp_zip
          curl -L "${{ github.event.client_payload.zip_url }}" -o project.zip
          unzip -q project.zip -d temp_zip
          REAL_ROOT=$(find temp_zip -name "pubspec.yaml" -exec dirname {} + | head -n 1 || true)
          if [ -z "$REAL_ROOT" ]; then
            echo "ERROR_NO_PUBSPEC=true" >> $GITHUB_ENV
          else
            echo "PROJECT_ROOT=$REAL_ROOT" >> $GITHUB_ENV
          fi

      - name: Fail early if no pubspec found
        if: env.ERROR_NO_PUBSPEC == 'true'
        run: |
          echo "No Flutter project (pubspec.yaml) found in the uploaded zip."
          exit 1

      - name: Analyze pubspec.yaml and choose Flutter (best-effort)
        id: analyze_pubspec
        run: |
          python - <<'PY' > /tmp/flutter_choice.env
import yaml, os, re
root = os.getenv('PROJECT_ROOT')
p = os.path.join(root,'pubspec.yaml')
flutter_ver = os.getenv('DEFAULT_FLUTTER_VERSION','3.10.6')
java_ver = "17"
channel = "stable"
try:
    with open(p,'r',encoding='utf-8') as f:
        data = yaml.safe_load(f) or {}
    sdk = None
    env_block = data.get('environment') or {}
    sdk = env_block.get('sdk')
    if sdk:
        # قواعد بسيطة للتمييز — قابل للتوسعة
        if re.search(r'\\b3\\.', sdk):
            flutter_ver = flutter_ver
            java_ver = "17"
            channel = "stable"
        elif re.search(r'\\b2\\.', sdk):
            flutter_ver = "3.10.6"
            java_ver = "11"
            channel = "stable"
except Exception as e:
    pass
print("FLUTTER_VERSION=" + str(flutter_ver))
print("FLUTTER_CHANNEL=" + str(channel))
print("JAVA_VERSION=" + str(java_ver))
PY
          cat /tmp/flutter_choice.env >> $GITHUB_ENV
          cat /tmp/flutter_choice.env

      - name: Setup Java (use chosen stable)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK commandline tools and platform-tools
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget lib32stdc++6 lib32z1
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d cmdline
          mkdir -p cmdline-tools/latest
          mv cmdline cmdline-tools/latest/cmdline
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline/bin:$PATH
          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" "build-tools;33.0.2" "ndk;23.1.7779620" || true
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Cache pub & gradle & flutter cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ env.GRADLE_USER_HOME }}
            ~/.flutter/bin/cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}-${{ github.event.client_payload.request_id }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Preflight - flutter doctor & pub get
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          flutter --version
          flutter doctor -v || true
          flutter pub get --verbose

      - name: Ensure gradlew executable (if project uses gradle wrapper)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          if [ -f "./android/gradlew" ]; then chmod +x ./android/gradlew; fi

      - name: Enable Gradle build cache (local) for performance
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mkdir -p ${{ env.GRADLE_USER_HOME }}
          # إضاءة caching إن لم تكن مفعلة
          echo "org.gradle.caching=true" >> ${{ env.GRADLE_USER_HOME }}/gradle.properties || true

      - name: Build APK (release, split per ABI) with logs and retries
        working-directory: ${{ env.PROJECT_ROOT }}
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          JAVA_HOME: ${{ env.JAVA_HOME }}
        run: |
          set -euo pipefail
          LOGDIR=$RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}
          mkdir -p "$LOGDIR"
          MAX_ATTEMPTS=2
          attempt=0
          BUILD_OK=0
          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            attempt=$((attempt+1))
            echo "Build attempt #$attempt"
            # محاولة مباشرة للإصدار release مع split-per-abi لتقليل حجم ووقت التجميع للأهداف المتعددة بالتوازي داخل gradle
            flutter build apk --release --split-per-abi --no-shrink -v > "$LOGDIR/build-$attempt.log" 2>&1 || true
            if grep -q "Built build/app/outputs" "$LOGDIR/build-$attempt.log" || find build -name "*.apk" | grep -q .; then
              BUILD_OK=1
              break
            fi
            echo "Attempt $attempt failed, collecting logs..."
            sleep 6
          done
          if [ "$BUILD_OK" -ne 1 ]; then
            echo "Build failed after $MAX_ATTEMPTS attempts, uploading logs and failing..."
            tar -czf $RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}.tgz -C "$LOGDIR" .
            echo "BUILD_TGZ=$RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}.tgz" >> $GITHUB_ENV
            exit 1
          fi
          # اختر أول APK موجود
          FINAL_APK=$(find build -name "*.apk" | head -n 1 || true)
          if [ -z "$FINAL_APK" ]; then
            echo "No APK produced (unexpected)."
            exit 1
          fi
          echo "FINAL_APK_PATH=$FINAL_APK" >> $GITHUB_ENV
          echo "Found APK: $FINAL_APK"

      - name: Upload Release with APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id }}
          files: ${{ env.PROJECT_ROOT }}/${{ env.FINAL_APK_PATH }}
          body: |
            ✅ Build Success
            - App: ${{ github.event.client_payload.display_name }}
            - Request ID: ${{ github.event.client_payload.request_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.event.client_payload.request_id }}
          path: ${{ env.BUILD_TGZ }}
