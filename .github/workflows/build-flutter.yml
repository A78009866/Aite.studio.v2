# =============================================================================
# Aite.studio - Smart Flutter Build Workflow
# =============================================================================

name: Smart Flutter Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name (safe filename)'
        required: true
      display_name:
        description: 'Display Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Request ID'
        required: false
      flutter_version:
        description: 'Flutter Version'
        required: false
        default: '3.24.0'
      build_mode:
        description: 'Build Mode'
        required: false
        default: 'release'

env:
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  # ===========================================================================
  # Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
  # ===========================================================================
  analyze:
    name: ğŸ” Analyze Project
    runs-on: ubuntu-latest
    outputs:
      flutter_version: ${{ steps.detect.outputs.flutter_version }}
      min_sdk: ${{ steps.detect.outputs.min_sdk }}
      target_sdk: ${{ steps.detect.outputs.target_sdk }}
      has_native_code: ${{ steps.detect.outputs.has_native_code }}
      needs_ndk: ${{ steps.detect.outputs.needs_ndk }}
      ndk_version: ${{ steps.detect.outputs.ndk_version }}
      cmake_version: ${{ steps.detect.outputs.cmake_version }}
      build_abi: ${{ steps.detect.outputs.build_abi }}
      has_plugins: ${{ steps.detect.outputs.has_plugins }}
      plugin_list: ${{ steps.detect.outputs.plugin_list }}
      app_name: ${{ steps.vars.outputs.app_name }}
      package_name: ${{ steps.vars.outputs.package_name }}
      request_id: ${{ steps.vars.outputs.request_id }}
      icon_url: ${{ steps.vars.outputs.icon_url }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”„ Setup Variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "app_name=${{ github.event.client_payload.app_name }}" >> $GITHUB_OUTPUT
            echo "package_name=${{ github.event.client_payload.package_name }}" >> $GITHUB_OUTPUT
            echo "request_id=${{ github.event.client_payload.request_id }}" >> $GITHUB_OUTPUT
            echo "flutter_version=${{ github.event.client_payload.flutter_version || '3.24.0' }}" >> $GITHUB_OUTPUT
            echo "zip_url=${{ github.event.client_payload.zip_url }}" >> $GITHUB_OUTPUT
            echo "icon_url=${{ github.event.client_payload.icon_url }}" >> $GITHUB_OUTPUT
          else
            echo "app_name=${{ github.event.inputs.app_name }}" >> $GITHUB_OUTPUT
            echo "package_name=${{ github.event.inputs.package_name }}" >> $GITHUB_OUTPUT
            echo "request_id=${{ github.event.inputs.request_id || github.run_id }}" >> $GITHUB_OUTPUT
            echo "flutter_version=${{ github.event.inputs.flutter_version || '3.24.0' }}" >> $GITHUB_OUTPUT
            echo "zip_url=${{ github.event.inputs.zip_url }}" >> $GITHUB_OUTPUT
            echo "icon_url=${{ github.event.inputs.icon_url }}" >> $GITHUB_OUTPUT
          fi

      - name: â¬‡ï¸ Download Project ZIP
        run: |
          mkdir -p project
          cd project
          echo "Downloading project from: ${{ steps.vars.outputs.zip_url }}"
          curl -L -o project.zip "${{ steps.vars.outputs.zip_url }}"
          echo "Downloaded size: $(du -h project.zip | cut -f1)"
          unzip -q project.zip
          rm project.zip
          echo "Project structure:"
          find . -maxdepth 2 -type f -name "*.yaml" -o -name "*.yml" -o -name "*.gradle" | head -20

      - name: ğŸ” Detect Project Configuration
        id: detect
        run: |
          cd project
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† pubspec.yaml
          PUBSPEC=$(find . -name "pubspec.yaml" -not -path "*/.*" | head -1)
          if [ -z "$PUBSPEC" ]; then
            echo "âŒ No pubspec.yaml found!"
            exit 1
          fi
          
          echo "Found pubspec.yaml at: $PUBSPEC"
          PROJECT_DIR=$(dirname "$PUBSPEC")
          cd "$PROJECT_DIR"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Flutter version Ù…Ù† pubspec.yaml
          # Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø£Ùˆ Ù†Ø³Ù‚Ø· Ø¹Ù„Ù‰ 3.24.0
          FLUTTER_VERSION="${{ steps.vars.outputs.flutter_version }}"
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù„ÙŠØ³ "stable" Ø¨Ù„ Ø±Ù‚Ù… Ù…Ø­Ø¯Ø¯
          if [ "$FLUTTER_VERSION" == "stable" ] || [ "$FLUTTER_VERSION" == "beta" ] || [ "$FLUTTER_VERSION" == "dev" ]; then
            FLUTTER_VERSION="3.24.0"
          fi
          
          # Ù‚Ø±Ø§Ø¡Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Android
          if [ -f "android/app/build.gradle" ]; then
            MIN_SDK=$(grep -E "minSdkVersion|minSdk" android/app/build.gradle | grep -oE '[0-9]+' | head -1 || echo "21")
            TARGET_SDK=$(grep -E "targetSdkVersion|targetSdk" android/app/build.gradle | grep -oE '[0-9]+' | head -1 || echo "34")
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† NDK
            NEEDS_NDK="false"
            NDK_VERSION=""
            if grep -q "ndkVersion" android/app/build.gradle 2>/dev/null; then
              NEEDS_NDK="true"
              NDK_VERSION=$(grep "ndkVersion" android/app/build.gradle | grep -oE '"[^"]*"' | tr -d '"' || echo "25.1.8937393")
            fi
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† CMake
            CMAKE_VERSION=""
            if grep -q "externalNativeBuild" android/app/build.gradle 2>/dev/null; then
              CMAKE_VERSION=$(grep -A 5 "externalNativeBuild" android/app/build.gradle | grep "version" | grep -oE '"[^"]*"' | tr -d '"' || echo "")
            fi
          else
            MIN_SDK="21"
            TARGET_SDK="34"
            NEEDS_NDK="false"
          fi
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙˆØ¯ native
          HAS_NATIVE="false"
          if [ -d "android/app/src/main/jni" ] || [ -d "android/app/src/main/cpp" ]; then
            HAS_NATIVE="true"
            NEEDS_NDK="true"
          fi
          
          # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ plugins
          PLUGINS=$(grep -A 1000 "dependencies:" pubspec.yaml | grep -E "^\s+\w+:" | grep -v "flutter:" | grep -v "sdk:" | head -20 | sed 's/:.*//' | tr '\n' ',' | sed 's/,$//')
          HAS_PLUGINS=$([ -n "$PLUGINS" ] && echo "true" || echo "false")
          
          # ØªØ­Ø¯ÙŠØ¯ ABI Ù„Ù„Ø¨Ù†Ø§Ø¡
          BUILD_ABI="arm64-v8a,armeabi-v7a,x86_64"
          if grep -q "abiFilters" android/app/build.gradle 2>/dev/null; then
            BUILD_ABI=$(grep -A 3 "abiFilters" android/app/build.gradle | grep -oE '"[^"]*"' | tr -d '"' | tr '\n' ',')
          fi
          
          # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          echo "========================================"
          echo "ğŸ“Š Project Analysis Results:"
          echo "========================================"
          echo "Flutter Version: $FLUTTER_VERSION"
          echo "Min SDK: $MIN_SDK"
          echo "Target SDK: $TARGET_SDK"
          echo "Needs NDK: $NEEDS_NDK"
          echo "NDK Version: $NDK_VERSION"
          echo "CMake Version: $CMAKE_VERSION"
          echo "Has Native Code: $HAS_NATIVE"
          echo "Build ABI: $BUILD_ABI"
          echo "Has Plugins: $HAS_PLUGINS"
          echo "Plugins: $PLUGINS"
          echo "========================================"
          
          # ØªØ¹ÙŠÙŠÙ† outputs
          echo "flutter_version=$FLUTTER_VERSION" >> $GITHUB_OUTPUT
          echo "min_sdk=$MIN_SDK" >> $GITHUB_OUTPUT
          echo "target_sdk=$TARGET_SDK" >> $GITHUB_OUTPUT
          echo "has_native_code=$HAS_NATIVE" >> $GITHUB_OUTPUT
          echo "needs_ndk=$NEEDS_NDK" >> $GITHUB_OUTPUT
          echo "ndk_version=$NDK_VERSION" >> $GITHUB_OUTPUT
          echo "cmake_version=$CMAKE_VERSION" >> $GITHUB_OUTPUT
          echo "build_abi=$BUILD_ABI" >> $GITHUB_OUTPUT
          echo "has_plugins=$HAS_PLUGINS" >> $GITHUB_OUTPUT
          echo "plugin_list=$PLUGINS" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload Project Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-project-${{ steps.vars.outputs.request_id }}
          path: project/
          retention-days: 1

  # ===========================================================================
  # Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  # ===========================================================================
  build:
    name: ğŸ”¨ Build APK
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
          ndk: ${{ needs.analyze.outputs.needs_ndk == 'true' && needs.analyze.outputs.ndk_version || '' }}
          cmake: ${{ needs.analyze.outputs.cmake_version || '' }}

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ needs.analyze.outputs.flutter_version }}
          cache: true

      - name: ğŸ“‹ Verify Flutter
        run: |
          flutter --version
          flutter doctor -v

      - name: â¬‡ï¸ Download Project
        uses: actions/download-artifact@v4
        with:
          name: flutter-project-${{ needs.analyze.outputs.request_id }}
          path: project

      - name: ğŸ“‚ Locate Project Directory
        run: |
          cd project
          PUBSPEC=$(find . -name "pubspec.yaml" -not -path "*/.*" | head -1)
          PROJECT_DIR=$(dirname "$PUBSPEC")
          echo "PROJECT_PATH=$PROJECT_DIR" >> $GITHUB_ENV
          echo "Found project at: $PROJECT_DIR"

      - name: ğŸ”§ Setup Project Configuration
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          # ØªØ­Ø¯ÙŠØ« Package Name
          if [ -f "android/app/build.gradle" ]; then
            echo "Updating package name to: ${{ needs.analyze.outputs.package_name }}"
            sed -i "s/applicationId \".*\"/applicationId \"${{ needs.analyze.outputs.package_name }}\"/" android/app/build.gradle
            
            # ØªØ­Ø¯ÙŠØ« SDK versions Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            sed -i "s/minSdkVersion .*/minSdkVersion ${{ needs.analyze.outputs.min_sdk }}/" android/app/build.gradle
            sed -i "s/targetSdkVersion .*/targetSdkVersion ${{ needs.analyze.outputs.target_sdk }}/" android/app/build.gradle
          fi
          
          # ØªØ­Ø¯ÙŠØ« AndroidManifest.xml
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            sed -i "s/package=\"[^\"]*\"/package=\"${{ needs.analyze.outputs.package_name }}\"/" android/app/src/main/AndroidManifest.xml
          fi
          
          # ØªØ­Ø¯ÙŠØ« MainActivity.kt/java
          MAIN_KT=$(find android -name "MainActivity.kt" 2>/dev/null | head -1)
          MAIN_JAVA=$(find android -name "MainActivity.java" 2>/dev/null | head -1)
          
          if [ -n "$MAIN_KT" ]; then
            sed -i "s/package .*/package ${{ needs.analyze.outputs.package_name }}/" "$MAIN_KT"
          elif [ -n "$MAIN_JAVA" ]; then
            sed -i "s/package .*/package ${{ needs.analyze.outputs.package_name }};/" "$MAIN_JAVA"
          fi

      - name: ğŸ–¼ï¸ Setup App Icon
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          echo "Downloading icon from: ${{ needs.analyze.outputs.icon_url }}"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ mipmap
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-mdpi
          
          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
          curl -L -o icon.png "${{ needs.analyze.outputs.icon_url }}"
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… ImageMagick Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ø®ØªÙ„ÙØ© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹)
          if command -v convert &> /dev/null; then
            convert icon.png -resize 512x512 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            convert icon.png -resize 384x384 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            convert icon.png -resize 256x256 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
            convert icon.png -resize 192x192 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
            convert icon.png -resize 128x128 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          else
            # Ù†Ø³Ø® Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙƒÙ…Ø§ Ù‡ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
            cp icon.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            cp icon.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            cp icon.png android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
            cp icon.png android/app/src/main/res/mipmap-hdpi/ic_launcher.png
            cp icon.png android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          fi
          
          echo "Icon setup complete"

      - name: ğŸ”§ Fix Pubspec SDK Constraints
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          echo "Fixing SDK constraints for null safety..."
          
          if [ -f "pubspec.yaml" ]; then
            # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            cp pubspec.yaml pubspec.yaml.bak
            
            # ØªØ­Ø¯ÙŠØ« environment sdk
            sed -i "s/sdk: '>=2\.0\.0-dev\.68\.0 <3\.0\.0'/sdk: '>=2.12.0 <4.0.0'/" pubspec.yaml
            sed -i "s/sdk: '>=2\.[0-9]*\.[0-9]* <3\.0\.0'/sdk: '>=2.12.0 <4.0.0'/" pubspec.yaml
            sed -i "s/sdk: \">=2\.[0-9]*\.[0-9]* <3\.0\.0\"/sdk: '>=2.12.0 <4.0.0'/" pubspec.yaml
            sed -i "s/sdk: '>=2\.[0-9]*\.[0-9]*-dev\.[0-9]* <3\.0\.0'/sdk: '>=2.12.0 <4.0.0'/" pubspec.yaml
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ environment sectionØŒ Ù†Ø­Ø¯Ø«Ù‡
            if grep -q "environment:" pubspec.yaml; then
              # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù€ sdk
              sed -i '/environment:/,/^[^ ]/{s/sdk:.*/sdk: '\''>=2.12.0 <4.0.0'\''/}' pubspec.yaml
            else
              # Ø¥Ø¶Ø§ÙØ© environment section
              echo "" >> pubspec.yaml
              echo "environment:" >> pubspec.yaml
              echo "  sdk: '>=2.12.0 <4.0.0'" >> pubspec.yaml
            fi
            
            echo "âœ… Updated pubspec.yaml:"
            grep -A 2 "environment:" pubspec.yaml || cat pubspec.yaml | head -30
          fi

      - name: ğŸ”§ Fix Dependencies Versions
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          echo "Fixing dependencies versions..."
          
          if [ -f "pubspec.yaml" ]; then
            # ØªØ­Ø¯ÙŠØ« cupertino_icons Ø¥Ù„Ù‰ Ø¥ØµØ¯Ø§Ø± ÙŠØ¯Ø¹Ù… null safety
            sed -i 's/cupertino_icons: \^0\.[0-9]*\.[0-9]*/cupertino_icons: ^1.0.5/g' pubspec.yaml
            sed -i 's/cupertino_icons: ">=0\.[0-9]*\.[0-9]* <1\.0\.[0-9]*"/cupertino_icons: ^1.0.5/g' pubspec.yaml
            
            # Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙŠÙˆØ¯ Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù„Ù‰ cupertino_icons
            sed -i 's/cupertino_icons:.*<1\.0\.[0-9]*/cupertino_icons: ^1.0.5/g' pubspec.yaml
            
            # ØªØ­Ø¯ÙŠØ« shared_preferences Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            sed -i 's/shared_preferences: \^0\.[0-9]*\.[0-9]*/shared_preferences: ^2.2.0/g' pubspec.yaml
            
            # ØªØ­Ø¯ÙŠØ« http Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            sed -i 's/http: \^0\.[0-9]*\.[0-9]*/http: ^1.1.0/g' pubspec.yaml
            
            # ØªØ­Ø¯ÙŠØ« path_provider Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            sed -i 's/path_provider: \^1\.[0-9]*\.[0-9]*/path_provider: ^2.1.0/g' pubspec.yaml
            sed -i 's/path_provider: \^0\.[0-9]*\.[0-9]*/path_provider: ^2.1.0/g' pubspec.yaml
            
            echo "âœ… Updated dependencies:"
            grep -A 30 "dependencies:" pubspec.yaml | head -35
          fi

      - name: ğŸ“¦ Get Dependencies
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          echo "Getting Flutter dependencies..."
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ dependencies
          flutter pub get || {
            echo "âš ï¸ Initial pub get failed, trying upgrade..."
            flutter pub upgrade --major-versions || {
              echo "âš ï¸ Upgrade failed, trying with --no-precompile..."
              flutter pub get --no-precompile
            }
          }

      - name: ğŸ”§ Build Native Dependencies (if needed)
        if: needs.analyze.outputs.has_native_code == 'true'
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          echo "Building native dependencies..."
          flutter clean
          
          if [ -d "android/app/src/main/cpp" ]; then
            cd android
            ./gradlew externalNativeBuildRelease || true
            cd ..
          fi

      - name: ğŸ—ï¸ Build APK
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          echo "Building APK..."
          echo "Build mode: release"
          echo "Target ABI: ${{ needs.analyze.outputs.build_abi }}"
          
          flutter build apk --release \
            --target-platform=android-arm64,android-arm,android-x64 \
            --split-per-abi=false \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}
          
          BUILD_STATUS=$?
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "âœ… Build successful!"
            find build/app/outputs/flutter-apk -name "*.apk" -exec ls -lh {} \;
          else
            echo "âŒ Build failed!"
            exit 1
          fi

      - name: ğŸ“‹ Analyze APK
        working-directory: project/${{ env.PROJECT_PATH }}
        run: |
          APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ]; then
            echo "APK Path: $APK_PATH"
            echo "APK Size: $(du -h "$APK_PATH" | cut -f1)"
            
            if command -v aapt &> /dev/null; then
              aapt dump badging "$APK_PATH" | head -10
            fi
            
            FINAL_NAME="${{ needs.analyze.outputs.app_name }}.apk"
            cp "$APK_PATH" "$FINAL_NAME"
            echo "FINAL_APK=$FINAL_NAME" >> $GITHUB_ENV
          fi

      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ needs.analyze.outputs.request_id }}
          path: project/${{ env.PROJECT_PATH }}/${{ env.FINAL_APK }}
          retention-days: 7

  # ===========================================================================
  # Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙˆØ§Ù„Ù†Ø´Ø±
  # ===========================================================================
  release:
    name: ğŸš€ Create Release
    needs: [analyze, build]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: ğŸ“¥ Download APK
        uses: actions/download-artifact@v4
        with:
          name: apk-${{ needs.analyze.outputs.request_id }}
          path: release

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.analyze.outputs.request_id }}
          name: "${{ needs.analyze.outputs.app_name }} - Build ${{ github.run_number }}"
          body: |
            ## ğŸš€ Flutter App Build
            
            **App Name:** ${{ needs.analyze.outputs.app_name }}
            **Package:** ${{ needs.analyze.outputs.package_name }}
            **Build ID:** ${{ needs.analyze.outputs.request_id }}
            
            ### ğŸ“Š Build Info
            - Flutter Version: ${{ needs.analyze.outputs.flutter_version }}
            - Min SDK: ${{ needs.analyze.outputs.min_sdk }}
            - Target SDK: ${{ needs.analyze.outputs.target_sdk }}
            - Build ABI: ${{ needs.analyze.outputs.build_abi }}
            
            ### ğŸ”§ Configuration
            - Has Native Code: ${{ needs.analyze.outputs.has_native_code }}
            - Needs NDK: ${{ needs.analyze.outputs.needs_ndk }}
            - Has Plugins: ${{ needs.analyze.outputs.has_plugins }}
            
            ### ğŸ“… Build Date
            ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
          files: release/*.apk
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
  # ===========================================================================
  notify-failure:
    name: âŒ Notify Failure
    needs: [analyze, build, release]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ğŸ“ Log Failure
        run: |
          echo "âŒ Build failed for request: ${{ needs.analyze.outputs.request_id }}"
          echo "App: ${{ needs.analyze.outputs.app_name }}"
          echo "Package: ${{ needs.analyze.outputs.package_name }}"
          
      - name: ğŸ·ï¸ Create Failure Release (for debugging)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.analyze.outputs.request_id }}-failed
          name: "${{ needs.analyze.outputs.app_name }} - Build Failed"
          body: |
            ## âŒ Build Failed
            
            **App Name:** ${{ needs.analyze.outputs.app_name }}
            **Build ID:** ${{ needs.analyze.outputs.request_id }}
            
            Please check the workflow logs for more details.
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
