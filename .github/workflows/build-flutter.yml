name: Smart Flutter Cloud Build (Clean Transplant + Permissions)

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true

env:
  # Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„
  WORKSPACE: ${{ github.workspace }}
  USER_SOURCE: ${{ github.workspace }}/user_source
  CLEAN_PROJECT: ${{ github.workspace }}/clean_build
  
  # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  
  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  AI_BASE_URL: "https://open.bigmodel.cn/api/paas/v4/chat/completions"
  AI_MODEL: "glm-4" 

jobs:
  transplant-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
    
    steps:
      - name: ğŸ› ï¸ Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick sed curl rsync grep

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ“¥ Download User Source
        run: |
          mkdir -p $USER_SOURCE
          echo "Downloading Project from: $ZIP_URL"
          wget -q --show-progress -O project.zip "$ZIP_URL"
          unzip -q project.zip -d temp_extract
          
          # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $USER_SOURCE/
          else
            mv temp_extract/* $USER_SOURCE/
          fi
          rm -rf temp_extract project.zip
          
          echo "âœ… User source extracted to $USER_SOURCE"

      - name: ğŸ—ï¸ Create Fresh Project & Transplant
        run: |
          echo "ğŸš€ Creating a fresh Flutter project..."
          
          # 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø¸Ù…Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          ORG_NAME=$(echo $PACKAGE_NAME | rev | cut -d. -f2- | rev)
          PROJ_NAME=$(echo $PACKAGE_NAME | rev | cut -d. -f1 | rev)
          
          # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙŠØ¯ Ù†Ø¸ÙŠÙ (ÙŠØ¶Ù…Ù† ØªÙˆØ§ÙÙ‚ Gradle Ùˆ Kotlin)
          mkdir -p $CLEAN_PROJECT
          cd ${{ github.workspace }}
          flutter create --org $ORG_NAME --project-name $PROJ_NAME clean_build
          
          echo "â™»ï¸ Transplanting Organs (Code & Assets)..."
          
          # 3. ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          rm -rf $CLEAN_PROJECT/lib/*
          rm -rf $CLEAN_PROJECT/test
          
          # 4. Ù†Ù‚Ù„ Ø§Ù„Ù‚Ù„Ø¨ (Lib)
          cp -r $USER_SOURCE/lib/* $CLEAN_PROJECT/lib/
          
          # 5. Ù†Ù‚Ù„ Ø§Ù„Ø£ØµÙˆÙ„ (Assets)
          if [ -d "$USER_SOURCE/assets" ]; then
            cp -r $USER_SOURCE/assets $CLEAN_PROJECT/
          fi
          
          # 6. Ù†Ù‚Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Firebase (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª)
          if [ -f "$USER_SOURCE/android/app/google-services.json" ]; then
            echo "ğŸ”¥ Found google-services.json, transplanting..."
            cp $USER_SOURCE/android/app/google-services.json $CLEAN_PROJECT/android/app/
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù„Ù€ Firebase ÙÙŠ Gradle
             sed -i '/dependencies {/a \        classpath "com.google.gms:google-services:4.3.15"' $CLEAN_PROJECT/android/build.gradle
             sed -i '/apply plugin: .com.android.application./a apply plugin: "com.google.gms.google-services"' $CLEAN_PROJECT/android/app/build.gradle
          fi

          # 7. Ø¯Ù…Ø¬ Pubspec Ø¨Ø°ÙƒØ§Ø¡
          cp $USER_SOURCE/pubspec.yaml $CLEAN_PROJECT/
          cd $CLEAN_PROJECT
          # Ø¥Ø¬Ø¨Ø§Ø± Ø¥ØµØ¯Ø§Ø± SDK Ø­Ø¯ÙŠØ«
          sed -i 's/sdk: ">=2.0.[0-9].*"/sdk: ">=3.0.0 <4.0.0"/' pubspec.yaml || true
          sed -i 's/sdk: ">=2.12.[0-9].*"/sdk: ">=3.0.0 <4.0.0"/' pubspec.yaml || true
          sed -i 's/sdk: ">=2.7.[0-9].*"/sdk: ">=3.0.0 <4.0.0"/' pubspec.yaml || true
          
          # 8. ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          sed -i 's/android:label="clean_build"/android:label="'"$APP_NAME"'"/' android/app/src/main/AndroidManifest.xml
          
          echo "âœ… Basic Transplant Complete!"

      - name: ğŸ›¡ï¸ Transplant Permissions (The Fixer)
        run: |
          echo "ğŸ•µï¸ Scanning old manifest for permissions..."
          OLD_MANIFEST="$USER_SOURCE/android/app/src/main/AndroidManifest.xml"
          NEW_MANIFEST="$CLEAN_PROJECT/android/app/src/main/AndroidManifest.xml"
          
          if [ -f "$OLD_MANIFEST" ]; then
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø·ÙˆØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª <uses-permission ... />
            grep "<uses-permission" "$OLD_MANIFEST" > permissions.txt || true
            
            if [ -s permissions.txt ]; then
              echo "âœ… Found permissions to transplant:"
              cat permissions.txt
              
              # Ø­Ù‚Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø¨Ù„ ÙˆØ³Ù… <application> ÙÙŠ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
              # Ù†Ø³ØªØ®Ø¯Ù… sed Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ permissions.txt ÙˆØ¥Ø¯Ø®Ø§Ù„Ù‡ Ù‚Ø¨Ù„ <application
              sed -i '/<application/e cat permissions.txt' "$NEW_MANIFEST"
              echo "ğŸ’‰ Permissions injected successfully."
            else
              echo "â„¹ï¸ No permissions found in old manifest."
            fi
          else
            echo "âš ï¸ Old AndroidManifest not found, skipping permissions transplant."
          fi

      - name: ğŸ¨ Process Icon & Signing
        working-directory: ${{ env.CLEAN_PROJECT }}
        run: |
          # Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
          rm -rf android/app/src/main/res/mipmap-*
          wget -q -O icon.png "$ICON_URL"
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          convert icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          
          # ØªÙˆÙ‚ÙŠØ¹ (Debug Key)
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=androiddebugkey" >> android/key.properties
          echo "storeFile=../debug.keystore" >> android/key.properties
          
          cd android
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      - name: ğŸ“¦ Resolve Dependencies
        working-directory: ${{ env.CLEAN_PROJECT }}
        continue-on-error: true
        run: |
          echo "ğŸ”„ Updating dependencies to match new environment..."
          flutter pub upgrade --major-versions
          flutter pub get

      - name: ğŸ”¨ Build APK (First Attempt)
        id: build_1
        working-directory: ${{ env.CLEAN_PROJECT }}
        continue-on-error: true
        run: |
          flutter build apk --release --no-android-gradle-daemon > build_log.txt 2>&1
        
      - name: ğŸ¤– AI Code Doctor (Fix Dart & Pubspec)
        if: steps.build_1.outcome == 'failure'
        working-directory: ${{ env.CLEAN_PROJECT }}
        env:
          OPENAI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_BASE_URL: ${{ env.AI_BASE_URL }}
          AI_MODEL: ${{ env.AI_MODEL }}
        run: |
          echo "âŒ Build Failed. AI Doctor scrubbing in..."
          
          cat > ai_repair.js << 'EOF'
          const fs = require('fs');
          const https = require('https');
          const { URL } = require('url');

          const API_KEY = process.env.OPENAI_API_KEY;
          const BASE_URL = process.env.AI_BASE_URL;
          const MODEL = process.env.AI_MODEL;

          async function callAI(prompt) {
            const endpoint = new URL(BASE_URL);
            const postData = JSON.stringify({
              model: MODEL,
              messages: [
                { role: "system", content: "You are an Expert Flutter Engineer. Your goal is to fix compilation errors by migrating code to Flutter 3.19+ (Null Safety). Return ONLY the fixed code." },
                { role: "user", content: prompt }
              ],
              temperature: 0.1
            });

            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: endpoint.hostname,
                path: endpoint.pathname + endpoint.search,
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` }
              }, (res) => {
                let body = '';
                res.on('data', d => body += d);
                res.on('end', () => {
                  try {
                    const parsed = JSON.parse(body);
                    if(parsed.choices && parsed.choices[0]) resolve(parsed.choices[0].message.content);
                    else reject("AI Error");
                  } catch(e) { reject(e); }
                });
              });
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }

          function extractCode(response) {
            const match = response.match(/```(?:dart|yaml)?\n([\s\S]*?)\n```/);
            return match ? match[1] : response;
          }

          async function main() {
            const log = fs.readFileSync('build_log.txt', 'utf8');
            
            // 1. Check for Pubspec/Version Errors first
            if (log.includes("version solving failed") || log.includes("Because")) {
                 console.log("ğŸ“¦ Fixing dependencies in pubspec.yaml...");
                 const pubspec = fs.readFileSync('pubspec.yaml', 'utf8');
                 const prompt = `Fix these version conflicts for Flutter 3.x. Allow newer versions or use 'any' if strict.\n\nERROR:\n${log.slice(-1500)}\n\nPUBSPEC:\n${pubspec}\n\nOUTPUT: Full valid pubspec.yaml only.`;
                 try {
                    const fixed = extractCode(await callAI(prompt));
                    if (fixed.includes("dependencies:")) {
                        fs.writeFileSync('pubspec.yaml', fixed);
                        console.log("âœ… pubspec.yaml rewrite successful.");
                    }
                 } catch (e) { console.error(e); }
            }

            // 2. Fix Dart Code Errors
            const errorRegex = /lib\/([^:]+):(\d+):(\d+): Error: (.*)/g;
            let match;
            const processedFiles = new Set();
            let count = 0;

            while ((match = errorRegex.exec(log)) !== null && count < 5) {
                const filePath = `lib/${match[1]}`;
                const errorMsg = match[4];

                if (processedFiles.has(filePath)) continue;
                if (!fs.existsSync(filePath)) continue;

                console.log(`ğŸ”§ Fixing ${filePath} -> ${errorMsg.substring(0, 60)}...`);
                
                const content = fs.readFileSync(filePath, 'utf8');
                const prompt = `Migrate this Dart code to Flutter 3.x with Null Safety. Fix this error:\n"${errorMsg}"\n\nCODE:\n${content}\n\nOUTPUT: Full corrected Dart file code ONLY.`;
                
                try {
                    const fixedCode = extractCode(await callAI(prompt));
                    if (fixedCode.length > 50) {
                        fs.writeFileSync(filePath, fixedCode);
                        console.log(`âœ… Fixed ${filePath}`);
                        processedFiles.add(filePath);
                        count++;
                    }
                } catch (e) { console.error(`Failed ${filePath}`, e); }
            }
          }

          main();
          EOF
          
          node ai_repair.js
          flutter pub get

      - name: ğŸ”„ Retry Build
        if: steps.build_1.outcome == 'failure'
        working-directory: ${{ env.CLEAN_PROJECT }}
        run: |
          echo "ğŸ”„ Retrying build..."
          flutter build apk --release --no-android-gradle-daemon

      - name: ğŸ“¤ Prepare & Upload Artifact
        id: prepare_artifact
        run: |
          APK_PATH=$(find $CLEAN_PROJECT/build/app/outputs/flutter-apk -name "*.apk" -not -name "*-unsigned.apk" | head -n 1)
          
          if [ -f "$APK_PATH" ]; then
            echo "âœ… Build Success!"
            mv "$APK_PATH" "$WORKSPACE/${SAFE_NAME}.apk"
            echo "FINAL_APK=$WORKSPACE/${SAFE_NAME}.apk" >> $GITHUB_ENV
          else
            echo "âŒ Build Failed."
            exit 1
          fi

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            âœ… **Ø¨Ù†Ø§Ø¡ Ù†Ø§Ø¬Ø­ (Ù†Ø¸Ø§Ù… Ø§Ù„Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ù†Ø¸ÙŠÙØ©)**
            
            ğŸ“± **Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** ${{ env.APP_NAME }}
            ğŸ“¦ **Ø§Ù„Ø­Ø²Ù…Ø©:** ${{ env.PACKAGE_NAME }}
            ğŸ› ï¸ **Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª:**
            - ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø­Ø¯ÙŠØ« Ù†Ø¸ÙŠÙ.
            - ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø£ØµÙˆÙ„.
            - ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆÙ†Ù‚Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Permissions) Ø¨Ù†Ø¬Ø§Ø­.
            - ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
          files: ${{ env.FINAL_APK }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
