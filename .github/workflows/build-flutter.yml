name: Aite Optimized Flutter Engine

on:
  repository_dispatch:
    types: [build-flutter]

permissions:
  contents: write

jobs:
  build:
    name: Build Minimalist APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ github.event.client_payload.flutter_version }}
          cache: true

      - name: Download & Extract Project
        run: |
          mkdir -p temp_zip
          curl -L "${{ github.event.client_payload.zip_url }}" -o project.zip
          unzip project.zip -d temp_zip
          REAL_ROOT=$(find temp_zip -name "pubspec.yaml" -exec dirname {} + | head -n 1)
          echo "PROJECT_ROOT=$REAL_ROOT" >> $GITHUB_ENV

      - name: Smart Hybrid Repair Engine
        run: |
          cd ${{ env.PROJECT_ROOT }}
          
          # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          PKG="${{ github.event.client_payload.package_name }}"
          APP_NAME="${{ github.event.client_payload.display_name }}"
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"

          # 1. ØªÙ†Ø¸ÙŠÙ Pubspec (Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª)
          sed -i '/flutter_icons:/d; /flutter_launcher_icons:/d; /image_path:/d; /adaptive_icon/d' pubspec.yaml
          echo -e "\ndependency_overrides:\n  path: any\n  cupertino_icons: any\n  flutter_inappwebview: any\n  permission_handler: any\n  shared_preferences_android: any" >> pubspec.yaml

          # 2. ÙØ­Øµ AndroidManifest: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¯ÙŠÙ…Ø§Ù‹ (V1) Ø£Ùˆ Ù…Ø¹Ø·ÙˆØ¨Ø§Ù‹ØŒ Ø£Ø¹Ø¯ Ø¨Ù†Ø§Ø¤Ù‡
          if grep -q "flutterEmbedding" "$MANIFEST_PATH" && grep -q "android:name=\".MainActivity\"" "$MANIFEST_PATH"; then
            echo "âœ… AndroidManifest looks valid. Updating labels only..."
            sed -i "s/android:label=\"[^\"]*\"/android:label=\"$APP_NAME\"/g" "$MANIFEST_PATH"
          else
            echo "âš ï¸ AndroidManifest is old or invalid. Reconstructing..."
            cat <<EOF > "$MANIFEST_PATH"
          <manifest xmlns:android="http://schemas.microsoft.com/apk/res/android" package="$PKG">
              <application android:label="$APP_NAME" android:name="\${applicationName}" android:icon="@mipmap/ic_launcher">
                  <activity android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <meta-data android:name="io.flutter.embedding.android.NormalTheme" android:resource="@style/NormalTheme" />
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  <meta-data android:name="flutterEmbedding" android:value="2" />
              </application>
          </manifest>
          EOF
          fi

          # 3. ÙØ­Øµ Kotlin: ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù†Ø³Ø®Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© (Ù…Ø«Ù„ shared_prefs)
          echo "ğŸš€ Tuning Kotlin & Gradle versions..."
          find android -name "build.gradle" -exec sed -i 's/ext.kotlin_version = .*/ext.kotlin_version = "1.9.10"/g' {} +
          find android -name "build.gradle" -exec sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]*/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.10/g' {} +
          if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
            sed -i 's/gradle-[0-9.]*-all.zip/gradle-8.0-all.zip/g' android/gradle/wrapper/gradle-wrapper.properties
          fi

          # 4. ÙØ­Øµ MainActivity: Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ³ØªØ®Ø¯Ù… V1 ImportØŒ Ù‚Ù… Ø¨ØªØ¨Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡
          MAIN_FILE=$(find android/app/src/main -name "MainActivity.*" | head -n 1)
          if grep -q "io.flutter.app.FlutterActivity" "$MAIN_FILE"; then
            echo "âš ï¸ MainActivity using old embedding. Migrating..."
            sed -i 's/io.flutter.app.FlutterActivity/io.flutter.embedding.android.FlutterActivity/g' "$MAIN_FILE"
          fi

          # 5. Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Package Name
          find android -name "build.gradle" -exec sed -i "s/applicationId \".*\"/applicationId \"$PKG\"/g" {} +
          sudo apt-get update && sudo apt-get install -y imagemagick
          curl -L "${{ github.event.client_payload.icon_url }}" -o icon.png
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          convert icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

      - name: Build Final APK
        run: |
          cd ${{ env.PROJECT_ROOT }}
          rm -f pubspec.lock
          flutter pub get
          flutter build apk --release --target-platform android-arm64 --split-per-abi

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id }}
          files: ${{ env.PROJECT_ROOT }}/build/app/outputs/flutter-apk/*.apk
          body: |
            âœ… Build Finished
            Project: ${{ github.event.client_payload.display_name }}
            Package: ${{ github.event.client_payload.package_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
