name: Ultimate Flutter Reconstruction Build (No-Fail Edition)

on:
  workflow_dispatch:
    inputs:
      app_name: { description: 'App Name', required: true }
      package_name: { description: 'Package Name', required: true }
      zip_url: { description: 'Project ZIP URL', required: true }

jobs:
  build-no-fail:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip imagemagick
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ğŸš€ The Magic: Create Clean Project
        run: |
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ ÙƒÙ„ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ù…Ù„ÙØ§Øª Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø³Ù„ÙŠÙ…Ø© 100%
          flutter create --org "com.clean" --project-name "rebuilt_app" temp_project
          
          # 2. ØªØ­Ù…ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†ÙƒÙˆØ¨
          wget -q -O user_project.zip "${{ github.event.inputs.zip_url }}"
          mkdir user_source
          unzip -q user_project.zip -d user_source
          
          # ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ ZIP)
          USER_SRC=$(find user_source -name "lib" -type d | head -n 1)
          USER_DIR=$(dirname "$USER_SRC")

          # 3. Ù†Ù‚Ù„ "ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" ÙÙ‚Ø· (Ø§Ù„Ø¬ÙˆÙ‡Ø±)
          rm -rf temp_project/lib
          cp -r "$USER_DIR/lib" temp_project/
          [ -d "$USER_DIR/assets" ] && cp -r "$USER_DIR/assets" temp_project/
          cp "$USER_DIR/pubspec.yaml" temp_project/ || echo "Using default pubspec"

          # 4. Ù‡Ù†Ø¯Ø³Ø© ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø© (Package Name) Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
          cd temp_project
          flutter pub add change_app_package_name
          flutter pub get
          flutter pub run change_app_package_name:main ${{ github.event.inputs.package_name }}

      - name: ğŸ›¡ï¸ Neutralize Problematic Files (Firebase/Signing)
        working-directory: temp_project
        run: |
          # Ø­Ø°Ù Ø£ÙŠ Ø¥Ø´Ø§Ø±Ø§Øª Ù„Ù€ Firebase Ù‚Ø¯ ØªØ³Ø¨Ø¨ ÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ù…Ù„ÙØ§Øª
          # Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø¨Ù„Ø¬Ù† google-services Ù…Ù† build.gradle Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¨Ù†Ø§Ø¡
          sed -i '/com.google.gms:google-services/d' android/build.gradle
          sed -i '/apply plugin: .com.google.gms.google-services./d' android/app/build.gradle
          
          # ØªÙˆÙ„ÙŠØ¯ Ù…ÙØªØ§Ø­ ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ‡Ù…ÙŠ Ù„ÙƒÙŠ ÙŠÙƒØªÙ…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
          # Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬ Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙŠÙ„ÙŠØ²
          sed -i 's/signingConfig signingConfigs.release/signingConfig signingConfigs.debug/g' android/app/build.gradle

      - name: ğŸ› ï¸ Final Build
        working-directory: temp_project
        run: |
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª ÙˆØ­Ù„ Ø§Ù„ØµØ±Ø§Ø¹Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          flutter pub get
          flutter build apk --release --no-android-gradle-daemon \
            --split-debug-info=build/app/outputs/symbols \
            --extra-gen-snapshot-options=--no-use-integer-division

      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_name }}
          path: temp_project/build/app/outputs/flutter-apk/app-release.apk
