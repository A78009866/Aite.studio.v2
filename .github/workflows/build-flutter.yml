name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup System Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick xmlstarlet
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: Setup Flutter (Universal)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: üõ†Ô∏è Smart Auto-Fix & Upgrade Tools
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # --- 1. Fix Missing Firebase Options ---
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "‚ö†Ô∏è firebase_options.dart missing. Generating dummy file."
            mkdir -p lib
            cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, TargetPlatform, kIsWeb;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) return android;
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: throw UnsupportedError('iOS not configured');
                default: throw UnsupportedError('Platform not supported');
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'DUMMY_KEY', appId: '1:123:android:123', messagingSenderId: '123', projectId: 'dummy', storageBucket: 'dummy'
            );
          }
          EOF
          fi

          # --- 2. Fix Missing Google Services JSON ---
          if [ ! -f "android/app/google-services.json" ]; then
            echo "‚ö†Ô∏è google-services.json missing. Generating dummy file."
            cat <<EOF > android/app/google-services.json
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:123456789012:android:321abc456def7890",
                "android_client_info": { "package_name": "${PACKAGE_NAME}" }
              },
              "oauth_client": [],
              "api_key": [{ "current_key": "AIzaSyDummyKey" }],
              "services": {
                "analytics_service": { "status": 1 },
                "appinvite_service": { "status": 1, "other_platform_oauth_client": [] },
                "ads_service": { "status": 2 }
              }
            }],
            "configuration_version": "1"
          }
          EOF
          fi

          # --- 3. Upgrade Gradle & Kotlin ---
          echo "üîÑ Upgrading Gradle Wrapper..."
          if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
             sed -i 's/gradle-.*-all.zip/gradle-8.9-all.zip/' android/gradle/wrapper/gradle-wrapper.properties || true
          fi
          
          sed -i 's/com.android.tools.build:gradle:[3-7].*/com.android.tools.build:gradle:8.2.1"/' android/build.gradle || true
          sed -i 's/ext.kotlin_version\s*=\s*.*/ext.kotlin_version = "1.9.20"/' android/build.gradle || true

      - name: üîß Fix App Name & Package (Robust Method)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "üîß Configuring App: $APP_NAME | Package: $PACKAGE_NAME"
          
          # Update strings.xml (ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä)
          strings_path='android/app/src/main/res/values/strings.xml'
          mkdir -p "$(dirname "$strings_path")"
          cat > "$strings_path" <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${APP_NAME}</string>
          </resources>
          EOF

          # ÿ™ÿ≠ÿØŸäÿ´ AndroidManifest.xml ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ xmlstarlet (ÿ£ŸÉÿ´ÿ± ŸÖŸàÿ´ŸàŸÇŸäÿ©)
          manifest_path='android/app/src/main/AndroidManifest.xml'
          if [ -f "$manifest_path" ]; then
            # ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ label ŸÅŸä application tag
            xmlstarlet ed --inplace -u "//application/@android:label" -v "@string/app_name" "$manifest_path" 2>/dev/null || \
            sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/g' "$manifest_path"
            
            # ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ namespace ŸÑŸÑŸÄ android
            if ! grep -q "xmlns:android" "$manifest_path"; then
              sed -i 's/<manifest /<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android" /' "$manifest_path"
            fi
          fi

          # ÿ™ÿ≠ÿØŸäÿ´ build.gradle (Package & SDK)
          gradle_path='android/app/build.gradle'
          if [ -f "$gradle_path" ]; then
            # ÿ™ÿ≠ÿØŸäÿ´ applicationId
            sed -i "s/applicationId \".*\"/applicationId \"${PACKAGE_NAME}\"/g" "$gradle_path"
            # ÿ™ÿ≠ÿØŸäÿ´ namespace (ŸÑŸÑÿ£ŸÜÿØÿ±ŸàŸäÿØ ÿ¨ÿ±ÿßÿØŸÑ ÿßŸÑÿ¨ÿØŸäÿØ)
            sed -i "s/namespace \".*\"/namespace \"${PACKAGE_NAME}\"/g" "$gradle_path"
            # ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ minSdk 21 ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ (ŸÑŸÑÿ™ŸàÿßŸÅŸÇ)
            sed -i 's/minSdkVersion.*/minSdkVersion 21/g' "$gradle_path"
            sed -i 's/minSdk\s*=.*/minSdk = 21/g' "$gradle_path"
          fi

          # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
          echo "‚úÖ strings.xml content:"
          cat "$strings_path"
          echo "‚úÖ Manifest application label:"
          grep -o 'android:label="[^"]*"' "$manifest_path" || echo "Not found"

      - name: Setup Signing Key (Debug for Universal Compatibility)
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          # ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÅÿ™ÿßÿ≠ ÿ™ŸàŸÇŸäÿπ ŸÖŸàÿ≠ÿØ
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US" || true
          
          # ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ signing.gradle ŸÅŸä ÿßŸÑŸÖŸÉÿßŸÜ ÿßŸÑÿµÿ≠Ÿäÿ≠
          mkdir -p signing
          cat > signing.gradle << 'EOF'
          android {
              signingConfigs {
                  release {
                      storeFile file("debug.keystore")
                      storePassword "android"
                      keyAlias "androiddebugkey"
                      keyPassword "android"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      shrinkResources false
                      proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                  }
                  debug {
                      signingConfig signingConfigs.debug
                  }
              }
          }
          EOF
          
          # ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÑŸÅ ÿßŸÑÿ™ŸàŸÇŸäÿπ ŸÅŸä build.gradle ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑÿ™ÿ∑ÿ®ŸäŸÇ
          app_gradle="../../android/app/build.gradle"
          if ! grep -q "signing.gradle" "$app_gradle"; then
            echo "apply from: 'signing/signing.gradle'" >> "$app_gradle"
          fi

      - name: Process Icon
        run: |
          rm -rf $PROJECT_DIR/android/app/src/main/res/mipmap-*
          declare -a sizes=("48x48:mdpi" "72x72:hdpi" "96x96:xhdpi" "144x144:xxhdpi" "192x192:xxxhdpi")
          wget -q -O icon.png "$ICON_URL"
          
          for size in "${sizes[@]}"; do
             IFS=":" read -r px name <<< "$size"
             mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-$name
             convert icon.png -resize $px $PROJECT_DIR/android/app/src/main/res/mipmap-$name/ic_launcher.png
          done

      - name: Get Dependencies & Clean
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter clean
          flutter pub get

      - name: Build APK (Universal - All Architectures)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # ÿ®ŸÜÿßÿ° ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿπŸÖÿßÿ±Ÿäÿßÿ™ (ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑŸáŸàÿßÿ™ŸÅ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸàÿßŸÑŸÖÿ≠ÿßŸÉŸäÿßÿ™)
          flutter build apk --$BUILD_MODE \
            --target-platform=android-arm,android-arm64,android-x64 \
            --no-android-gradle-daemon
          
          APK_DIR="build/app/outputs/flutter-apk"
          GENERATED_APK=$(find $APK_DIR -name "*.apk" -not -name "*-unsigned.apk" | head -n 1)
          
          if [ -f "$GENERATED_APK" ]; then
            FINAL_APK="$APK_DIR/${SAFE_NAME}.apk"
            cp "$GENERATED_APK" "$FINAL_APK"
            echo "‚úÖ Build Successful: $FINAL_APK"
            ls -lh "$FINAL_APK"
            echo "APK_PATH=$PWD/$FINAL_APK" >> $GITHUB_ENV
          else
            echo "‚ùå Build Failed: APK not found"
            exit 1
          fi

      - name: Verify APK
        run: |
          echo "üì± APK Info:"
          aapt dump badging ${{ env.APK_PATH }} | grep -E "package|application-label" || true

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }} v${{ github.run_number }}"
          body: |
            ‚úÖ **ÿ™ŸÖ ÿßŸÑÿ®ŸÜÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠**
            üì± **ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:** ${{ env.APP_NAME }}
            üì¶ **ÿßŸÑÿ≠ÿ≤ŸÖÿ©:** ${{ env.PACKAGE_NAME }}
            üèóÔ∏è **ÿßŸÑŸÜŸàÿπ:** ${{ env.BUILD_MODE }}
          files: |
            ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
