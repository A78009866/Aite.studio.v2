name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup System Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick xmlstarlet
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: Setup Flutter (Universal)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ› ï¸ Fix Project Structure & Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # --- 1. Fix Missing Firebase Options ---
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "âš ï¸ firebase_options.dart missing. Generating dummy file."
            mkdir -p lib
            cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, TargetPlatform, kIsWeb;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) return android;
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: throw UnsupportedError('iOS not configured');
                default: throw UnsupportedError('Platform not supported');
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'DUMMY_KEY', appId: '1:123:android:123', messagingSenderId: '123', projectId: 'dummy', storageBucket: 'dummy'
            );
          }
          EOF
          fi

          # --- 2. Fix Missing Google Services JSON ---
          if [ ! -f "android/app/google-services.json" ]; then
            echo "âš ï¸ google-services.json missing. Generating dummy file."
            mkdir -p android/app
            cat <<EOF > android/app/google-services.json
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:123456789012:android:321abc456def7890",
                "android_client_info": { "package_name": "${PACKAGE_NAME}" }
              },
              "oauth_client": [],
              "api_key": [{ "current_key": "AIzaSyDummyKey" }],
              "services": {
                "analytics_service": { "status": 1 },
                "appinvite_service": { "status": 1, "other_platform_oauth_client": [] },
                "ads_service": { "status": 2 }
              }
            }],
            "configuration_version": "1"
          }
          EOF
          fi

      - name: ğŸ”§ Upgrade Gradle & Kotlin (Modern Approach)
        working-directory: ${{ env.PROJECT_DIR }}/android
        run: |
          echo "ğŸ”„ Upgrading Gradle wrapper..."
          if [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
             sed -i 's/gradle-.*-all.zip/gradle-8.9-all.zip/' gradle/wrapper/gradle-wrapper.properties
             cat gradle/wrapper/gradle-wrapper.properties
          fi
          
          # --- ØªØ­Ø¯ÙŠØ« settings.gradle (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ§Øª) ---
          if [ -f "settings.gradle" ] || [ -f "settings.gradle.kts" ]; then
            SETTINGS_FILE=$(ls settings.gradle* | head -n 1)
            echo "Updating $SETTINGS_FILE..."
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ³ØªØ®Ø¯Ù… plugins DSL (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            if grep -q "pluginManagement" "$SETTINGS_FILE" 2>/dev/null || grep -q "plugins {" "$SETTINGS_FILE" 2>/dev/null; then
              # ØªØ­Ø¯ÙŠØ« Ø¥ØµØ¯Ø§Ø± Kotlin ÙÙŠ plugins block
              sed -i 's/id "org.jetbrains.kotlin.android" version ".*"/id "org.jetbrains.kotlin.android" version "1.9.20"/' "$SETTINGS_FILE" || true
              sed -i "s/id 'org.jetbrains.kotlin.android' version '.*'/id 'org.jetbrains.kotlin.android' version '1.9.20'/" "$SETTINGS_FILE" || true
              sed -i 's/kotlin("android") version ".*"/kotlin("android") version "1.9.20"/' "$SETTINGS_FILE" || true
            fi
          fi
          
          # --- ØªØ­Ø¯ÙŠØ« build.gradle Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØ³ØªØ®Ø¯Ù… settings.gradle) ---
          if [ -f "build.gradle" ]; then
            sed -i 's/ext.kotlin_version\s*=\s*.*/ext.kotlin_version = "1.9.20"/' build.gradle || true
            sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.2.1/' build.gradle || true
          fi

      - name: ğŸ”§ Fix App Name & Package
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ”§ Configuring App: $APP_NAME | Package: $PACKAGE_NAME"
          
          # Update strings.xml
          strings_path='android/app/src/main/res/values/strings.xml'
          mkdir -p "$(dirname "$strings_path")"
          cat > "$strings_path" <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${APP_NAME}</string>
          </resources>
          EOF

          # Update AndroidManifest.xml
          manifest_path='android/app/src/main/AndroidManifest.xml'
          if [ -f "$manifest_path" ]; then
            xmlstarlet ed --inplace -u "//application/@android:label" -v "@string/app_name" "$manifest_path" 2>/dev/null || \
            sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/g' "$manifest_path"
          fi

          # Update build.gradle (App Level)
          gradle_path='android/app/build.gradle'
          if [ -f "$gradle_path" ]; then
            # ØªØ­Ø¯ÙŠØ« applicationId
            sed -i "s/applicationId \".*\"/applicationId \"${PACKAGE_NAME}\"/g" "$gradle_path"
            sed -i "s/applicationId '.*'/applicationId '${PACKAGE_NAME}'/g" "$gradle_path"
            
            # ØªØ­Ø¯ÙŠØ« namespace
            sed -i "s/namespace \".*\"/namespace \"${PACKAGE_NAME}\"/g" "$gradle_path"
            sed -i "s/namespace '.*'/namespace '${PACKAGE_NAME}'/g" "$gradle_path"
            
            # minSdk
            sed -i 's/minSdkVersion.*/minSdkVersion 21/g' "$gradle_path"
            sed -i 's/minSdk\s*=.*/minSdk = 21/g' "$gradle_path"
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ build.gradle Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ (Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø±)
            if ! grep -q "signingConfigs" "$gradle_path"; then
              # Ù†Ø¨Ø­Ø« Ø¹Ù† buildTypes ÙˆÙ†Ø¶ÙŠÙ signingConfigs Ù‚Ø¨Ù„Ù‡
              sed -i '/buildTypes {/i\
          \
          signingConfigs {\
              release {\
                  storeFile file("../debug.keystore")\
                  storePassword "android"\
                  keyAlias "androiddebugkey"\
                  keyPassword "android"\
              }\
          }' "$gradle_path"
              
              # ØªØ­Ø¯ÙŠØ« buildTypes.release Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
              sed -i 's/buildTypes {/buildTypes {/g' "$gradle_path"
              sed -i '/signingConfig signingConfigs.debug/a\                signingConfig signingConfigs.release' "$gradle_path" || true
            fi
            
            cat "$gradle_path" | head -50
          fi

      - name: Setup Signing Key
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ keystore
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US" || true
          ls -la debug.keystore

      - name: Process Icon
        run: |
          rm -rf $PROJECT_DIR/android/app/src/main/res/mipmap-*
          declare -a sizes=("48x48:mdpi" "72x72:hdpi" "96x96:xhdpi" "144x144:xxhdpi" "192x192:xxxhdpi")
          wget -q -O icon.png "$ICON_URL"
          
          for size in "${sizes[@]}"; do
             IFS=":" read -r px name <<< "$size"
             mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-$name
             convert icon.png -resize $px $PROJECT_DIR/android/app/src/main/res/mipmap-$name/ic_launcher.png
          done

      - name: Get Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter clean
          flutter pub get

      - name: Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter build apk --$BUILD_MODE \
            --target-platform=android-arm,android-arm64,android-x64 \
            --no-android-gradle-daemon
          
          APK_DIR="build/app/outputs/flutter-apk"
          GENERATED_APK=$(find $APK_DIR -name "*.apk" -not -name "*-unsigned.apk" | head -n 1)
          
          if [ -f "$GENERATED_APK" ]; then
            FINAL_APK="$APK_DIR/${SAFE_NAME}.apk"
            cp "$GENERATED_APK" "$FINAL_APK"
            echo "âœ… Build Successful: $FINAL_APK"
            ls -lh "$FINAL_APK"
            echo "APK_PATH=$PWD/$FINAL_APK" >> $GITHUB_ENV
          else
            echo "âŒ Build Failed: APK not found"
            exit 1
          fi

      - name: Verify APK
        run: |
          echo "ğŸ“± APK Info:"
          aapt dump badging ${{ env.APK_PATH }} 2>/dev/null | grep -E "package|application-label|version" || echo "aapt not available"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }} v${{ github.run_number }}"
          body: |
            âœ… **ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­**
            ğŸ“± **Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** ${{ env.APP_NAME }}
            ğŸ“¦ **Ø§Ù„Ø­Ø²Ù…Ø©:** ${{ env.PACKAGE_NAME }}
          files: |
            ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
