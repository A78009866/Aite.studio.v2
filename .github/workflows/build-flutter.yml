name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup System Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ”§ Fix Firebase & Google Services
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Firebase Options
          if [ ! -f "lib/firebase_options.dart" ]; then
            mkdir -p lib
            cat > lib/firebase_options.dart << 'EOF'
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, TargetPlatform, kIsWeb;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) return android;
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                default: throw UnsupportedError('Platform not supported');
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'DUMMY_KEY', appId: '1:123:android:123', messagingSenderId: '123', projectId: 'dummy', storageBucket: 'dummy'
            );
          }
          EOF
          fi

          # Google Services JSON
          if [ ! -f "android/app/google-services.json" ]; then
            mkdir -p android/app
            cat > android/app/google-services.json << EOF
          {
            "project_info": {
              "project_number": "123456789",
              "project_id": "dummy",
              "storage_bucket": "dummy"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:123:android:abc",
                "android_client_info": { "package_name": "${PACKAGE_NAME}" }
              },
              "api_key": [{ "current_key": "dummy" }],
              "services": { "appinvite_service": { "status": 1 } }
            }]
          }
          EOF
          fi

      - name: ğŸ”§ Fix App Name & Package
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # strings.xml
          mkdir -p android/app/src/main/res/values
          cat > android/app/src/main/res/values/strings.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${APP_NAME}</string>
          </resources>
          EOF

          # AndroidManifest.xml label fix
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/g' "$MANIFEST"
            # Ø¥Ø¶Ø§ÙØ© namespace Ø¥Ø°Ø§ Ù…ÙÙ‚ÙˆØ¯
            if ! grep -q "xmlns:android" "$MANIFEST"; then
              sed -i 's/<manifest /<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android" /' "$MANIFEST"
            fi
          fi

      - name: ğŸ”§ Fix Kotlin Version & Gradle
        working-directory: ${{ env.PROJECT_DIR }}/android
        run: |
          # ØªØ­Ø¯ÙŠØ« Gradle wrapper
          sed -i 's/gradle-[0-9.]*-/gradle-8.9-/' gradle/wrapper/gradle-wrapper.properties 2>/dev/null || true
          
          # ØªØ­Ø¯ÙŠØ« Kotlin ÙÙŠ settings.gradle
          if [ -f "settings.gradle" ]; then
            sed -i "s/id 'org.jetbrains.kotlin.android' version '[^']*'/id 'org.jetbrains.kotlin.android' version '1.9.20'/g" settings.gradle
            sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.20"/g' settings.gradle
          fi
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† old-style project (build.gradle ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ext.kotlin_version)
          if [ -f "build.gradle" ]; then
            sed -i 's/ext.kotlin_version = .*/ext.kotlin_version = "1.9.20"/' build.gradle
            sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.2.1/' build.gradle
          fi

      - name: ğŸ”§ Create Signing Config (Inline - No External File)
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Keystore
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          ls -la debug.keystore
          
          # Ø¥Ù†Ø´Ø§Ø¡ signing.gradle Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† build.gradle ÙŠØ·Ù„Ø¨Ù‡
          # Ø£Ùˆ Ø¥Ø²Ø§Ù„Ø© Ø³Ø·Ø± apply from Ù…Ù† build.gradle ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
          
          BUILD_GRADLE="build.gradle"
          
          # 1. Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø³Ø·Ø± apply from: signing (Ù„Ø£Ù†Ù‡ ÙŠØ³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£)
          sed -i "/apply from:.*signing/d" "$BUILD_GRADLE"
          sed -i "/apply from:.*signing.gradle/d" "$BUILD_GRADLE"
          
          # 2. Ø¥Ø¶Ø§ÙØ© signingConfigs Ùˆ buildTypes Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙˆÙ†Ø§ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
          if ! grep -q "signingConfigs" "$BUILD_GRADLE"; then
            # Ù†Ø¶ÙŠÙÙ‡Ø§ Ù‚Ø¨Ù„ buildTypes {
            sed -i '/buildTypes {/i\
          \
          signingConfigs {\
              release {\
                  storeFile file("../debug.keystore")\
                  storePassword "android"\
                  keyAlias "androiddebugkey"\
                  keyPassword "android"\
              }\
          }' "$BUILD_GRADLE"
          fi
          
          # 3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† release build ÙŠØ³ØªØ®Ø¯Ù… signingConfigs.release
          if ! grep -q "signingConfig signingConfigs.release" "$BUILD_GRADLE"; then
            # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ signingConfig signingConfigs.debug Ø¨Ù€ release ÙÙŠ buildTypes release
            sed -i '/buildTypes {/,/}/ { /release {/,/}/ { s/signingConfig signingConfigs.debug/signingConfig signingConfigs.release/ } }' "$BUILD_GRADLE"
          fi
          
          # 4. ØªØ¹Ø·ÙŠÙ„ minify Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
          sed -i 's/minifyEnabled true/minifyEnabled false/g' "$BUILD_GRADLE"
          sed -i 's/shrinkResources true/shrinkResources false/g' "$BUILD_GRADLE"
          
          # 5. ØªØ­Ø¯ÙŠØ« package name
          sed -i "s/applicationId \".*\"/applicationId \"${PACKAGE_NAME}\"/g" "$BUILD_GRADLE"
          sed -i "s/applicationId '.*'/applicationId '${PACKAGE_NAME}'/g" "$BUILD_GRADLE"
          sed -i "s/namespace \".*\"/namespace \"${PACKAGE_NAME}\"/g" "$BUILD_GRADLE"
          sed -i "s/namespace '.*'/namespace '${PACKAGE_NAME}'/g" "$BUILD_GRADLE"
          
          echo "âœ… Final build.gradle (first 80 lines):"
          head -80 "$BUILD_GRADLE"

      - name: Process Icon
        run: |
          rm -rf $PROJECT_DIR/android/app/src/main/res/mipmap-*
          declare -a sizes=("48x48:mdpi" "72x72:hdpi" "96x96:xhdpi" "144x144:xxhdpi" "192x192:xxxhdpi")
          wget -q -O icon.png "$ICON_URL"
          
          for size in "${sizes[@]}"; do
             IFS=":" read -r px name <<< "$size"
             mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-$name
             convert icon.png -resize $px $PROJECT_DIR/android/app/src/main/res/mipmap-$name/ic_launcher.png
          done

      - name: Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter clean
          flutter pub get
          
          # Ø¨Ù†Ø§Ø¡ Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ ØªØ­Ø°ÙŠØ± Kotlin Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„Ù…Ø´ÙƒÙ„
          flutter build apk --$BUILD_MODE \
            --target-platform=android-arm,android-arm64,android-x64 \
            --no-android-gradle-daemon || \
          flutter build apk --$BUILD_MODE \
            --target-platform=android-arm,android-arm64,android-x64 \
            --no-android-gradle-daemon \
            --android-skip-build-dependency-validation
          
          APK_DIR="build/app/outputs/flutter-apk"
          GENERATED_APK=$(find $APK_DIR -name "*.apk" -not -name "*-unsigned.apk" | head -n 1)
          
          if [ -f "$GENERATED_APK" ]; then
            FINAL_APK="$APK_DIR/${SAFE_NAME}.apk"
            cp "$GENERATED_APK" "$FINAL_APK"
            echo "âœ… Build Successful!"
            echo "APK_PATH=$PWD/$FINAL_APK" >> $GITHUB_ENV
          else
            echo "âŒ Build Failed: APK not found in $APK_DIR"
            ls -la $APK_DIR/ || echo "Directory not found"
            exit 1
          fi

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            âœ… **ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­**
            ğŸ“± **Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** ${{ env.APP_NAME }}
            ğŸ“¦ **Ø§Ù„Ø­Ø²Ù…Ø©:** ${{ env.PACKAGE_NAME }}
          files: |
            ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
