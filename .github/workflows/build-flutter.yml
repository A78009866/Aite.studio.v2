name: Smart Flutter Cloud Build (Universal v3)

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url }}

jobs:
  universal-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: 1. Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick openjdk-17-jdk

      - name: 2. Download and Extract
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: 3. Analyze Project Structure
        working-directory: ${{ env.PROJECT_DIR }}
        id: analyzer
        run: |
          cat <<EOF > detect_version.py
          import re
          import os

          is_legacy = False
          flutter_ver = ""

          if os.path.exists("pubspec.yaml"):
              with open("pubspec.yaml", "r") as f:
                  content = f.read()
                  match = re.search(r'sdk:\s*["\']?([><=^0-9\.\s-]+)["\']?', content)
                  if match:
                      ver_str = match.group(1)
                      print(f"SDK Constraint: {ver_str}")
                      if "2.12" not in ver_str and "3." not in ver_str and ("<3.0.0" in ver_str or "2." in ver_str):
                          is_legacy = True
                          flutter_ver = "3.7.12"
                      
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"IS_LEGACY={str(is_legacy).lower()}\n")
              f.write(f"FLUTTER_VER={flutter_ver}\n")
              
          print(f"Legacy: {is_legacy}, Flutter: {flutter_ver or 'Latest'}")
          EOF
          python3 detect_version.py

      - name: 4. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VER }}
          cache: true

      - name: 5. Auto-Fix Gradle & Dependencies (Universal)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ™ŸàŸÇŸäÿπ
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US" 2>/dev/null || true
          
          mkdir -p android/gradle/wrapper
          WRAPPER="android/gradle/wrapper/gradle-wrapper.properties"
          BUILD_GRADLE="android/build.gradle"
          SETTINGS_GRADLE="android/settings.gradle"
          APP_BUILD_GRADLE="android/app/build.gradle"

          if [ "${{ env.IS_LEGACY }}" == "true" ]; then
            echo "üîß Mode: LEGACY"
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip" > $WRAPPER
            
            if [ -f "$BUILD_GRADLE" ]; then
               sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:7.3.0/g' $BUILD_GRADLE
               sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.10/g' $BUILD_GRADLE
            fi
            
            # ÿØÿπŸÖ settings.gradle ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≠ÿØŸäÿ´ÿ© ŸÜÿ≥ÿ®ŸäÿßŸã ÿßŸÑÿ™Ÿä ÿ™ÿ≥ÿ™ÿÆÿØŸÖ legacy SDK
            if [ -f "$SETTINGS_GRADLE" ]; then
               sed -i 's/com.android.application:[0-9.]\+/com.android.application:7.3.0/g' $SETTINGS_GRADLE
               sed -i 's/org.jetbrains.kotlin.android:[0-9.]\+/org.jetbrains.kotlin.android:1.7.10/g' $SETTINGS_GRADLE
            fi
            
            echo "BUILD_ARGS=--release --no-shrink --no-sound-null-safety" >> $GITHUB_ENV

          else
            echo "‚ú® Mode: MODERN (AGP 8.x Universal)"
            
            # ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ•ÿµÿØÿßÿ± AGP ŸÑÿ™ÿ≠ÿØŸäÿØ ÿ£ŸÇŸÑ ÿ•ÿµÿØÿßÿ± Gradle ŸÖÿ∑ŸÑŸàÿ®
            AGP_VERSION=""
            
            if [ -f "$BUILD_GRADLE" ]; then
                # ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑŸÇÿØŸäŸÖÿ© (classpath)
                AGP_RAW=$(grep -oP 'com.android.tools.build:gradle:\K[0-9.]+' $BUILD_GRADLE || true)
                if [ ! -z "$AGP_RAW" ]; then
                    AGP_VERSION=$AGP_RAW
                    # ÿ™ÿ±ŸÇŸäÿ© ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ•ŸÑŸâ 8.1 ŸÑŸÑÿßÿ≥ÿ™ŸÇÿ±ÿßÿ±
                    sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.1.0/g' $BUILD_GRADLE
                    sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.10/g' $BUILD_GRADLE
                fi
            fi
            
            # ÿØÿπŸÖ ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© (plugins block) ŸÅŸä settings.gradle (Flutter 3.16+)
            if [ -f "$SETTINGS_GRADLE" ]; then
                # ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ•ÿµÿØÿßÿ± ÿ•ÿ∞ÿß ŸÑŸÖ ŸÜÿ¨ÿØ ŸÅŸä build.gradle
                if [ -z "$AGP_VERSION" ]; then
                    AGP_PLUGIN=$(grep -oP 'com.android.application["'\'']?\s*version\s*["'\'']?\K[0-9.]+' $SETTINGS_GRADLE || true)
                    [ ! -z "$AGP_PLUGIN" ] && AGP_VERSION=$AGP_PLUGIN
                fi
                
                # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿµÿØÿßÿ±ÿßÿ™ ŸÅŸä settings.gradle ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ¨ÿØÿßŸã
                sed -i 's/id\s*["'\'']com.android.application["'\'']\s*version\s*["'\''][^"'\'']*["'\'']/id "com.android.application" version "8.1.0"/g' $SETTINGS_GRADLE
                sed -i "s/id\s*[\"']com.android.application[\"']\s*version\s*[\"'][^\"']*[\"']/id 'com.android.application' version '8.1.0'/g" $SETTINGS_GRADLE
                sed -i 's/id\s*["'\'']org.jetbrains.kotlin.android["'\'']\s*version\s*["'\''][^"'\'']*["'\'']/id "org.jetbrains.kotlin.android" version "1.9.10"/g' $SETTINGS_GRADLE
            fi
            
            echo "üìã Detected AGP: ${AGP_VERSION:-'8.1 (default)'}"
            
            # ŸÖŸÜÿ∑ŸÇ ÿßÿÆÿ™Ÿäÿßÿ± Gradle ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ AGP (ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ AGP 8.0 ÿ≠ÿ™Ÿâ 8.7+)
            # AGP 8.7+ Ÿäÿ™ÿ∑ŸÑÿ® Gradle 8.9+
            # Gradle 8.10.2 Ÿäÿ∫ÿ∑Ÿä ŸÉŸÑ ÿ•ÿµÿØÿßÿ±ÿßÿ™ AGP 8.x ÿ≠ÿßŸÑŸäÿßŸã
            GRADLE_VER="8.10.2"
            
            if [ ! -z "$AGP_VERSION" ]; then
                AGP_MINOR=$(echo $AGP_VERSION | cut -d. -f2)
                if [ "$AGP_MINOR" -ge 7 ]; then
                    echo "üîç AGP 8.7+ detected, ensuring Gradle 8.9+"
                    GRADLE_VER="8.10.2"
                fi
            fi
            
            echo "‚öôÔ∏è Using Gradle $GRADLE_VER"
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-${GRADLE_VER}-all.zip" > $WRAPPER
            
            # ÿ•ÿ∂ÿßŸÅÿ© namespace ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ™ŸÇÿ± ÿ•ŸÑŸäŸá (ŸÖÿ∑ŸÑŸàÿ® ŸÑŸÄ AGP 8+)
            if [ -f "$APP_BUILD_GRADLE" ]; then
               if ! grep -q "namespace" $APP_BUILD_GRADLE; then
                 # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Package Name ŸÖŸÜ ÿßŸÑÿ®Ÿäÿ¶ÿ© - ÿßÿ≥ÿ™ÿÆÿØŸÖ "Âêå‰∫ãŸÑÿßÿ≠ÿ∏ ÿ™ÿµÿ≠Ÿäÿ≠ ÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿßŸÇÿ™ÿ®ÿßÿ≥ ŸáŸÜÿß
                 sed -i "/android {/a \    namespace '${{ env.PACKAGE_NAME }}'" $APP_BUILD_GRADLE
               fi
            fi
            
            echo "BUILD_ARGS=--release --no-shrink" >> $GITHUB_ENV
          fi

          # ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ≥ÿ®ÿ® ÿ™ÿπÿßÿ±ÿ∂ÿßÿ™
          sed -i '/flutterVersionName/d' android/local.properties 2>/dev/null || true
          sed -i '/flutterVersionCode/d' android/local.properties 2>/dev/null || true

      - name: 6. Refactor Package Name & Icon
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cat <<EOF > refactor.py
          import os, re
          pkg = "${{ env.PACKAGE_NAME }}"
          name = "${{ env.APP_NAME }}"
          path = pkg.replace('.', '/')
          
          m = "android/app/src/main/AndroidManifest.xml"
          if os.path.exists(m):
              with open(m, 'r') as f: s = f.read()
              s = re.sub(r'package="[^"]+"', f'package="{pkg}"', s)
              s = re.sub(r'android:label="[^"]+"', 'android:label="@string/app_name"', s)
              with open(m, 'w') as f: f.write(s)
          
          s_path = "android/app/src/main/res/values/strings.xml"
          os.makedirs(os.path.dirname(s_path), exist_ok=True)
          with open(s_path, 'w') as f: f.write(f'<resources><string name="app_name">{name}</string></resources>')
          
          g = "android/app/build.gradle"
          if os.path.exists(g):
              with open(g, 'r') as f: s = f.read()
              s = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{pkg}"', s)
              with open(g, 'w') as f: f.write(s)
              
          for root, dirs, files in os.walk("android/app/src/main"):
              if "MainActivity.java" in files or "MainActivity.kt" in files:
                  f_name = "MainActivity.kt" if "MainActivity.kt" in files else "MainActivity.java"
                  old = os.path.join(root, f_name)
                  new_dir = os.path.join("android/app/src/main", "java" if "java" in root else "kotlin", path)
                  os.makedirs(new_dir, exist_ok=True)
                  with open(old, 'r') as f: c = f.read()
                  c = re.sub(r'package\s+[\w\.]+', f'package {pkg}', c)
                  with open(os.path.join(new_dir, f_name), 'w') as f: f.write(c)
                  if old != os.path.join(new_dir, f_name):
                      os.remove(old)
                  break
          EOF
          python3 refactor.py

          wget -q -O icon.png "$ICON_URL"
          rm -rf android/app/src/main/res/mipmap-*
          for s in "mdpi 48" "hdpi 72" "xhdpi 96" "xxhdpi 144" "xxxhdpi 192"; do
             read -r n d <<< "$s"
             mkdir -p android/app/src/main/res/mipmap-$n
             convert icon.png -resize ${d}x${d} android/app/src/main/res/mipmap-$n/ic_launcher.png
          done

      - name: 7. Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter pub get
          echo "üöÄ Building with: ${{ env.BUILD_ARGS }}"
          flutter build apk ${{ env.BUILD_ARGS }}

          APK=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          mv "$APK" "${{ env.SAFE_NAME }}.apk"
          echo "APK_PATH=$(pwd)/${{ env.SAFE_NAME }}.apk" >> $GITHUB_ENV

      - name: 8. Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
             Build ID: ${{ env.BUILD_ID }}
             Mode: ${{ env.IS_LEGACY == 'true' && 'Legacy üèöÔ∏è' || 'Modern ‚ú®' }}
          files: ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
