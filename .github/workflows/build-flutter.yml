name: Aite Optimized Flutter Engine

on:
  repository_dispatch:
    types: [build-flutter]

permissions:
  contents: write

jobs:
  build:
    name: Build Minimalist APK
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2️⃣ Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3️⃣ Flutter (نسخة مستقرة عالية التوافق)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.3'
          channel: stable
          cache: true

      - name: Flutter Info
        run: |
          flutter --version
          flutter doctor -v

      # 4️⃣ تحميل المشروع وفك الضغط
      - name: Download & Extract Project
        run: |
          mkdir -p temp_zip
          curl -L "${{ github.event.client_payload.zip_url }}" -o project.zip
          unzip -q project.zip -d temp_zip

          PROJECT_ROOT=$(find temp_zip -name "pubspec.yaml" -exec dirname {} \; | head -n 1)
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      # 5️⃣ فحص Dart SDK (تشخيص فقط)
      - name: Detect Dart SDK
        run: |
          cd ${{ env.PROJECT_ROOT }}
          echo "Detected SDK constraint:"
          grep "sdk:" pubspec.yaml || true

      # 6️⃣ Android Patch آمن (إن وُجد)
      - name: Android Safe Patch
        run: |
          cd ${{ env.PROJECT_ROOT }}

          if [ -f "android/app/build.gradle" ]; then
            echo "Patching Android SDK versions (safe mode)"

            sed -i 's/compileSdkVersion.*/compileSdkVersion 33/' android/app/build.gradle || true
            sed -i 's/targetSdkVersion.*/targetSdkVersion 33/' android/app/build.gradle || true
          fi

          if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
            sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-7.6-all.zip|g' \
              android/gradle/wrapper/gradle-wrapper.properties
          fi

      # 7️⃣ Build APK (نظيف)
      - name: Build APK
        run: |
          cd ${{ env.PROJECT_ROOT }}
          flutter clean
          flutter pub get
          flutter build apk --release

      # 8️⃣ رفع APK
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id }}
          files: ${{ env.PROJECT_ROOT }}/build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
