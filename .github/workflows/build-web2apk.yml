# =============================================================================
# Aite.studio - Web to APK Builder (Intelligent v2.3 - Gradle Java 17 Fix)
# Fixed: Force Gradle to use Java 17 instead of system default (21)
# =============================================================================

name: Build Web to APK

on:
  repository_dispatch:
    types: [build-web2apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        default: 'MyApp'
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.example.app'
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Build ID'
        required: false
        default: 'manual'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clear Gradle Cache (Fix Java 21 conflict)
        run: |
          echo "ðŸ§¹ Clearing old Gradle cache..."
          rm -rf ~/.gradle/caches
          rm -rf ~/.gradle/wrapper

      - name: Download Project
        run: |
          mkdir -p project && cd project
          echo "ðŸ“¥ Downloading project archive..."
          curl -sL "${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}" -o project.zip

          echo "ðŸ“¦ Extracting archive..."
          unzip -q project.zip
          rm project.zip

          echo "ðŸ“‚ Initial structure:"
          ls -la

      - name: Intelligent Project Structure Detection
        id: detect
        run: |
          cd project
          shopt -s extglob

          echo "ðŸ” Analyzing project structure..."

          find_entry_point() {
            local search_dirs=("$@")
            for dir in "${search_dirs[@]}"; do
              if [ -f "$dir/index.html" ]; then echo "$dir/index.html"; return 0; fi
              if [ -f "$dir/index.htm" ]; then echo "$dir/index.htm"; return 0; fi
            done
            for dir in "${search_dirs[@]}"; do
              local index_file=$(find "$dir" -maxdepth 1 -type f \( -iname "*index*.html" -o -iname "*index*.htm" -o -iname "*home*.html" -o -iname "*main*.html" \) 2>/dev/null | head -1)
              if [ -n "$index_file" ]; then echo "$index_file"; return 0; fi
            done
            for dir in "${search_dirs[@]}"; do
              local first_html=$(find "$dir" -maxdepth 2 -type f \( -iname "*.html" -o -iname "*.htm" \) 2>/dev/null | head -1)
              if [ -n "$first_html" ]; then echo "$first_html"; return 0; fi
            done
            return 1
          }

          HTML_COUNT=$(find . -type f \( -name "*.html" -o -name "*.htm" \) 2>/dev/null | wc -l)
          SUBDIRS=$(find . -maxdepth 1 -type d 2>/dev/null | wc -l)

          echo "Found $HTML_COUNT HTML files"

          if [ "$HTML_COUNT" -eq 1 ] && ls *.html 1>/dev/null 2>&1; then
            echo "âœ… Single HTML file"
            mkdir -p www
            cp -r !(www) www/ 2>/dev/null || cp -r ./* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
          elif [ -d "www" ] && [ -f "www/index.html" ]; then
            echo "âœ… Pre-built www folder"
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "âœ… dist folder"
            mkdir -p www && cp -r dist/* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
          elif [ -d "build" ] && [ -f "build/index.html" ]; then
            echo "âœ… build folder"
            mkdir -p www && cp -r build/* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
          elif [ "$SUBDIRS" -eq 2 ] && [ -z "$(ls *.html 2>/dev/null)" ]; then
            NESTED_DIR=$(find . -maxdepth 1 -type d ! -path . | head -1)
            echo "ðŸ“ Nested: $NESTED_DIR"
            mkdir -p www
            cp -r "$NESTED_DIR"/* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
          elif [ -f "index.html" ]; then
            echo "âœ… Flat structure"
            mkdir -p www
            cp -r !(www) www/ 2>/dev/null || cp -r ./* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
          else
            ENTRY=$(find_entry_point ".")
            if [ -n "$ENTRY" ]; then
              echo "âœ… Entry: $ENTRY"
              mkdir -p www && cp -r !(www) www/ 2>/dev/null || cp -r ./* www/
              ENTRY_NAME=$(basename "$ENTRY")
              if [ "$ENTRY_NAME" != "index.html" ]; then
                (cd www && mv "$ENTRY_NAME" index.html 2>/dev/null || cp "$ENTRY_NAME" index.html)
              fi
              echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
            else
              echo "âŒ No HTML files!"
              exit 1
            fi
          fi

          ls -la www/

      - name: Download Icon
        run: |
          mkdir -p project/icon
          curl -sL "${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}" -o project/icon/icon.png || echo "âš ï¸ Icon download failed"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build APK (Forced Java 17)
        run: |
          echo "ðŸš€ Starting build with forced Java 17..."
          mkdir -p build && cd build

          # Initialize
          npm init -y
          npm install @capacitor/core @capacitor/cli@latest @capacitor/android@latest

          # Create config
          cat > capacitor.config.json <<EOF
          {
            "appId": "${{ github.event.client_payload.package_name || github.event.inputs.package_name }}",
            "appName": "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}",
            "webDir": "www"
          }
          EOF

          cp -r ../project/www ./

          # Add Android
          npx cap add android
          npx cap sync

          # CRITICAL: Force Java 17 for Gradle
          cd android

          # Create gradle.properties with Java 17
          cat >> gradle.properties <<EOF

          # Force Java 17
          org.gradle.java.home=$JAVA_HOME
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # Alternative: Set JAVA_HOME explicitly for this step
          export JAVA_HOME=$JAVA_HOME_17_X64
          echo "Using Java: $JAVA_HOME"
          java -version

          # Clean any cached gradle files
          rm -rf ~/.gradle/caches/build-cache-1

          # Build with explicit Java home
          chmod +x gradlew
          ./gradlew assembleDebug             --no-daemon             --stacktrace             -Dorg.gradle.java.home=$JAVA_HOME             -Dfile.encoding=UTF-8

          echo "âœ… Build complete!"

      - name: Sign APK
        run: |
          cd build/android
          APK=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)
          [ -z "$APK" ] && { echo "âŒ No APK found!"; exit 1; }

          echo "ðŸ” Signing: $(basename $APK)"

          keytool -genkey -v -keystore key.jks -alias key -storepass 123456 -keypass 123456             -keyalg RSA -validity 10000 -dname "CN=Android,O=Android,C=US" 2>/dev/null

          if command -v apksigner &> /dev/null; then
            apksigner sign --ks key.jks --ks-pass pass:123456 --key-pass pass:123456 "$APK"
          else
            jarsigner -keystore key.jks -storepass 123456 -keypass 123456               -sigalg SHA256withRSA -digestalg SHA-256 "$APK" key
          fi

          cp "$APK" ../../app.apk
          echo "âœ… Signed: app.apk"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id || github.event.inputs.request_id }}
          name: "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          files: app.apk
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
