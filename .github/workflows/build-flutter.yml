name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name (com.example.app)'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      flutter_version:
        description: 'Flutter Version (auto/stable/3.x.x)'
        default: 'auto'
        required: false
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  # الاسم الذي يظهر للمستخدم (عربي)
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  # اسم الملف الفيزيائي (إنجليزي وآمن)
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  FLUTTER_VERSION_INPUT: ${{ github.event.client_payload.flutter_version || github.event.inputs.flutter_version || 'auto' }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup Environment
        run: |
          echo "Starting build for: $APP_NAME ($PACKAGE_NAME)"
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick

      - name: Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          if [ "$(ls -A temp_extract | wc -l)" == "1" ]; then
            mv temp_extract/*/* $PROJECT_DIR/ 2>/dev/null || mv temp_extract/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: Detect Flutter Version
        id: detect_flutter
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          DETECTED_VERSION="stable"
          if [ "$FLUTTER_VERSION_INPUT" != "auto" ]; then
            DETECTED_VERSION="$FLUTTER_VERSION_INPUT"
          elif [ -f "pubspec.yaml" ]; then
             VERSION=$(cat pubspec.yaml | grep -A 5 "environment:" | grep "flutter:" | head -1 | grep -oP '\d+\.\d+\.\d+' | head -1)
             if [ ! -z "$VERSION" ]; then DETECTED_VERSION="$VERSION"; fi
          fi
          echo "version=$DETECTED_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ contains(steps.detect_flutter.outputs.version, '.') && steps.detect_flutter.outputs.version || '' }}
          channel: ${{ !contains(steps.detect_flutter.outputs.version, '.') && steps.detect_flutter.outputs.version || 'stable' }}

      - name: Pre-build Diagnostics
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          mkdir -p android
          if [ ! -f "android/local.properties" ]; then echo "sdk.dir=/usr/local/lib/android/sdk" > android/local.properties; fi

      # -------------------------------------------------------------------------
      # سكربت بايثون المحدث: يصلح الاسم + يربط الأيقونة بشكل إجباري
      # -------------------------------------------------------------------------
      - name: Force Update App Name, Package AND Icon
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cat <<EOF > update_project_info.py
          import os
          import xml.etree.ElementTree as ET
          import re

          app_name = os.environ.get('APP_NAME', 'MyApp')
          package_name = os.environ.get('PACKAGE_NAME', 'com.example.app')
          
          # 1. Update strings.xml (اسم التطبيق)
          strings_path = 'android/app/src/main/res/values/strings.xml'
          os.makedirs(os.path.dirname(strings_path), exist_ok=True)
          xml_content = f'''<?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">{app_name}</string>
          </resources>'''
          with open(strings_path, 'w', encoding='utf-8') as f:
              f.write(xml_content)

          # 2. Update AndroidManifest.xml (الاسم، الحزمة، والأيقونة)
          manifest_path = 'android/app/src/main/AndroidManifest.xml'
          ET.register_namespace('android', 'http://schemas.android.com/apk/res/android')
          try:
              tree = ET.parse(manifest_path)
              root = tree.getroot()
              
              # تحديث اسم الحزمة
              if 'package' in root.attrib: root.attrib['package'] = package_name
              
              application = root.find('application')
              if application is not None:
                  android_ns = '{http://schemas.android.com/apk/res/android}'
                  
                  # تحديث اسم التطبيق
                  application.attrib[f'{android_ns}label'] = '@string/app_name'
                  
                  # >>> إصلاح الأيقونة: إجبار المانيفست على استخدام أيقوناتنا المولدة <<<
                  application.attrib[f'{android_ns}icon'] = '@mipmap/ic_launcher'
                  application.attrib[f'{android_ns}roundIcon'] = '@mipmap/ic_launcher'
                  
              tree.write(manifest_path, encoding='utf-8', xml_declaration=True)
              print("Manifest updated successfully with Icon and Name.")
          except Exception as e: print(f"Manifest Error: {e}")

          # 3. Update build.gradle (معرف التطبيق)
          gradle_path = 'android/app/build.gradle'
          if os.path.exists(gradle_path):
              with open(gradle_path, 'r') as f: content = f.read()
              content = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{package_name}"', content)
              content = re.sub(r'namespace\s+["\'].*?["\']', f'namespace "{package_name}"', content)
              with open(gradle_path, 'w') as f: f.write(content)
          EOF
          python3 update_project_info.py

      - name: Setup Signing
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          if [ ! -f "debug.keystore" ]; then
            keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi
          mkdir -p signing
          cat > signing/signing.gradle << 'EOF'
          signingConfigs {
              release {
                  storeFile file("../debug.keystore")
                  storePassword "android"
                  keyAlias "androiddebugkey"
                  keyPassword "android"
              }
          }
          buildTypes {
              release {
                  signingConfig signingConfigs.release
                  minifyEnabled true
                  shrinkResources true
                  proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
              }
          }
          EOF

      - name: Process Icon
        run: |
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi
          wget -q -O icon_original.png "$ICON_URL"
          # توليد الأيقونات في المسار القياسي ic_launcher
          convert icon_original.png -resize 48x48 $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert icon_original.png -resize 72x72 $PROJECT_DIR/android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert icon_original.png -resize 96x96 $PROJECT_DIR/android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert icon_original.png -resize 144x144 $PROJECT_DIR/android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert icon_original.png -resize 192x192 $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

      - name: Get Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: Build Universal APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter build apk --$BUILD_MODE --target-platform=android-arm,android-arm64 --split-debug-info=symbols/
          
          APK_DIR="build/app/outputs/flutter-apk"
          DEFAULT_APK="$APK_DIR/app-$BUILD_MODE.apk"
          
          # استخدام الاسم الآمن للملف (Fix Invalid Package)
          FINAL_APK="$APK_DIR/${SAFE_NAME}.apk"
          
          echo "Renaming $DEFAULT_APK to $FINAL_APK"
          mv "$DEFAULT_APK" "$FINAL_APK"
          
          FULL_PATH="$(pwd)/$FINAL_APK"
          echo "APK_PATH=$FULL_PATH" >> $GITHUB_ENV

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            ✅ **Build Success**
            **App:** ${{ env.APP_NAME }}
            **Package:** ${{ env.PACKAGE_NAME }}
          files: |
            ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
