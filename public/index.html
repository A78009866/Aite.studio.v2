<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aite Studio | App Builder</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f0f13;
            --bg-card: #1e1e24;
            --primary: #00E676;
            --primary-hover: #00c853;
            --text-main: #ffffff;
            --text-sec: #a0a0a0;
        }

        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; }
        
        /* واجهة اللغات */
        body[lang="en"] { font-family: 'Poppins', sans-serif; direction: ltr; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 100vh; }

        /* تسجيل الدخول */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .google-btn {
            background: #fff; color: #333; padding: 12px 25px; border-radius: 30px;
            border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-size: 1rem; transition: 0.3s;
        }
        .google-btn:hover { transform: scale(1.05); }

        /* الرأس */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .user-profile { display: flex; align-items: center; gap: 10px; background: var(--bg-card); padding: 5px 15px; border-radius: 50px; }
        .user-img { width: 35px; height: 35px; border-radius: 50%; }

        /* التبويبات */
        .tabs { display: flex; gap: 15px; margin-bottom: 20px; background: var(--bg-card); padding: 5px; border-radius: 15px; }
        .tab-btn { flex: 1; background: none; border: none; color: var(--text-sec); padding: 10px; cursor: pointer; border-radius: 10px; font-family: inherit; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: #000; }

        /* المحتوى */
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }

        /* النماذج */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--text-sec); font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 15px; background: var(--bg-card); border: 1px solid #333; color: #fff; border-radius: 12px; box-sizing: border-box; font-family: inherit; }
        .input-group input:focus { border-color: var(--primary); outline: none; }

        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: #000; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .btn-main:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* شريط التقدم */
        .progress-box { background: var(--bg-card); padding: 20px; border-radius: 15px; margin-top: 20px; display: none; border: 1px solid #333; }
        .progress-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; box-shadow: 0 0 10px var(--primary); }
        .status-txt { text-align: center; color: var(--text-sec); font-size: 0.9rem; margin-top: 10px; }

        /* قائمة تطبيقاتي */
        .app-item { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .app-info h4 { margin: 0 0 5px 0; font-size: 1rem; }
        .app-info span { font-size: 0.8rem; color: var(--text-sec); }
        .download-link { color: var(--primary); text-decoration: none; font-size: 1.2rem; }

        /* نافذة اللغات */
        .lang-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .lang-modal { background: var(--bg-card); padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; border: 1px solid #333; }
        .lang-option { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #2a2a30; border-radius: 12px; color: white; text-decoration: none; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .lang-option:hover { border-color: var(--primary); background: #333; }
        .lang-btn-float { position: fixed; bottom: 20px; left: 20px; background: #333; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #555; z-index: 999; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <h2 style="margin-bottom: 30px;">Aite Studio</h2>
        <button class="google-btn" onclick="signInWithGoogle()">
            <i class="fab fa-google"></i> <span data-i18n="signIn">تسجيل الدخول باستخدام Google</span>
        </button>
    </div>

    <div class="container" id="app-container" style="display: none;">
        <header>
            <h3 data-i18n="appTitle">Aite Builder</h3>
            <div class="user-profile">
                <img id="user-avatar" class="user-img" src="">
                <span id="user-name" style="font-size: 0.9rem;"></span>
                <i class="fas fa-sign-out-alt" onclick="logout()" style="margin-right: 10px; cursor: pointer; color: #ff4444;"></i>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('create')" data-i18n="newBuild">بناء جديد</button>
            <button class="tab-btn" onclick="switchTab('history')" data-i18n="myApps">تطبيقاتي</button>
        </div>

        <div id="create-section" class="section active">
            <div class="input-group">
                <label data-i18n="appName">اسم التطبيق</label>
                <input type="text" id="appName" placeholder="My Store">
            </div>
            <div class="input-group">
                <label data-i18n="pkgName">اسم الحزمة (Package)</label>
                <input type="text" id="pkgName" placeholder="com.my.app">
            </div>
            <div class="input-group">
                <label data-i18n="iconUrl">رابط الأيقونة</label>
                <input type="text" id="iconUrl" placeholder="https://...">
            </div>
            <div class="input-group">
                <label data-i18n="zipUrl">رابط ملف المشروع (Zip)</label>
                <input type="text" id="zipUrl" placeholder="https://...">
            </div>

            <button class="btn-main" onclick="startBuild()" id="buildBtn" data-i18n="startBuild">بناء التطبيق</button>

            <div class="progress-box" id="progressBox">
                <div style="display: flex; justify-content: space-between;">
                    <span data-i18n="status">الحالة</span>
                    <span id="progPercent" style="color: var(--primary);">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progFill"></div>
                </div>
                <p class="status-txt" id="statusTxt" data-i18n="initializing">جاري تهيئة السيرفر...</p>
                <a id="downloadBtn" href="#" target="_blank" class="btn-main" style="display: none; text-align: center; margin-top: 15px; text-decoration: none; background: #fff; color: #000;">
                    <i class="fas fa-download"></i> <span data-i18n="download">تحميل APK</span>
                </a>
            </div>
        </div>

        <div id="history-section" class="section">
            <div id="appsList">
                <p style="text-align: center; color: #666;" data-i18n="noApps">لا توجد تطبيقات سابقة</p>
            </div>
        </div>
    </div>

    <div class="lang-btn-float" onclick="toggleLangModal()">
        <i class="fas fa-language"></i>
    </div>

    <div class="lang-modal-overlay" id="langModal">
        <div class="lang-modal">
            <h3 style="margin-top: 0; color: white;" data-i18n="chooseLang">اختر اللغة</h3>
            <div class="lang-option" onclick="setLanguage('ar')">
                <i class="fas fa-check" id="check-ar" style="display:none; color: var(--primary);"></i> العربية
            </div>
            <div class="lang-option" onclick="setLanguage('en')">
                <i class="fas fa-check" id="check-en" style="display:none; color: var(--primary);"></i> English
            </div>
            <button onclick="toggleLangModal()" style="margin-top: 15px; background: none; border: none; color: #666; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- إعدادات Firebase الخاصة بك ---
        const firebaseConfig = {
            apiKey: "AIzaSyAN-9qBeL51nwpctJw9rSQYzz1C7dDRf1E",
            authDomain: "world-3212f.firebaseapp.com",
            databaseURL: "https://world-3212f-default-rtdb.firebaseio.com",
            projectId: "world-3212f",
            storageBucket: "world-3212f.firebasestorage.app",
            messagingSenderId: "421425146697",
            appId: "1:421425146697:web:efa372fbd585e8888e4898",
            measurementId: "G-163YR2VGK8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;

        // --- منطق المصادقة ---
        window.signInWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => alert(error.message));
        };

        window.logout = () => {
            signOut(auth);
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL;
                loadUserApps(user.uid);
            } else {
                currentUser = null;
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        // --- منطق البناء ---
        window.startBuild = async () => {
            if (!currentUser) return;

            const appName = document.getElementById('appName').value;
            const pkgName = document.getElementById('pkgName').value;
            const iconUrl = document.getElementById('iconUrl').value;
            const zipUrl = document.getElementById('zipUrl').value;
            
            if (!appName || !zipUrl) {
                alert(currentLang === 'ar' ? 'يرجى ملء جميع الحقول' : 'Please fill all fields');
                return;
            }

            const buildBtn = document.getElementById('buildBtn');
            const progressBox = document.getElementById('progressBox');
            
            buildBtn.disabled = true;
            progressBox.style.display = 'block';
            simulateProgress();

            const requestId = Date.now().toString(); // معرف فريد

            // 1. حفظ في قاعدة البيانات (حالة: جاري العمل)
            const newBuildRef = push(ref(db, 'users/' + currentUser.uid + '/apps'));
            await set(newBuildRef, {
                appName: appName,
                pkgName: pkgName,
                requestId: requestId,
                date: new Date().toISOString(),
                status: 'pending',
                downloadUrl: ''
            });

            // 2. إرسال للسيرفر
            try {
                const response = await fetch('/trigger-build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ app_name: appName, package_name: pkgName, icon_url: iconUrl, zip_url: zipUrl, request_id: requestId })
                });

                const result = await response.json();
                if (result.success) {
                    trackBuild(requestId, newBuildRef);
                } else {
                    alert('Error: ' + result.error);
                    buildBtn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                buildBtn.disabled = false;
            }
        };

        // --- متابعة الحالة ---
        function trackBuild(requestId, dbRef) {
            const statusTxt = document.getElementById('statusTxt');
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/check-status?request_id=${requestId}`);
                    const data = await res.json();

                    if (data.status === 'completed' && data.conclusion === 'success') {
                        clearInterval(interval);
                        completeProgress(true);
                        
                        document.getElementById('downloadBtn').href = data.download_url;
                        document.getElementById('downloadBtn').style.display = 'block';
                        statusTxt.innerText = currentLang === 'ar' ? '✅ تم البناء بنجاح!' : '✅ Build Successful!';
                        
                        // تحديث قاعدة البيانات بالرابط
                        update(dbRef, { status: 'success', downloadUrl: data.download_url });
                        
                    } else if (data.status === 'completed' && data.conclusion === 'failure') {
                        clearInterval(interval);
                        completeProgress(false);
                        statusTxt.innerText = '❌ Failed';
                        update(dbRef, { status: 'failed' });
                    }
                } catch (e) { console.log(e); }
            }, 5000);
        }

        // --- تحميل تطبيقات المستخدم ---
        function loadUserApps(uid) {
            const appsList = document.getElementById('appsList');
            const appsRef = ref(db, 'users/' + uid + '/apps');
            
            onValue(appsRef, (snapshot) => {
                appsList.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.values(data).reverse().forEach(app => {
                        const div = document.createElement('div');
                        div.className = 'app-item';
                        
                        let statusIcon = app.status === 'success' ? '<i class="fas fa-check-circle" style="color:var(--primary)"></i>' : 
                                         app.status === 'pending' ? '<i class="fas fa-spinner fa-spin"></i>' : 
                                         '<i class="fas fa-times-circle" style="color:red"></i>';

                        let actionBtn = app.downloadUrl ? 
                            `<a href="${app.downloadUrl}" class="download-link" target="_blank"><i class="fas fa-download"></i></a>` : '';

                        div.innerHTML = `
                            <div class="app-info">
                                <h4>${app.appName} ${statusIcon}</h4>
                                <span>${app.pkgName} • ${new Date(app.date).toLocaleDateString()}</span>
                            </div>
                            <div>${actionBtn}</div>
                        `;
                        appsList.appendChild(div);
                    });
                } else {
                    appsList.innerHTML = `<p style="text-align: center; color: #666;">${currentLang === 'ar' ? 'لا توجد تطبيقات' : 'No apps found'}</p>`;
                }
            });
        }
    </script>

    <script>
        // --- سكربت الواجهة واللغة ---
        let currentLang = localStorage.getItem('lang') || 'ar';
        const translations = {
            ar: {
                signIn: "تسجيل الدخول باستخدام Google",
                appTitle: "منشئ التطبيقات",
                newBuild: "بناء جديد",
                myApps: "تطبيقاتي",
                appName: "اسم التطبيق",
                pkgName: "اسم الحزمة",
                iconUrl: "رابط الأيقونة",
                zipUrl: "رابط المشروع",
                startBuild: "ابدأ البناء",
                status: "الحالة",
                initializing: "جاري التحضير...",
                download: "تحميل APK",
                noApps: "لا توجد تطبيقات سابقة",
                chooseLang: "اختر اللغة"
            },
            en: {
                signIn: "Sign in with Google",
                appTitle: "App Builder",
                newBuild: "New Build",
                myApps: "My Apps",
                appName: "App Name",
                pkgName: "Package Name",
                iconUrl: "Icon URL",
                zipUrl: "Project URL",
                startBuild: "Start Build",
                status: "Status",
                initializing: "Initializing...",
                download: "Download APK",
                noApps: "No previous apps",
                chooseLang: "Choose Language"
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.body.lang = lang; // CSS styling
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });

            document.getElementById('check-ar').style.display = lang === 'ar' ? 'inline' : 'none';
            document.getElementById('check-en').style.display = lang === 'en' ? 'inline' : 'none';
            toggleLangModal();
        }

        function toggleLangModal() {
            const modal = document.getElementById('langModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'create') {
                document.getElementById('create-section').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                document.getElementById('history-section').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        }

        // Progress Animation Logic
        let progressInterval;
        function simulateProgress() {
            let width = 0;
            const bar = document.getElementById('progFill');
            const txt = document.getElementById('progPercent');
            
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if (width >= 90) clearInterval(progressInterval);
                else {
                    width += Math.random() * 3;
                    bar.style.width = width + '%';
                    txt.innerText = Math.floor(width) + '%';
                }
            }, 500);
        }

        function completeProgress(success) {
            clearInterval(progressInterval);
            const bar = document.getElementById('progFill');
            const txt = document.getElementById('progPercent');
            bar.style.width = '100%';
            txt.innerText = '100%';
            bar.style.background = success ? '#00E676' : 'red';
            document.getElementById('buildBtn').disabled = false;
        }

        // تطبيق اللغة عند البدء
        setLanguage(currentLang);
        // إغلاق المودال عند البدء للتأكد
        document.getElementById('langModal').style.display = 'none'; 
    </script>
</body>
</html>
