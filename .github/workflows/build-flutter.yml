name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup System Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick sed
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Download and Extract Project (Smart)
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          
          # Find where pubspec.yaml is located
          PUBSPEC_PATH=$(find temp_extract -name "pubspec.yaml" | head -n 1)
          
          if [ -z "$PUBSPEC_PATH" ]; then
            echo "âŒ Error: pubspec.yaml not found!"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$PUBSPEC_PATH")
          echo "ðŸ“‚ Found project at: $PROJECT_ROOT"
          
          # Move files to correct directory
          if [ "$PROJECT_ROOT" != "temp_extract" ]; then
            mv "$PROJECT_ROOT"/* $PROJECT_DIR/
            mv "$PROJECT_ROOT"/.[!.]* $PROJECT_DIR/ 2>/dev/null || true
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      - name: Repair Project Structure
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # 1. Fix SDK constraints first
          if [ -f "pubspec.yaml" ]; then
            sed -i 's/sdk: ">=2.0.[0-9].*"/sdk: ">=2.12.0 <4.0.0"/' pubspec.yaml || true
            sed -i 's/sdk: ">=2.[1-9].[0-9].*"/sdk: ">=2.12.0 <4.0.0"/' pubspec.yaml || true
            sed -i "s/sdk: '>=2.0.[0-9].*'/sdk: '>=2.12.0 <4.0.0'/" pubspec.yaml || true
            sed -i 's/cupertino_icons: \^0\.[0-9.]*/cupertino_icons: ^1.0.2/' pubspec.yaml || true
          fi
          
          # 2. Get dependencies
          flutter pub get
          
          # 3. CRITICAL: Ensure Android folder exists properly
          # This command regenerates the android folder if it's missing or corrupt
          echo "ðŸ”§ Ensuring Android platform exists..."
          flutter create . --platforms android --org ${PACKAGE_NAME}

      - name: Configure Android Project (The Fix)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Now we are 100% sure android/app exists
          
          # Fix AndroidManifest
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
             # Fix Permissions
             if ! grep -q "android.permission.INTERNET" "$MANIFEST"; then
                sed -i '/<manifest/a \    <uses-permission android:name="android.permission.INTERNET"/>' "$MANIFEST"
             fi
             # Fix Exported
             if ! grep -q 'android:exported="true"' "$MANIFEST"; then
                sed -i 's/<activity/<activity android:exported="true"/g' "$MANIFEST"
             fi
             # Update Label
             sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/g' "$MANIFEST"
          fi

          # Fix Strings
          mkdir -p android/app/src/main/res/values
          cat > android/app/src/main/res/values/strings.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${APP_NAME}</string>
          </resources>
          EOF

      - name: Force Kotlin 2.1.0 (Root Level)
        working-directory: ${{ env.PROJECT_DIR }}/android
        run: |
          # Update Gradle Wrapper
          mkdir -p gradle/wrapper
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.9-all.zip" > gradle/wrapper/gradle-wrapper.properties
          
          # Force settings.gradle
          if [ -f "settings.gradle" ]; then
             sed -i "s/kotlin(\"android\") version \"[^\"]*\"/kotlin(\"android\") version \"2.1.0\"/g" settings.gradle || true
             sed -i "s/id 'org.jetbrains.kotlin.android' version '[^']*'/id 'org.jetbrains.kotlin.android' version '2.1.0'/g" settings.gradle || true
             
             if grep -q "plugins {" "settings.gradle"; then
                if ! grep -q "com.google.gms.google-services" "settings.gradle"; then
                   sed -i '/plugins {/a \    id "com.google.gms.google-services" version "4.4.0" apply false' settings.gradle
                fi
             fi
          fi
          
          # Force root build.gradle (Legacy)
          if [ -f "build.gradle" ]; then
             if grep -q "buildscript" "build.gradle"; then
                if ! grep -q "google-services" "build.gradle"; then
                   sed -i '/dependencies {/a \        classpath "com.google.gms:google-services:4.4.0"' build.gradle
                fi
                sed -i "s/ext.kotlin_version = '[^']*'/ext.kotlin_version = '2.1.0'/g" build.gradle || true
             fi
          fi

      - name: Replace App Build.gradle (Safe Mode)
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          # We don't try to copy backup anymore, just write the new file
          # because we just regenerated the folder, we know the path exists.
          
          cat > build.gradle << 'GRADLE_EOF'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
              id "com.google.gms.google-services"
          }
          
          def localProperties = new Properties()
          def localPropertiesFile = rootProject.file('local.properties')
          if (localPropertiesFile.exists()) {
              localPropertiesFile.withReader('UTF-8') { reader ->
                  localProperties.load(reader)
              }
          }
          
          def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
          if (flutterVersionCode == null) { flutterVersionCode = '1' }
          
          def flutterVersionName = localProperties.getProperty('flutter.versionName')
          if (flutterVersionName == null) { flutterVersionName = '1.0' }
          
          android {
              namespace "PLACEHOLDER_PACKAGE"
              compileSdkVersion flutter.compileSdkVersion
              ndkVersion flutter.ndkVersion
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = '17' }
              
              defaultConfig {
                  applicationId "PLACEHOLDER_PACKAGE"
                  minSdkVersion 21
                  targetSdkVersion flutter.targetSdkVersion
                  versionCode flutterVersionCode.toInteger()
                  versionName flutterVersionName
                  multiDexEnabled true
              }
              
              signingConfigs {
                  release {
                      storeFile file("../debug.keystore")
                      storePassword "android"
                      keyAlias "androiddebugkey"
                      keyPassword "android"
                  }
              }
              
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
          }
          
          dependencies {
              implementation platform('com.google.firebase:firebase-bom:33.7.0')
          }
          
          flutter { source '../..' }
          GRADLE_EOF
          
          sed -i "s/PLACEHOLDER_PACKAGE/${PACKAGE_NAME}/g" build.gradle
          touch proguard-rules.pro
          
          # Create Dummy Google Services JSON
          if [ ! -f "google-services.json" ]; then
            cat > google-services.json << EOF
          {
            "project_info": { "project_number": "123", "project_id": "dummy", "storage_bucket": "dummy" },
            "client": [{
              "client_info": { "mobilesdk_app_id": "1:123:android:123", "android_client_info": { "package_name": "${PACKAGE_NAME}" } },
              "api_key": [{ "current_key": "dummy" }],
              "services": { "appinvite_service": { "status": 1 } }
            }]
          }
          EOF
          fi

      - name: Setup Signing Key
        working-directory: ${{ env.PROJECT_DIR }}/android
        run: |
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      - name: Process Icon
        run: |
          wget -q -O icon.png "$ICON_URL"
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi
          convert icon.png -resize 48x48 $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi/ic_launcher.png || cp icon.png $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi/ic_launcher.png

      - name: Final Build
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter pub upgrade --major-versions || true
          flutter pub get
          
          # Build APK (ARM Only for size & compatibility)
          flutter build apk --release --target-platform=android-arm,android-arm64 --no-tree-shake-icons
          
          APK_PATH=$(find build/app/outputs/flutter-apk -name "app-release.apk" | head -n 1)
          cp "$APK_PATH" "${SAFE_NAME}.apk"
          echo "APK_FINAL_PATH=${{ env.PROJECT_DIR }}/${SAFE_NAME}.apk" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          files: ${{ env.APK_FINAL_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
