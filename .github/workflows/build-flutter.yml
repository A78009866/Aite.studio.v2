name: Smart Flutter Cloud Build (Universal)

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url }}
  # Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  FLUTTER_VER: '3.22.x' 
  BUILD_ARGS: '--release --no-shrink'

jobs:
  universal-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: 1. Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick openjdk-17-jdk

      - name: 2. Download and Extract Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          # ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø°ÙƒØ§Ø¡
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      # ========================================================
      # THE BRAIN: Smart Detection (Legacy vs Modern)
      # ========================================================
      - name: 3. Detect Project Age & Configure
        working-directory: ${{ env.PROJECT_DIR }}
        id: detector
        run: |
          echo "ğŸ” Analyzing pubspec.yaml for compatibility..."
          
          # Ù‚Ø±Ø§Ø¡Ø© Ø¥ØµØ¯Ø§Ø± SDK Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          SDK_CONSTRAINT=$(grep "sdk:" pubspec.yaml | head -n 1)
          echo "Found SDK constraint: $SDK_CONSTRAINT"
          
          # Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒØ´Ù: Ù‡Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‚Ø¯ÙŠÙ… (Ø£Ù‚Ù„ Ù…Ù† 2.12)ØŸ
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ù†Ù…Ø§Ø· Ù…Ø«Ù„ "sdk: >=2.7.0" Ø£Ùˆ "sdk: <3.0.0" Ø¨Ø¯ÙˆÙ† ÙˆØ¬ÙˆØ¯ 2.12 ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰
          
          IS_LEGACY=false
          
          if [[ "$SDK_CONSTRAINT" == *"2.12"* ]] || [[ "$SDK_CONSTRAINT" == *"3."* ]]; then
             echo "âœ… Modern Project Detected (Null Safety supported)"
             echo "FLUTTER_VER=3.22.x" >> $GITHUB_ENV
             echo "IS_LEGACY=false" >> $GITHUB_ENV
          else
             echo "âš ï¸ Legacy Project Detected (Pre-Null Safety)"
             # Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© 3.7.12 Ù„Ø£Ù†Ù‡Ø§ ØªØ¯Ø¹Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØªØ¯Ø¹Ù… Gradle Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„
             echo "FLUTTER_VER=3.7.12" >> $GITHUB_ENV
             # Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§Ø¬ ØªØ¬Ø§ÙˆØ² ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
             echo "BUILD_ARGS=--release --no-shrink --no-sound-null-safety" >> $GITHUB_ENV
             echo "IS_LEGACY=true" >> $GITHUB_ENV
          fi

      - name: 4. Setup Flutter (Dynamic Version)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VER }} # ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªÙŠ Ø­Ø¯Ø¯Ù†Ø§Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          cache: true

      - name: 5. Smart Gradle Fixer
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ”§ Fixing Gradle based on project type..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ù…Ø´ØªØ±Ùƒ Ù„Ù„ÙƒÙ„)
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
          # Ø¥ØµÙ„Ø§Ø­ Ù…Ù„ÙØ§Øª Gradle
          GRADLE_FILE="android/build.gradle"
          WRAPPER_FILE="android/gradle/wrapper/gradle-wrapper.properties"
          mkdir -p android/gradle/wrapper

          if [ "${{ env.IS_LEGACY }}" == "true" ]; then
            # === ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ===
            echo "ğŸ›  Applying LEGACY fixes..."
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Gradle 7.4 (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Flutter 3.7 Ùˆ Java 11/17)
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip" > $WRAPPER_FILE
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… AGP Ø£Ù‚Ø¯Ù… Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªÙˆØ§ÙÙ‚
            if [ -f "$GRADLE_FILE" ]; then
               sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:7.3.0/g' $GRADLE_FILE
               sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.10/g' $GRADLE_FILE
            fi

          else
            # === ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ===
            echo "âœ¨ Applying MODERN fixes..."
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Gradle 8.4 Ø§Ù„Ø­Ø¯ÙŠØ«
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-all.zip" > $WRAPPER_FILE
            
            if [ -f "$GRADLE_FILE" ]; then
               sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.1.0/g' $GRADLE_FILE
               sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.10/g' $GRADLE_FILE
               # Ø¥Ø¶Ø§ÙØ© namespace Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø­Ø¯ÙŠØ«
               if ! grep -q "namespace" android/app/build.gradle; then
                 sed -i "/android {/a \    namespace '${PACKAGE_NAME}'" android/app/build.gradle
               fi
            fi
          fi
          
          # Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
          # Ø­Ø°Ù Version Code Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          sed -i '/flutterVersionName/d' android/local.properties 2>/dev/null || true
          sed -i '/flutterVersionCode/d' android/local.properties 2>/dev/null || true

          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù firebase ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹
          if grep -r "firebase_options.dart" lib/ > /dev/null; then
            if [ ! -f "lib/firebase_options.dart" ]; then
              echo "âš ï¸ Mocking missing firebase_options.dart..."
              cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart';
          import 'package:flutter/foundation.dart';
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              return const FirebaseOptions(
                apiKey: 'dummy', appId: 'dummy', messagingSenderId: 'dummy', projectId: 'dummy'
              );
            }
          }
          EOF
            fi
          fi

      - name: 6. Refactor Package & Icon
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Ø³ÙƒØ±Ø¨Øª Ø¨Ø§ÙŠØ«ÙˆÙ† Ø§Ù„Ù‚ÙˆÙŠ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø²Ù…Ø© (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø£Ù†Ù‡ Ù…Ù…ØªØ§Ø²)
          cat <<EOF > refactor_engine.py
          import os, re
          new_package = "${PACKAGE_NAME}"
          app_name = "${APP_NAME}"
          new_path = new_package.replace('.', '/')
          android_root = "android/app/src/main"
          
          # 1. Manifest Update
          manifest_path = os.path.join(android_root, "AndroidManifest.xml")
          if os.path.exists(manifest_path):
              with open(manifest_path, 'r', encoding='utf-8', errors='ignore') as f: content = f.read()
              content = re.sub(r'package="[^"]+"', f'package="{new_package}"', content)
              content = re.sub(r'android:label="[^"]+"', 'android:label="@string/app_name"', content)
              with open(manifest_path, 'w', encoding='utf-8') as f: f.write(content)

          # 2. Strings.xml
          strings_path = os.path.join(android_root, "res/values/strings.xml")
          os.makedirs(os.path.dirname(strings_path), exist_ok=True)
          with open(strings_path, 'w', encoding='utf-8') as f:
              f.write(f'<resources><string name="app_name">{app_name}</string></resources>')

          # 3. Gradle ID
          gradle_path = "android/app/build.gradle"
          if os.path.exists(gradle_path):
              with open(gradle_path, 'r') as f: content = f.read()
              content = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{new_package}"', content)
              with open(gradle_path, 'w') as f: f.write(content)

          # 4. Move Files
          java_src = os.path.join(android_root, "java")
          kotlin_src = os.path.join(android_root, "kotlin")
          src_dir = kotlin_src if os.path.exists(kotlin_src) else java_src
          
          if os.path.exists(src_dir):
              for root, dirs, files in os.walk(src_dir):
                  if "MainActivity.kt" in files or "MainActivity.java" in files:
                      main_file = "MainActivity.kt" if "MainActivity.kt" in files else "MainActivity.java"
                      new_full_path = os.path.join(src_dir, new_path)
                      os.makedirs(new_full_path, exist_ok=True)
                      old_file_path = os.path.join(root, main_file)
                      
                      with open(old_file_path, 'r', encoding='utf-8', errors='ignore') as f: code = f.read()
                      code = re.sub(r'package\s+[\w\.]+', f'package {new_package}', code)
                      
                      with open(os.path.join(new_full_path, main_file), 'w', encoding='utf-8') as f: f.write(code)
                      print(f"Moved {main_file}")
                      break
          EOF
          python3 refactor_engine.py

          # ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
          wget -q -O icon.png "$ICON_URL"
          rm -rf android/app/src/main/res/mipmap-*
          for size in "mdpi 48" "hdpi 72" "xhdpi 96" "xxhdpi 144" "xxxhdpi 192"; do
             read -r name dim <<< "$size"
             mkdir -p android/app/src/main/res/mipmap-$name
             convert icon.png -resize ${dim}x${dim} android/app/src/main/res/mipmap-$name/ic_launcher.png
          done

      - name: 7. Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter pub get
          
          echo "ğŸš€ Building with args: ${{ env.BUILD_ARGS }}"
          flutter build apk ${{ env.BUILD_ARGS }}

          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© ÙˆØ§Ù„Ù†Ù‚Ù„
          APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          mv "$APK_PATH" "build/app/outputs/flutter-apk/${SAFE_NAME}.apk"
          echo "APK_PATH=$(pwd)/build/app/outputs/flutter-apk/${SAFE_NAME}.apk" >> $GITHUB_ENV

      - name: 8. Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            Build ID: ${{ env.BUILD_ID }}
            Mode: ${{ env.IS_LEGACY == 'true' && 'Legacy (Old Flutter)' || 'Modern (Latest Flutter)' }}
          files: ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
