name: Smart Flutter Cloud Build (Universal v3)

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url }}

jobs:
  universal-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: 1. Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick openjdk-17-jdk

      - name: 2. Download and Extract
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          # Smart Move: Handle nested folders
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      # ========================================================
      # üß† SMART DETECTOR: Python Logic for Precise Detection
      # ========================================================
      - name: 3. Analyze Project Structure
        working-directory: ${{ env.PROJECT_DIR }}
        id: analyzer
        run: |
          cat <<EOF > detect_version.py
          import re
          import os

          # Default values
          is_legacy = False
          flutter_ver = "" # Empty means latest stable

          if os.path.exists("pubspec.yaml"):
              with open("pubspec.yaml", "r") as f:
                  content = f.read()
                  
                  # Find SDK Constraint
                  match = re.search(r'sdk:\s*["\']?([><=^0-9\.\s-]+)["\']?', content)
                  if match:
                      ver_str = match.group(1)
                      print(f"Found SDK Constraint: {ver_str}")
                      
                      # Check for Legacy (< 2.12.0)
                      # If it does NOT contain 2.12 or 3.x.x, and contains 2.x, it's legacy
                      if "2.12" not in ver_str and "3." not in ver_str and ("<3.0.0" in ver_str or "2." in ver_str):
                          is_legacy = True
                          flutter_ver = "3.7.12" # Last version with solid legacy support
                      
          # Output to GitHub Actions
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"IS_LEGACY={str(is_legacy).lower()}\n")
              f.write(f"FLUTTER_VER={flutter_ver}\n")
              
          print(f"Legacy Mode: {is_legacy}")
          print(f"Selected Flutter Version: {flutter_ver if flutter_ver else 'Latest Stable'}")
          EOF
          
          python3 detect_version.py

      - name: 4. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VER }} # Dynamic: Empty for latest, 3.7.12 for legacy
          cache: true

      - name: 5. Auto-Fix Gradle & Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # 1. Mock firebase_options to prevent build errors
          if grep -r "firebase_options.dart" lib/ > /dev/null; then
            if [ ! -f "lib/firebase_options.dart" ]; then
              mkdir -p lib
              echo "class DefaultFirebaseOptions{static get currentPlatform{return null;}}" > lib/firebase_options.dart
            fi
          fi

          # 2. Key Generation
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
          # 3. Gradle Fixes based on Mode
          WRAPPER="android/gradle/wrapper/gradle-wrapper.properties"
          GRADLE_FILE="android/build.gradle"
          mkdir -p android/gradle/wrapper

          if [ "${{ env.IS_LEGACY }}" == "true" ]; then
            echo "üîß Mode: LEGACY (Fixing for Old Android)"
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip" > $WRAPPER
            
            if [ -f "$GRADLE_FILE" ]; then
               sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:7.3.0/g' $GRADLE_FILE
               sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.10/g' $GRADLE_FILE
            fi
            # Set Build Args for Legacy
            echo "BUILD_ARGS=--release --no-shrink --no-sound-null-safety" >> $GITHUB_ENV

          else
            echo "‚ú® Mode: MODERN (Updating to Latest)"
            echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-all.zip" > $WRAPPER
            
            if [ -f "$GRADLE_FILE" ]; then
               sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.1.0/g' $GRADLE_FILE
               sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[0-9.]\+/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.10/g' $GRADLE_FILE
               # Add namespace for AGP 8+
               if ! grep -q "namespace" android/app/build.gradle; then
                 sed -i "/android {/a \    namespace '${PACKAGE_NAME}'" android/app/build.gradle
               fi
            fi
            # Set Build Args for Modern
            echo "BUILD_ARGS=--release --no-shrink" >> $GITHUB_ENV
          fi

          # Common Cleanups
          sed -i '/flutterVersionName/d' android/local.properties 2>/dev/null || true
          sed -i '/flutterVersionCode/d' android/local.properties 2>/dev/null || true

      - name: 6. Refactor Package Name & Icon
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cat <<EOF > refactor.py
          import os, re
          pkg = "${PACKAGE_NAME}"
          name = "${APP_NAME}"
          path = pkg.replace('.', '/')
          
          # Manifest
          m = "android/app/src/main/AndroidManifest.xml"
          if os.path.exists(m):
              with open(m, 'r') as f: s = f.read()
              s = re.sub(r'package="[^"]+"', f'package="{pkg}"', s)
              s = re.sub(r'android:label="[^"]+"', 'android:label="@string/app_name"', s)
              with open(m, 'w') as f: f.write(s)
          
          # Strings
          s_path = "android/app/src/main/res/values/strings.xml"
          os.makedirs(os.path.dirname(s_path), exist_ok=True)
          with open(s_path, 'w') as f: f.write(f'<resources><string name="app_name">{name}</string></resources>')
          
          # Gradle
          g = "android/app/build.gradle"
          if os.path.exists(g):
              with open(g, 'r') as f: s = f.read()
              s = re.sub(r'applicationId\s+["\'].*?["\']', f'applicationId "{pkg}"', s)
              with open(g, 'w') as f: f.write(s)
              
          # Move MainActivity
          for root, dirs, files in os.walk("android/app/src/main"):
              if "MainActivity.java" in files or "MainActivity.kt" in files:
                  f_name = "MainActivity.kt" if "MainActivity.kt" in files else "MainActivity.java"
                  old = os.path.join(root, f_name)
                  new_dir = os.path.join("android/app/src/main", "java" if "java" in root else "kotlin", path)
                  os.makedirs(new_dir, exist_ok=True)
                  with open(old, 'r') as f: c = f.read()
                  c = re.sub(r'package\s+[\w\.]+', f'package {pkg}', c)
                  with open(os.path.join(new_dir, f_name), 'w') as f: f.write(c)
                  break
          EOF
          python3 refactor.py

          # Icons
          wget -q -O icon.png "$ICON_URL"
          rm -rf android/app/src/main/res/mipmap-*
          for s in "mdpi 48" "hdpi 72" "xhdpi 96" "xxhdpi 144" "xxxhdpi 192"; do
             read -r n d <<< "$s"
             mkdir -p android/app/src/main/res/mipmap-$n
             convert icon.png -resize ${d}x${d} android/app/src/main/res/mipmap-$n/ic_launcher.png
          done

      - name: 7. Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter pub get
          echo "üöÄ Building with: ${{ env.BUILD_ARGS }}"
          flutter build apk ${{ env.BUILD_ARGS }}

          APK=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          mv "$APK" "${SAFE_NAME}.apk"
          echo "APK_PATH=$(pwd)/${SAFE_NAME}.apk" >> $GITHUB_ENV

      - name: 8. Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
             Build ID: ${{ env.BUILD_ID }}
             Mode: ${{ env.IS_LEGACY == 'true' && 'Legacy üèöÔ∏è' || 'Modern ‚ú®' }}
          files: ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
