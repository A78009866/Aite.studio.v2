# =============================================================================
# Aite.studio - Web to APK (Speed Optimized + Path Fixed)
# 1. Fixed: Uses $GITHUB_WORKSPACE to ensure APK is found for release.
# 2. Optimized: Enabled Gradle Caching to reduce build time significantly.
# =============================================================================

name: Build Web to APK

on:
  repository_dispatch:
    types: [build-web2apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        default: 'MyApp'
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.example.app'
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Build ID'
        required: false
        default: 'manual'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # SPEED OPTIMIZATION: Setup Gradle with Caching
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.10.2'

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Download & Extract Project
        run: |
          mkdir -p project
          echo "ðŸ“¥ Downloading project..."
          curl -sL "${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}" -o project.zip
          unzip -q project.zip -d project
          rm project.zip

      - name: Prepare Web Assets
        run: |
          # Smart detection to move files to 'www' folder
          mkdir -p www
          cd project
          
          if [ -f "index.html" ]; then
            cp -r * ../www/
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            cp -r dist/* ../www/
          elif [ -d "build" ] && [ -f "build/index.html" ]; then
            cp -r build/* ../www/
          else
            # Deep search for index.html
            ENTRY=$(find . -name "index.html" | head -1)
            if [ -n "$ENTRY" ]; then
              cp -r "$(dirname "$ENTRY")"/* ../www/
            else
              echo "âŒ Error: index.html not found!"
              exit 1
            fi
          fi

      - name: Download Icon
        run: |
          mkdir -p icon
          curl -sL "${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}" -o icon/icon.png

      - name: Initialize Capacitor & Android
        run: |
          # Create build directory
          mkdir -p android_build
          cp -r www android_build/
          cp -r icon android_build/
          cd android_build
          
          # Install dependencies
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android

          # Config
          cat > capacitor.config.json <<EOF
          {
            "appId": "${{ github.event.client_payload.package_name || github.event.inputs.package_name }}",
            "appName": "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

          # Add Android platform
          npx cap add android
          npx cap sync

          # FORCE ICON UPDATE (Remove XML, keep PNG)
          if [ -f "icon/icon.png" ]; then
            echo "ðŸŽ¨ Applying Icon..."
            rm -rf android/app/src/main/res/mipmap-anydpi-v26
            for dir in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
              mkdir -p android/app/src/main/res/mipmap-${dir}
              cp icon/icon.png android/app/src/main/res/mipmap-${dir}/ic_launcher.png
              cp icon/icon.png android/app/src/main/res/mipmap-${dir}/ic_launcher_round.png
            done
          fi

      - name: Build APK (Gradle)
        run: |
          cd android_build/android
          chmod +x gradlew
          # Using standard build command, caching handles the speed
          ./gradlew assembleDebug

      - name: Sign & Align APK
        run: |
          # Locate the built APK
          cd android_build/android/app/build/outputs/apk/debug
          
          # Tools Setup
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -r | head -n 1)
          ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"

          # 1. ZipAlign
          $ZIPALIGN -v -p 4 app-debug.apk app-aligned.apk

          # 2. Key Generation
          keytool -genkey -v -keystore release-key.jks -alias key0 -keyalg RSA -keysize 2048 -validity 10000 -storepass 123456 -keypass 123456 -dname "CN=App, O=App, C=US"

          # 3. Sign
          $APKSIGNER sign --ks release-key.jks --ks-pass pass:123456 --out app-final.apk app-aligned.apk

          # === CRITICAL FIX: MOVE TO WORKSPACE ROOT ===
          mv app-final.apk $GITHUB_WORKSPACE/app.apk
          echo "âœ… APK Moved to: $GITHUB_WORKSPACE/app.apk"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id || github.event.inputs.request_id }}
          name: "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          files: app.apk
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
