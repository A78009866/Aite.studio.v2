name: Build Flutter APK with AI Repair

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      zip_url:
        required: true
      app_name:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ØªØ«Ø¨ÙŠØª Node.js Ù„ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­
      - name: Setup Node.js (for AI script)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm install axios

      # Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø¬Ø§ÙØ§
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # ØªØ­Ù…ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      - name: Download & Unzip Project
        run: |
          wget -O project.zip "${{ github.event.client_payload.zip_url || inputs.zip_url }}"
          unzip project.zip -d flutter_project
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ
          if [ -d "flutter_project/android" ]; then
             mv flutter_project/* .
          else
             # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ pubspec.yaml
             DIR=$(find flutter_project -name "pubspec.yaml" -exec dirname {} \;)
             mv $DIR/* .
          fi

      - name: Flutter Pub Get
        run: flutter pub get

      # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ø¨Ù†Ø§Ø¡
      - name: First Build Attempt
        id: build_1
        continue-on-error: true
        run: flutter build apk --release > build_log.txt 2>&1

      # --- Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
      - name: ğŸš‘ AI Auto-Repair
        if: steps.build_1.outcome == 'failure'
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }} # Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø®Ø²Ù† ÙÙŠ GitHub Secrets
        run: node ai-repair.js

      # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
      - name: Retry Build (After AI Fix)
        if: steps.build_1.outcome == 'failure'
        run: flutter build apk --release

      # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚)
      - name: Send to Telegram
        if: success()
        env:
            TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
            TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
            APK_PATH=$(find build/app/outputs/flutter-apk -name "app-release.apk")
            curl -v -F "chat_id=$TG_CHAT" \
            -F "document=@$APK_PATH" \
            -F "caption=âœ… *Flutter Build Success (AI Assisted)*" \
            https://api.telegram.org/bot$TG_TOKEN/sendDocument
