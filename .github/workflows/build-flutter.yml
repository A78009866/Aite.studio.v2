name: Aite Smart Logic Engine (stable, dynamic Flutter selection)

on:
  repository_dispatch:
    types: [build-flutter]

permissions:
  contents: write

jobs:
  analyze_and_build:
    name: Analyze & Build
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle_cache
      ANDROID_COMPILE_SDK: '33'
      BUILD_TGZ: ''

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python & PyYAML
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml || true

      - name: Download & extract uploaded ZIP (robust)
        run: |
          set -euo pipefail
          mkdir -p temp_zip
          echo "Downloading project zip: ${{ github.event.client_payload.zip_url }}"
          curl -S --fail --location --retry 3 --retry-delay 3 "${{ github.event.client_payload.zip_url }}" -o project.zip
          echo "Downloaded project.zip size: $(stat -c%s project.zip) bytes"
          unzip -q project.zip -d temp_zip
          REAL_ROOT=$(find temp_zip -maxdepth 6 -name "pubspec.yaml" -exec dirname {} + | head -n 1 || true)
          echo "Detected project root: $REAL_ROOT"
          if [ -z "$REAL_ROOT" ]; then
            echo "ERROR_NO_PUBSPEC=true" >> $GITHUB_ENV
            echo "Listing temp_zip top-level:"
            ls -la temp_zip || true
          else
            echo "PROJECT_ROOT=$REAL_ROOT" >> $GITHUB_ENV
          fi

      - name: Fail early if no pubspec found
        if: env.ERROR_NO_PUBSPEC == 'true'
        run: |
          echo "No Flutter project (pubspec.yaml) found in uploaded zip."
          exit 1

      - name: Choose Flutter & Java version from pubspec.yaml
        id: choose
        run: |
          set -euo pipefail
          ROOT=${{ env.PROJECT_ROOT }}
          FLUTTER_VER_DEFAULT="3.10.6"
          JAVA_VER_DEFAULT="17"
          # fallbacks
          FLUTTER_VERSION="$FLUTTER_VER_DEFAULT"
          JAVA_VERSION="$JAVA_VER_DEFAULT"
          if [ -n "$ROOT" ] && [ -f "$ROOT/pubspec.yaml" ]; then
            python - <<'PY' > /tmp/flutter_choice.env
import yaml, os, re
p = os.getenv('ROOT') or os.getenv('PROJECT_ROOT')
if not p:
    print("FLUTTER_VERSION=3.10.6")
    print("JAVA_VERSION=17")
else:
    import sys
    import io
    try:
        with open(os.path.join(p,'pubspec.yaml'),'r',encoding='utf-8') as f:
            doc = yaml.safe_load(f) or {}
        sdk = (doc.get('environment') or {}).get('sdk','')
    except Exception as e:
        sdk = ''
    # Default choices:
    flutter_v = "3.10.6"
    java_v = "17"
    if sdk:
        if "3." in str(sdk) or ">=" in str(sdk) and "3" in str(sdk):
            flutter_v = "3.10.6"
            java_v = "17"
        else:
            # assume Dart 2.x legacy project -> use Flutter 3.7 (Dart 2.x)
            flutter_v = "3.7.12"
            java_v = "11"
    print("FLUTTER_VERSION=" + flutter_v)
    print("JAVA_VERSION=" + java_v)
PY
            # export values to GITHUB_ENV
            cat /tmp/flutter_choice.env >> $GITHUB_ENV
            cat /tmp/flutter_choice.env
          else
            echo "PROJECT_ROOT not set, using defaults"
            echo "FLUTTER_VERSION=3.10.6" >> $GITHUB_ENV
            echo "JAVA_VERSION=17" >> $GITHUB_ENV
          fi

      - name: Setup Java (chosen version)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK commandline tools & platform-tools
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget lib32stdc++6 lib32z1
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d cmdline
          mkdir -p cmdline-tools/latest
          mv cmdline cmdline-tools/latest/cmdline || true
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline/bin:$PATH
          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" "build-tools;33.0.2" || true
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

      - name: Setup Flutter (selected version)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Cache pub, gradle and Flutter cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ env.GRADLE_USER_HOME }}
            ~/.flutter/bin/cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}-${{ github.event.client_payload.request_id }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Preflight - flutter doctor & pub get
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          flutter --version
          flutter doctor -v || true
          # For legacy Dart2 projects we must ensure pub get uses compatible Flutter/Dart (we selected version above)
          flutter pub get --verbose || (echo "flutter pub get failed; printing pubspec and pubspec.lock for debug"; ls -la || true; exit 1)

      - name: Ensure gradlew executable (if present)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          if [ -f "./android/gradlew" ]; then chmod +x ./android/gradlew; fi

      - name: Enable Gradle local cache for performance
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mkdir -p ${{ env.GRADLE_USER_HOME }}
          echo "org.gradle.caching=true" >> ${{ env.GRADLE_USER_HOME }}/gradle.properties || true

      - name: Build APK (release, split-per-abi) with logs & retries
        working-directory: ${{ env.PROJECT_ROOT }}
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -euo pipefail
          LOGDIR=$RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}
          mkdir -p "$LOGDIR"
          MAX_ATTEMPTS=2
          attempt=0
          BUILD_OK=0
          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            attempt=$((attempt+1))
            echo "Build attempt #$attempt (Flutter $FLUTTER_VERSION)"
            flutter build apk --release --split-per-abi --no-shrink -v > "$LOGDIR/build-$attempt.log" 2>&1 || true
            if find build -name "*.apk" | grep -q .; then
              BUILD_OK=1
              break
            fi
            echo "Attempt $attempt failed, logs at $LOGDIR/build-$attempt.log"
            sleep 6
          done
          if [ "$BUILD_OK" -ne 1 ]; then
            echo "Build failed after $MAX_ATTEMPTS attempts. Archiving logs..."
            tar -czf $RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}.tgz -C "$LOGDIR" .
            echo "BUILD_TGZ=$RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}.tgz" >> $GITHUB_ENV
            exit 1
          fi
          FINAL_APK=$(find build -name "*.apk" | head -n 1 || true)
          if [ -z "$FINAL_APK" ]; then
            echo "No APK produced (unexpected)"
            exit 1
          fi
          echo "FINAL_APK_PATH=$FINAL_APK" >> $GITHUB_ENV
          echo "Found APK: $FINAL_APK"

      - name: Create GitHub Release with APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id }}
          files: ${{ env.PROJECT_ROOT }}/${{ env.FINAL_APK_PATH }}
          body: |
            âœ… Build Success
            - App: ${{ github.event.client_payload.display_name }}
            - Request ID: ${{ github.event.client_payload.request_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build logs on failure
        if: failure() && env.BUILD_TGZ != ''
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.event.client_payload.request_id }}
          path: ${{ env.BUILD_TGZ }}
