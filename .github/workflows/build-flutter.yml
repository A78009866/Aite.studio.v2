name: Aite Smart Logic Engine (stable)

on:
  repository_dispatch:
    types: [build-flutter]

permissions:
  contents: write

jobs:
  analyze_and_build:
    name: Analyze & Build
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ runner.temp }}/.gradle_cache
      FLUTTER_VERSION: '3.10.6'    # ثابت لتفادي مشكلات التقييم أثناء التنفيذ
      ANDROID_COMPILE_SDK: '33'

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python (for potential parsing if needed)
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml || true

      - name: Download & extract uploaded ZIP
        run: |
          mkdir -p temp_zip
          echo "Downloading project zip: ${{ github.event.client_payload.zip_url }}"
          curl -sL "${{ github.event.client_payload.zip_url }}" -o project.zip
          unzip -q project.zip -d temp_zip
          REAL_ROOT=$(find temp_zip -name "pubspec.yaml" -exec dirname {} + | head -n 1 || true)
          if [ -z "$REAL_ROOT" ]; then
            echo "ERROR_NO_PUBSPEC=true" >> $GITHUB_ENV
          else
            echo "PROJECT_ROOT=$REAL_ROOT" >> $GITHUB_ENV
          fi

      - name: Fail early if no pubspec found
        if: env.ERROR_NO_PUBSPEC == 'true'
        run: |
          echo "No Flutter project (pubspec.yaml) found in uploaded zip."
          exit 1

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK commandline tools & platform-tools
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget lib32stdc++6 lib32z1
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d cmdline
          mkdir -p cmdline-tools/latest
          mv cmdline cmdline-tools/latest/cmdline || true
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/cmdline/bin:$PATH
          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" "build-tools;33.0.2" || true
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Cache pub, gradle and Flutter cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ env.GRADLE_USER_HOME }}
            ~/.flutter/bin/cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}-${{ github.event.client_payload.request_id }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Preflight - flutter doctor & pub get
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          flutter --version
          flutter doctor -v || true
          flutter pub get --verbose

      - name: Ensure gradlew executable (if present)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          if [ -f "./android/gradlew" ]; then chmod +x ./android/gradlew; fi

      - name: Enable Gradle local cache for performance
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mkdir -p ${{ env.GRADLE_USER_HOME }}
          echo "org.gradle.caching=true" >> ${{ env.GRADLE_USER_HOME }}/gradle.properties || true

      - name: Build APK (release, split-per-abi) with logs & retries
        working-directory: ${{ env.PROJECT_ROOT }}
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -euo pipefail
          LOGDIR=$RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}
          mkdir -p "$LOGDIR"
          MAX_ATTEMPTS=2
          attempt=0
          BUILD_OK=0
          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            attempt=$((attempt+1))
            echo "Build attempt #$attempt"
            flutter build apk --release --split-per-abi --no-shrink -v > "$LOGDIR/build-$attempt.log" 2>&1 || true
            if find build -name "*.apk" | grep -q .; then
              BUILD_OK=1
              break
            fi
            echo "Attempt $attempt failed, logs at $LOGDIR/build-$attempt.log"
            sleep 6
          done
          if [ "$BUILD_OK" -ne 1 ]; then
            echo "Build failed after $MAX_ATTEMPTS attempts. Archiving logs..."
            tar -czf $RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}.tgz -C "$LOGDIR" .
            echo "BUILD_TGZ=$RUNNER_TEMP/build_logs_${{ github.event.client_payload.request_id }}.tgz" >> $GITHUB_ENV
            exit 1
          fi
          FINAL_APK=$(find build -name "*.apk" | head -n 1 || true)
          if [ -z "$FINAL_APK" ]; then
            echo "No APK produced (unexpected)"
            exit 1
          fi
          echo "FINAL_APK_PATH=$FINAL_APK" >> $GITHUB_ENV
          echo "Found APK: $FINAL_APK"

      - name: Create GitHub Release with APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id }}
          files: ${{ env.PROJECT_ROOT }}/${{ env.FINAL_APK_PATH }}
          body: |
            ✅ Build Success
            - App: ${{ github.event.client_payload.display_name }}
            - Request ID: ${{ github.event.client_payload.request_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.event.client_payload.request_id }}
          path: ${{ env.BUILD_TGZ }}
