# =============================================================================
# Aite.studio - Web to APK Builder (Final Fix: Icon & Signing)
# Fixed: Removed adaptive icons to force custom icon.
# Fixed: Added ZipAlign & ApkSigner to fix "Corrupted Package" error.
# =============================================================================

name: Build Web to APK

on:
  repository_dispatch:
    types: [build-web2apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        default: 'MyApp'
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.example.app'
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Build ID'
        required: false
        default: 'manual'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clear Gradle Cache
        run: |
          rm -rf ~/.gradle/caches
          rm -rf ~/.gradle/wrapper

      - name: Download Project
        run: |
          mkdir -p project && cd project
          curl -sL "${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}" -o project.zip
          unzip -q project.zip
          rm project.zip

      - name: Detect Entry Point
        id: detect
        run: |
          cd project
          shopt -s extglob
          
          # Smart detection logic
          if [ -f "index.html" ]; then
            echo "âœ… Flat structure"
            mkdir -p www
            cp -r !(www) www/ 2>/dev/null || cp -r ./* www/
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
             echo "âœ… dist folder"
             mkdir -p www && cp -r dist/* www/
          elif [ -d "build" ] && [ -f "build/index.html" ]; then
             echo "âœ… build folder"
             mkdir -p www && cp -r build/* www/
          else
             # Fallback: search for index.html
             ENTRY=$(find . -name "index.html" | head -1)
             if [ -n "$ENTRY" ]; then
                DIR=$(dirname "$ENTRY")
                echo "âœ… Found in: $DIR"
                mkdir -p www
                cp -r "$DIR"/* www/
             else
                echo "âŒ No index.html found"
                exit 1
             fi
          fi

      - name: Download Icon
        run: |
          mkdir -p project/icon
          curl -sL "${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}" -o project/icon/icon.png

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build APK
        run: |
          mkdir -p build && cd build
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android

          cat > capacitor.config.json <<EOF
          {
            "appId": "${{ github.event.client_payload.package_name || github.event.inputs.package_name }}",
            "appName": "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}",
            "webDir": "www",
            "bundledWebRuntime": false
          }
          EOF

          cp -r ../project/www ./
          npx cap add android
          npx cap sync

          # === FIX: FORCE ICON UPDATE ===
          echo "ðŸŽ¨ Fixing App Icon..."
          if [ -f "../project/icon/icon.png" ]; then
            # 1. Delete Adaptive Icon XML (Important! This forces Android to use the PNGs)
            rm -rf android/app/src/main/res/mipmap-anydpi-v26
            
            # 2. Copy PNG to all folders as both square and round icon
            for dir in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
              mkdir -p android/app/src/main/res/mipmap-${dir}
              cp ../project/icon/icon.png android/app/src/main/res/mipmap-${dir}/ic_launcher.png
              cp ../project/icon/icon.png android/app/src/main/res/mipmap-${dir}/ic_launcher_round.png
            done
          fi

          # Build
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon

      - name: Sign & Align APK (Fix Corrupt Package)
        run: |
          cd build/android/app/build/outputs/apk/debug
          
          # Define tools paths
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -r | head -n 1)
          ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          echo "ðŸ›  Using Build Tools: $BUILD_TOOLS_VERSION"

          # 1. ZipAlign (Required for modern Android)
          echo "ðŸ“ Aligning APK..."
          $ZIPALIGN -v -p 4 app-debug.apk app-aligned.apk

          # 2. Generate Key
          keytool -genkey -v -keystore release-key.jks -alias myalias -keyalg RSA -keysize 2048 -validity 10000 -storepass 123456 -keypass 123456 -dname "CN=App, OU=App, O=App, L=City, S=State, C=US"

          # 3. Sign using ApkSigner (Supports V2/V3 signatures)
          echo "âœï¸ Signing APK..."
          $APKSIGNER sign --ks release-key.jks --ks-pass pass:123456 --out app-final.apk app-aligned.apk

          # Move to output
          cp app-final.apk ../../../../../../app.apk
          echo "âœ… APK Ready!"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id || github.event.inputs.request_id }}
          name: "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          files: app.apk
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
