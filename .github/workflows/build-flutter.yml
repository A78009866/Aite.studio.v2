# .github/workflows/smart-flutter-build.yml
name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name (com.example.app)'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      flutter_version:
        description: 'Flutter Version (auto/stable/beta/3.x.x)'
        default: 'auto'
        required: false
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false
      enable_obfuscation:
        description: 'Enable Obfuscation'
        default: 'true'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  FLUTTER_VERSION_INPUT: ${{ github.event.client_payload.flutter_version || github.event.inputs.flutter_version || 'auto' }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ðŸ”§ Setup Environment
        run: |
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "Starting build for: $APP_NAME ($PACKAGE_NAME)"
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick xmlstarlet jq

      - name: ðŸ“¥ Download & Extract Project
        run: |
          echo "Downloading project from: $ZIP_URL"
          wget -q --show-progress -O project.zip "$ZIP_URL"
          
          # Verify download
          if [ ! -f project.zip ]; then
            echo "âŒ Failed to download project"
            exit 1
          fi
          
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          
          # Smart extraction: handle nested folders
          if [ "$(ls -A temp_extract | wc -l)" == "1" ]; then
            mv temp_extract/*/* $PROJECT_DIR/ 2>/dev/null || mv temp_extract/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          
          rm -rf temp_extract project.zip
          echo "âœ… Project extracted to: $PROJECT_DIR"
          ls -la $PROJECT_DIR

      - name: ðŸ” Detect Flutter Version (Smart Detection)
        id: detect_flutter
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          DETECTED_VERSION="stable"
          
          # Method 1: Check .fvm/fvm_config.json (FVM)
          if [ -f ".fvm/fvm_config.json" ]; then
            DETECTED_VERSION=$(cat .fvm/fvm_config.json | jq -r '.flutterSdkVersion // "stable"')
            echo "ðŸ“Œ Detected from FVM: $DETECTED_VERSION"
          
          # Method 2: Check pubspec.yaml for environment.sdk
          elif [ -f "pubspec.yaml" ]; then
            # Extract flutter constraint if exists
            FLUTTER_CONSTRAINT=$(cat pubspec.yaml | grep -A 5 "environment:" | grep "flutter:" | head -1)
            if [ ! -z "$FLUTTER_CONSTRAINT" ]; then
              # Extract version from constraint like ">=3.0.0 <4.0.0"
              VERSION=$(echo $FLUTTER_CONSTRAINT | grep -oP '\d+\.\d+\.\d+' | head -1)
              if [ ! -z "$VERSION" ]; then
                DETECTED_VERSION="$VERSION"
                echo "ðŸ“Œ Detected from pubspec: $DETECTED_VERSION"
              fi
            fi
            
            # Check for very old projects (pre-2.0)
            DART_SDK=$(cat pubspec.yaml | grep -A 3 "environment:" | grep "sdk:" | head -1)
            if echo "$DART_SDK" | grep -q '"2\.'; then
              if echo "$DART_SDK" | grep -q '"2\.[0-7]\.'; then
                DETECTED_VERSION="2.10.5" # Pre-null safety
                echo "ðŸ“Œ Legacy project detected (pre-2.8): $DETECTED_VERSION"
              else
                DETECTED_VERSION="2.10.5" # Null safety transition
                echo "ðŸ“Œ Legacy project detected (2.8-2.10): $DETECTED_VERSION"
              fi
            fi
          fi
          
          # Override if user specified specific version (not auto)
          if [ "$FLUTTER_VERSION_INPUT" != "auto" ]; then
            DETECTED_VERSION="$FLUTTER_VERSION_INPUT"
            echo "ðŸ“Œ User override: $DETECTED_VERSION"
          fi
          
          echo "FLUTTER_VERSION=$DETECTED_VERSION" >> $GITHUB_ENV
          echo "version=$DETECTED_VERSION" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ Setup Flutter (Adaptive)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.detect_flutter.outputs.version }}
          channel: stable
          cache: true

      - name: ðŸ©º Pre-build Diagnostics & Fixes
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ðŸ” Running diagnostics..."
          
          # Fix 1: Ensure android/local.properties exists
          mkdir -p android
          if [ ! -f "android/local.properties" ]; then
            echo "sdk.dir=/usr/local/lib/android/sdk" > android/local.properties
          fi
          
          # Fix 2: Fix common gradle issues (missing wrapper)
          if [ ! -d "android/gradle/wrapper" ]; then
            echo "âš ï¸ Missing Gradle wrapper, creating..."
            mkdir -p android/gradle/wrapper
            cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
            
            # Create gradlew if missing
            if [ ! -f "android/gradlew" ]; then
              curl -sL https://raw.githubusercontent.com/flutter/flutter/stable/packages/flutter_tools/gradle/gradlew -o android/gradlew
              chmod +x android/gradlew
            fi
          fi
          
          # Fix 3: Check and fix AndroidManifest.xml package name
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            CURRENT_PKG=$(grep -o 'package="[^"]*"' $MANIFEST | head -1 | cut -d'"' -f2)
            if [ "$CURRENT_PKG" != "$PACKAGE_NAME" ]; then
              echo "ðŸ“ Updating package name in AndroidManifest: $CURRENT_PKG -> $PACKAGE_NAME"
              sed -i "s/package=\"[^\"]*\"/package=\"$PACKAGE_NAME\"/" $MANIFEST
            fi
          fi
          
          # Fix 4: Update applicationId in build.gradle
          BUILD_GRADLE="android/app/build.gradle"
          if [ -f "$BUILD_GRADLE" ]; then
            # Check if kotlin or groovy
            if grep -q "applicationId" $BUILD_GRADLE; then
              sed -i "s/applicationId \".*\"/applicationId \"$PACKAGE_NAME\"/" $BUILD_GRADLE
              sed -i "s/applicationId '.*'/applicationId '$PACKAGE_NAME'/" $BUILD_GRADLE
            fi
          fi
          
          # Fix 5: Ensure minSdkVersion compatibility
          if [ -f "$BUILD_GRADLE" ]; then
            # Set minSdk to 21 if lower (for modern Flutter)
            sed -i 's/minSdkVersion .*/minSdkVersion 21/' $BUILD_GRADLE
            sed -i 's/minSdk .*/minSdk 21/' $BUILD_GRADLE
            sed -i "s/minSdkVersion flutter.minSdkVersion/minSdkVersion 21/" $BUILD_GRADLE
          fi
          
          # Fix 6: Create firebase config placeholder if missing (prevents build errors)
          if grep -r "google-services" android/app/build.gradle > /dev/null 2>&1; then
            if [ ! -f "android/app/google-services.json" ]; then
              echo "âš ï¸ Missing google-services.json, creating dummy..."
              echo '{"project_info":{"project_id":"dummy","project_number":"123"},"client":[]}' > android/app/google-services.json
            fi
          fi

      - name: ðŸŽ¨ Process Icon (Adaptive)
        run: |
          echo "ðŸ–¼ï¸ Processing app icon..."
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi
          
          # Download icon
          wget -q -O icon_original.png "$ICON_URL"
          
          # Generate all required sizes using ImageMagick
          convert icon_original.png -resize 48x48 $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert icon_original.png -resize 72x72 $PROJECT_DIR/android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert icon_original.png -resize 96x96 $PROJECT_DIR/android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert icon_original.png -resize 144x144 $PROJECT_DIR/android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert icon_original.png -resize 192x192 $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          # Generate adaptive icon foreground/background if supported
          if [ -d "$PROJECT_DIR/android/app/src/main/res/mipmap-anydpi-v26" ]; then
            convert icon_original.png -resize 108x108 $PROJECT_DIR/android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png
          fi
          
          # Update AndroidManifest to use correct icon name if needed
          # (Standard is ic_launcher which we just created)
          rm icon_original.png
          echo "âœ… Icons generated successfully"

      - name: ðŸ“¦ Get Dependencies (with retry logic)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Try to get dependencies with auto-fix
          flutter pub get || {
            echo "âš ï¸ First attempt failed, trying fixes..."
            
            # Fix: Upgrade dependencies if conflict
            flutter pub upgrade --major-versions || true
            
            # Fix: Clear pub cache if corrupted
            flutter pub cache repair || true
            
            # Retry
            flutter pub get
          }

      - name: ðŸ§¹ Code Generation (if needed)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Check for build_runner dependency
          if grep -q "build_runner:" pubspec.yaml; then
            echo "ðŸ”§ Running build_runner..."
            flutter pub run build_runner build --delete-conflicting-outputs || true
          fi
          
          # Check for freezed/json_serializable
          if grep -q "json_serializable:" pubspec.yaml || grep -q "freezed:" pubspec.yaml; then
            flutter pub run build_runner build --delete-conflicting-outputs || true
          fi

      - name: ðŸ”¨ Build APK (Intelligent Strategy)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          BUILD_ARGS="--$BUILD_MODE"
          
          # Add obfuscation for release builds if requested
          if [ "$BUILD_MODE" == "release" ] && [ "${{ github.event.client_payload.enable_obfuscation || github.event.inputs.enable_obfuscation }}" != "false" ]; then
            BUILD_ARGS="$BUILD_ARGS --obfuscate --split-debug-info=symbols/"
            mkdir -p symbols
          fi
          
          # Check if project supports --split-per-abi (reduces APK size)
          flutter build apk $BUILD_ARGS --split-per-abi || {
            echo "âš ï¸ Split per ABI failed, trying unified APK..."
            flutter build apk $BUILD_ARGS
          }
          
          # Find the generated APK
          APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            exit 1
          fi
          
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "âœ… Build successful: $APK_PATH"
          ls -lh $APK_PATH

      - name: ðŸ” Sign APK (if keystore provided)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ðŸ”‘ Signing APK..."
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
          
          # Sign the APK
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore android/app/keystore.jks \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            $APK_PATH ${{ secrets.KEY_ALIAS }}
          
          # Verify signature
          jarsigner -verify $APK_PATH
          echo "âœ… APK signed successfully"

      - name: ðŸ“¤ Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }} - Build ${{ env.BUILD_ID }}"
          body: |
            ðŸš€ Automated Flutter Build
            ðŸ“± App: ${{ env.APP_NAME }}
            ðŸ“¦ Package: ${{ env.PACKAGE }}
            ðŸ”§ Flutter Version: ${{ steps.detect_flutter.outputs.version }}
            ðŸ•’ Built at: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
          files: |
            ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/*.apk
            ${{ env.PROJECT_DIR }}/symbols/*  # Debug symbols if obfuscated
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf $PROJECT_DIR
          echo "ðŸ§¹ Cleanup completed"

      - name: ðŸ“Š Build Report
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ“Š BUILD REPORT"
          echo "=========================================="
          echo "Build ID: $BUILD_ID"
          echo "App Name: $APP_NAME"
          echo "Package: $PACKAGE_NAME"
          echo "Flutter Version: ${{ steps.detect_flutter.outputs.version }}"
          echo "Status: ${{ job.status }}"
          echo "=========================================="
