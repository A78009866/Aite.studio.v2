name: Smart Flutter Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name (safe filename)'
        required: true
      display_name:
        description: 'Display Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Request ID'
        required: false
      flutter_version:
        description: 'Flutter Version'
        required: false
        default: '3.24.0'
      build_mode:
        description: 'Build Mode'
        required: false
        default: 'release'

env:
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  analyze:
    name: Analyze Project
    runs-on: ubuntu-latest
    outputs:
      flutter_version: ${{ steps.detect.outputs.flutter_version }}
      app_name: ${{ steps.vars.outputs.app_name }}
      package_name: ${{ steps.vars.outputs.package_name }}
      request_id: ${{ steps.vars.outputs.request_id }}
      icon_url: ${{ steps.vars.outputs.icon_url }}
      project_path: ${{ steps.detect.outputs.project_path }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "app_name=${{ github.event.client_payload.app_name }}" >> $GITHUB_OUTPUT
            echo "package_name=${{ github.event.client_payload.package_name }}" >> $GITHUB_OUTPUT
            echo "request_id=${{ github.event.client_payload.request_id }}" >> $GITHUB_OUTPUT
            echo "flutter_version=${{ github.event.client_payload.flutter_version || '3.24.0' }}" >> $GITHUB_OUTPUT
            echo "zip_url=${{ github.event.client_payload.zip_url }}" >> $GITHUB_OUTPUT
            echo "icon_url=${{ github.event.client_payload.icon_url }}" >> $GITHUB_OUTPUT
          else
            echo "app_name=${{ github.event.inputs.app_name }}" >> $GITHUB_OUTPUT
            echo "package_name=${{ github.event.inputs.package_name }}" >> $GITHUB_OUTPUT
            echo "request_id=${{ github.event.inputs.request_id || github.run_id }}" >> $GITHUB_OUTPUT
            echo "flutter_version=${{ github.event.inputs.flutter_version || '3.24.0' }}" >> $GITHUB_OUTPUT
            echo "zip_url=${{ github.event.inputs.zip_url }}" >> $GITHUB_OUTPUT
            echo "icon_url=${{ github.event.inputs.icon_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Download and Extract Project
        run: |
          mkdir -p project
          cd project
          curl -L -o project.zip "${{ steps.vars.outputs.zip_url }}"
          unzip -q project.zip
          rm project.zip
          
          # Find pubspec.yaml and get project directory
          PUBSPEC=$(find . -name "pubspec.yaml" -not -path "*/.*" | head -1)
          PROJECT_DIR=$(dirname "$PUBSPEC")
          PROJECT_DIR=$(realpath "$PROJECT_DIR" | sed 's|/home/runner/work/[^/]*/[^/]*/||')
          
          echo "PROJECT_PATH=$PROJECT_DIR" >> $GITHUB_ENV
          echo "project_path=$PROJECT_DIR" >> $GITHUB_OUTPUT
          
          # Detect Flutter version from pubspec.yaml
          cd "$PROJECT_DIR"
          CURRENT_SDK=$(grep "sdk:" pubspec.yaml | grep -o '[0-9]*\.[0-9]*\.[0-9]*' | head -1 || echo "3.24.0")
          
          FLUTTER_VERSION="${{ steps.vars.outputs.flutter_version }}"
          if [ "$FLUTTER_VERSION" == "stable" ] || [ "$FLUTTER_VERSION" == "beta" ] || [ "$FLUTTER_VERSION" == "dev" ]; then
            FLUTTER_VERSION="3.24.0"
          fi
          
          echo "flutter_version=$FLUTTER_VERSION" >> $GITHUB_OUTPUT

      - name: Upload Project Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-project-${{ steps.vars.outputs.request_id }}
          path: project/
          retention-days: 1

  build:
    name: Build APK
    needs: analyze
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ needs.analyze.outputs.flutter_version }}
          cache: true

      - name: Download Project
        uses: actions/download-artifact@v4
        with:
          name: flutter-project-${{ needs.analyze.outputs.request_id }}
          path: project

      - name: Auto Fix Project
        working-directory: project/${{ needs.analyze.outputs.project_path }}
        run: |
          PKG_NAME="${{ needs.analyze.outputs.package_name }}"
          PKG_PATH=$(echo "$PKG_NAME" | tr '.' '/')
          
          # 1. Fix AndroidManifest.xml for V2 Embedding
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            sed -i 's/android:name="io.flutter.app.FlutterApplication"/android:name="${applicationName}"/' android/app/src/main/AndroidManifest.xml 2>/dev/null || true
            if ! grep -q "flutterEmbedding" android/app/src/main/AndroidManifest.xml 2>/dev/null; then
              sed -i '/<\/activity>/a\        <meta-data android:name="flutterEmbedding" android:value="2" />' android/app/src/main/AndroidManifest.xml 2>/dev/null || true
            fi
          fi
          
          # 2. Create MainActivity.kt for V2 Embedding
          mkdir -p "android/app/src/main/kotlin/$PKG_PATH"
          if [ ! -f "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt" ]; then
            echo "package $PKG_NAME" > "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "import io.flutter.embedding.android.FlutterActivity" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
            echo "class MainActivity: FlutterActivity()" >> "android/app/src/main/kotlin/$PKG_PATH/MainActivity.kt"
          fi
          find android -name "MainActivity.java" -delete 2>/dev/null || true
          
          # 3. Update package name
          sed -i "s/applicationId \".*\"/applicationId \"$PKG_NAME\"/" android/app/build.gradle 2>/dev/null || true
          
          # 4. Setup icons
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-mdpi
          curl -L -o icon.png "${{ needs.analyze.outputs.icon_url }}" 2>/dev/null && \
          cp icon.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png 2>/dev/null || true && \
          cp icon.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png 2>/dev/null || true && \
          cp icon.png android/app/src/main/res/mipmap-xhdpi/ic_launcher.png 2>/dev/null || true && \
          cp icon.png android/app/src/main/res/mipmap-hdpi/ic_launcher.png 2>/dev/null || true && \
          cp icon.png android/app/src/main/res/mipmap-mdpi/ic_launcher.png 2>/dev/null || true
          
          # 5. Fix pubspec.yaml - Smart SDK version adjustment
          rm -f pubspec.lock
          
          # Get current SDK constraint
          CURRENT_SDK_LINE=$(grep -A 1 "^environment:" pubspec.yaml | grep "sdk:" || echo "")
          echo "Current SDK: $CURRENT_SDK_LINE"
          
          # Extract version numbers
          CURRENT_MIN=$(echo "$CURRENT_SDK_LINE" | grep -o '>=\?[0-9]*\.[0-9]*' | grep -o '[0-9]*\.[0-9]*' | head -1 || echo "2.12.0")
          
          # If current SDK requires Dart > 3.5.0, downgrade to compatible version
          if [ -n "$CURRENT_MIN" ]; then
            MAJOR=$(echo "$CURRENT_MIN" | cut -d. -f1)
            MINOR=$(echo "$CURRENT_MIN" | cut -d. -f2)
            
            # If requires Dart 3.9+, use 3.0.0 instead (compatible with Flutter 3.24)
            if [ "$MAJOR" -ge 3 ] && [ "$MINOR" -ge 9 ]; then
              echo "Downgrading SDK requirement from $CURRENT_MIN to 3.0.0"
              sed -i "s/sdk: .*/sdk: '>=3.0.0 <4.0.0'/" pubspec.yaml
            elif [ "$MAJOR" -lt 2 ] || ([ "$MAJOR" -eq 2 ] && [ "$MINOR" -lt 17 ]); then
              # If too old, upgrade to 2.17 for super-parameters support
              echo "Upgrading SDK requirement from $CURRENT_MIN to 2.17.0"
              sed -i "s/sdk: .*/sdk: '>=2.17.0 <4.0.0'/" pubspec.yaml
            fi
          fi
          
          # Ensure environment section exists
          if ! grep -q "^environment:" pubspec.yaml; then
            echo "" >> pubspec.yaml
            echo "environment:" >> pubspec.yaml
            echo "  sdk: '>=2.17.0 <4.0.0'" >> pubspec.yaml
          fi
          
          echo "Final pubspec.yaml:"
          cat pubspec.yaml

      - name: Build APK
        working-directory: project/${{ needs.analyze.outputs.project_path }}
        run: |
          export FLUTTER_SUPPRESS_ANALYTICS=true
          
          # Try multiple build strategies
          BUILD_SUCCESS=false
          
          # Strategy 1: Normal build
          echo "Trying normal build..."
          flutter pub get 2>&1 && \
          flutter build apk --release \
            --target-platform=android-arm64,android-arm,android-x64 \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }} 2>&1 && BUILD_SUCCESS=true
          
          # Strategy 2: If failed, try with dependency override
          if [ "$BUILD_SUCCESS" != "true" ]; then
            echo "Trying with dependency override..."
            rm -f pubspec.lock
            flutter pub get --no-example 2>&1 && \
            flutter build apk --release \
              --target-platform=android-arm64,android-arm,android-x64 \
              --build-name=1.0.0 \
              --build-number=${{ github.run_number }} 2>&1 && BUILD_SUCCESS=true
          fi
          
          # Strategy 3: If still failed, try without tree shake
          if [ "$BUILD_SUCCESS" != "true" ]; then
            echo "Trying without tree shake..."
            flutter build apk --release \
              --target-platform=android-arm64,android-arm,android-x64 \
              --build-name=1.0.0 \
              --build-number=${{ github.run_number }} \
              --no-tree-shake-icons 2>&1 && BUILD_SUCCESS=true
          fi
          
          # Strategy 4: Last resort - debug build
          if [ "$BUILD_SUCCESS" != "true" ]; then
            echo "Trying debug build as last resort..."
            flutter build apk --debug \
              --target-platform=android-arm64,android-arm,android-x64 2>&1 && BUILD_SUCCESS=true
          fi
          
          if [ "$BUILD_SUCCESS" != "true" ]; then
            echo "All build strategies failed"
            exit 1
          fi
          
          echo "Build successful!"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ needs.analyze.outputs.request_id }}
          path: project/${{ needs.analyze.outputs.project_path }}/build/app/outputs/flutter-apk/*.apk
          retention-days: 7
          if-no-files-found: ignore

  release:
    name: Create Release
    needs: [analyze, build]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: apk-${{ needs.analyze.outputs.request_id }}
          path: release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.analyze.outputs.request_id }}
          name: "${{ needs.analyze.outputs.app_name }} - Build ${{ github.run_number }}"
          files: release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
