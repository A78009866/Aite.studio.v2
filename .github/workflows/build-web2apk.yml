# =============================================================================
# Aite.studio - Web to APK Builder (Intelligent v2.2 - Java 17 Stable)
# Fixed: Java 21 incompatibility with Gradle - Reverted to Java 17 LTS
# =============================================================================

name: Build Web to APK

on:
  repository_dispatch:
    types: [build-web2apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        default: 'MyApp'
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.example.app'
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      request_id:
        description: 'Build ID'
        required: false
        default: 'manual'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Download Project
        run: |
          mkdir -p project && cd project
          echo "ðŸ“¥ Downloading project archive..."
          curl -sL "${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}" -o project.zip

          echo "ðŸ“¦ Extracting archive..."
          unzip -q project.zip
          rm project.zip

          echo "ðŸ“‚ Initial structure:"
          ls -la

      - name: Intelligent Project Structure Detection
        id: detect
        run: |
          cd project

          # Enable extended globbing for exclude patterns
          shopt -s extglob

          echo "ðŸ” Analyzing project structure..."

          # Function to find the best HTML entry point
          find_entry_point() {
            local search_dirs=("$@")

            # Priority 1: index.html in root or direct subdirs
            for dir in "${search_dirs[@]}"; do
              if [ -f "$dir/index.html" ]; then
                echo "$dir/index.html"
                return 0
              fi
              if [ -f "$dir/index.htm" ]; then
                echo "$dir/index.htm"
                return 0
              fi
            done

            # Priority 2: Any HTML file with "index" in name
            for dir in "${search_dirs[@]}"; do
              local index_file=$(find "$dir" -maxdepth 1 -type f \( -iname "*index*.html" -o -iname "*index*.htm" -o -iname "*home*.html" -o -iname "*main*.html" \) 2>/dev/null | head -1)
              if [ -n "$index_file" ]; then
                echo "$index_file"
                return 0
              fi
            done

            # Priority 3: First HTML file found
            for dir in "${search_dirs[@]}"; do
              local first_html=$(find "$dir" -maxdepth 2 -type f \( -iname "*.html" -o -iname "*.htm" \) 2>/dev/null | head -1)
              if [ -n "$first_html" ]; then
                echo "$first_html"
                return 0
              fi
            done

            return 1
          }

          # Detect project structure type
          HTML_COUNT=$(find . -type f \( -name "*.html" -o -name "*.htm" \) 2>/dev/null | wc -l)
          SUBDIRS=$(find . -maxdepth 1 -type d 2>/dev/null | wc -l)

          echo "Found $HTML_COUNT HTML files in $SUBDIRS directories"

          # Case 1: Single HTML file at root
          if [ "$HTML_COUNT" -eq 1 ] && ls *.html 1>/dev/null 2>&1; then
            echo "âœ… Detected: Single HTML file at root"
            mkdir -p www
            cp -r !(www) www/ 2>/dev/null || cp -r ./* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT

          # Case 2: Proper www/ or dist/ folder already exists
          elif [ -d "www" ] && [ -f "www/index.html" ]; then
            echo "âœ… Detected: Pre-built www folder"
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT

          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "âœ… Detected: dist folder (common for build tools)"
            mkdir -p www
            cp -r dist/* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT

          elif [ -d "build" ] && [ -f "build/index.html" ]; then
            echo "âœ… Detected: build folder"
            mkdir -p www
            cp -r build/* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT

          # Case 3: Nested single folder (user zipped a folder instead of contents)
          elif [ "$SUBDIRS" -eq 2 ] && [ -z "$(ls *.html 2>/dev/null)" ]; then
            # Only one subdir, no files at root
            NESTED_DIR=$(find . -maxdepth 1 -type d ! -path . | head -1)
            echo "ðŸ“ Detected nested structure in: $NESTED_DIR"

            if [ -f "$NESTED_DIR/index.html" ]; then
              mkdir -p www
              cp -r "$NESTED_DIR"/* www/
              echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
            else
              # Find entry point in nested dir
              ENTRY=$(find_entry_point "$NESTED_DIR")
              if [ -n "$ENTRY" ]; then
                mkdir -p www
                cp -r "$NESTED_DIR"/* www/
                # Rename entry to index.html if needed
                if [ "$(basename "$ENTRY")" != "index.html" ]; then
                  mv "www/$(basename "$ENTRY")" www/index.html 2>/dev/null || true
                fi
                echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
              fi
            fi

          # Case 4: Multiple files at root (flat structure)
          elif [ -f "index.html" ]; then
            echo "âœ… Detected: Flat structure with index.html"
            mkdir -p www
            cp -r !(www) www/ 2>/dev/null || cp -r ./* www/
            echo "entry_point=www/index.html" >> $GITHUB_OUTPUT

          # Case 5: No index.html, find best candidate
          else
            echo "ðŸ” Searching for entry point..."
            ENTRY=$(find_entry_point ".")

            if [ -n "$ENTRY" ]; then
              echo "âœ… Found entry point: $ENTRY"
              mkdir -p www

              # Copy all files maintaining structure (exclude www)
              cp -r !(www) www/ 2>/dev/null || cp -r ./* www/ 2>/dev/null

              # Ensure we have index.html as entry point
              ENTRY_NAME=$(basename "$ENTRY")
              if [ "$ENTRY_NAME" != "index.html" ]; then
                cd www
                # Create index.html that redirects or copies content
                if [ -f "$ENTRY_NAME" ]; then
                  # If entry is at root of www, rename it
                  mv "$ENTRY_NAME" index.html 2>/dev/null || cp "$ENTRY_NAME" index.html
                else
                  # Search for it in subdirs
                  FOUND_ENTRY=$(find . -name "$ENTRY_NAME" -type f 2>/dev/null | head -1)
                  if [ -n "$FOUND_ENTRY" ]; then
                    cp "$FOUND_ENTRY" index.html
                  fi
                fi
                cd ..
              fi
              echo "entry_point=www/index.html" >> $GITHUB_OUTPUT
            else
              echo "âŒ No HTML files found!"
              exit 1
            fi
          fi

          echo "ðŸ“‚ Final www structure:"
          ls -la www/
          echo ""
          echo "ðŸ“„ HTML files in www:"
          find www/ -name "*.html" -o -name "*.htm" 2>/dev/null || echo "No HTML files found!"

      - name: Download Icon
        run: |
          mkdir -p project/icon
          echo "ðŸŽ¨ Downloading icon..."
          curl -sL "${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}" -o project/icon/icon.png

          if [ -f "project/icon/icon.png" ]; then
            echo "âœ… Icon downloaded"
          else
            echo "âš ï¸ Using default icon"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java 17 (Stable LTS)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      - name: Build APK with Capacitor
        run: |
          echo "ðŸ—ï¸ Setting up Capacitor project..."
          mkdir -p build && cd build

          # Initialize project
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android

          # Create capacitor config
          cat > capacitor.config.json <<EOF
          {
            "appId": "${{ github.event.client_payload.package_name || github.event.inputs.package_name }}",
            "appName": "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}",
            "webDir": "www",
            "bundledWebRuntime": false,
            "server": {
              "androidScheme": "https"
            }
          }
          EOF

          # Copy web assets
          echo "ðŸ“‚ Copying web assets..."
          cp -r ../project/www ./

          # Add Android platform
          echo "ðŸ¤– Adding Android platform..."
          npx cap add android

          # Update Gradle wrapper to support Java 17 (if needed)
          echo "ðŸ”§ Updating Gradle wrapper..."
          cd android
          ./gradlew wrapper --gradle-version 8.4 --distribution-type bin 2>/dev/null || true
          cd ..

          # Sync assets
          echo "ðŸ”„ Syncing..."
          npx cap sync

          # Setup icon
          if [ -f "../project/icon/icon.png" ]; then
            echo "ðŸŽ¨ Setting up icon..."
            mkdir -p android/app/src/main/res/mipmap-{hdpi,mdpi,xhdpi,xxhdpi,xxxhdpi}

            if command -v convert &> /dev/null; then
              convert ../project/icon/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
              convert ../project/icon/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
              convert ../project/icon/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
              convert ../project/icon/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
              convert ../project/icon/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            else
              for dir in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
                cp ../project/icon/icon.png android/app/src/main/res/mipmap-${dir}/ic_launcher.png
              done
            fi
          fi

          # Build
          echo "ðŸ”¨ Building APK..."
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace

          echo "âœ… Build complete!"

      - name: Sign APK
        run: |
          cd build/android
          APK=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)

          if [ -z "$APK" ]; then
            echo "âŒ No APK found!"
            exit 1
          fi

          echo "ðŸ” Signing: $(basename $APK)"

          # Create keystore
          keytool -genkey -v -keystore key.jks -alias key -storepass 123456 -keypass 123456             -keyalg RSA -validity 10000 -dname "CN=Android,O=Android,C=US" 2>/dev/null

          # Sign
          if command -v apksigner &> /dev/null; then
            apksigner sign --ks key.jks --ks-pass pass:123456 --key-pass pass:123456 "$APK"
          else
            jarsigner -keystore key.jks -storepass 123456 -keypass 123456               -sigalg SHA256withRSA -digestalg SHA-256 "$APK" key
          fi

          cp "$APK" ../../app.apk
          echo "âœ… Signed: app.apk"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.event.client_payload.request_id || github.event.inputs.request_id }}
          name: "${{ github.event.client_payload.app_name || github.event.inputs.app_name }}"
          files: app.apk
          generate_release_notes: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
