name: Smart Flutter Cloud Build

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name (com.example.app)'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true
      flutter_version:
        description: 'Flutter Version (auto/stable/3.x.x)'
        default: 'auto'
        required: false
      build_mode:
        description: 'Build Mode'
        default: 'release'
        required: false

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  FLUTTER_VERSION_INPUT: ${{ github.event.client_payload.flutter_version || github.event.inputs.flutter_version || 'auto' }}
  BUILD_MODE: ${{ github.event.client_payload.build_mode || github.event.inputs.build_mode || 'release' }}

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Setup Environment
        run: |
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "Starting build for: $APP_NAME ($PACKAGE_NAME)"
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick xmlstarlet jq

      - name: Download and Extract Project
        run: |
          echo "Downloading project from: $ZIP_URL"
          wget -q --show-progress -O project.zip "$ZIP_URL"
          
          if [ ! -f project.zip ]; then
            echo "Failed to download project"
            exit 1
          fi
          
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          
          if [ "$(ls -A temp_extract | wc -l)" == "1" ]; then
            mv temp_extract/*/* $PROJECT_DIR/ 2>/dev/null || mv temp_extract/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          
          rm -rf temp_extract project.zip
          echo "Project extracted to: $PROJECT_DIR"
          ls -la $PROJECT_DIR

      - name: Detect Flutter Version
        id: detect_flutter
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          DETECTED_VERSION="stable"
          
          if [ -f ".fvm/fvm_config.json" ]; then
            DETECTED_VERSION=$(cat .fvm/fvm_config.json | jq -r '.flutterSdkVersion // "stable"')
            echo "Detected from FVM: $DETECTED_VERSION"
          
          elif [ -f "pubspec.yaml" ]; then
            FLUTTER_CONSTRAINT=$(cat pubspec.yaml | grep -A 5 "environment:" | grep "flutter:" | head -1)
            if [ ! -z "$FLUTTER_CONSTRAINT" ]; then
              VERSION=$(echo $FLUTTER_CONSTRAINT | grep -oP '\d+\.\d+\.\d+' | head -1)
              if [ ! -z "$VERSION" ]; then
                DETECTED_VERSION="$VERSION"
                echo "Detected from pubspec: $DETECTED_VERSION"
              fi
            fi
            
            DART_SDK=$(cat pubspec.yaml | grep -A 3 "environment:" | grep "sdk:" | head -1)
            if echo "$DART_SDK" | grep -q '"2\.'; then
              if echo "$DART_SDK" | grep -q '"2\.[0-7]\.'; then
                DETECTED_VERSION="2.10.5"
                echo "Legacy project detected (pre-2.8): $DETECTED_VERSION"
              else
                DETECTED_VERSION="2.10.5"
                echo "Legacy project detected (2.8-2.10): $DETECTED_VERSION"
              fi
            fi
          fi
          
          if [ "$FLUTTER_VERSION_INPUT" != "auto" ]; then
            DETECTED_VERSION="$FLUTTER_VERSION_INPUT"
            echo "User override: $DETECTED_VERSION"
          fi
          
          echo "FLUTTER_VERSION=$DETECTED_VERSION" >> $GITHUB_ENV
          echo "version=$DETECTED_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ contains(steps.detect_flutter.outputs.version, '.') && steps.detect_flutter.outputs.version || '' }}
          channel: ${{ !contains(steps.detect_flutter.outputs.version, '.') && steps.detect_flutter.outputs.version || 'stable' }}

      - name: Pre-build Diagnostics and Fixes
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "Running diagnostics..."
          
          mkdir -p android
          if [ ! -f "android/local.properties" ]; then
            echo "sdk.dir=/usr/local/lib/android/sdk" > android/local.properties
          fi
          
          if [ ! -d "android/gradle/wrapper" ]; then
            echo "Missing Gradle wrapper, creating..."
            mkdir -p android/gradle/wrapper
            cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
            
            if [ ! -f "android/gradlew" ]; then
              curl -sL https://raw.githubusercontent.com/flutter/flutter/stable/packages/flutter_tools/gradle/gradlew -o android/gradlew
              chmod +x android/gradlew
            fi
          fi

      - name: Update App Name and Package
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "Updating App Name to: $APP_NAME"
          echo "Updating Package to: $PACKAGE_NAME"
          
          # Create or update strings.xml with app_name
          mkdir -p android/app/src/main/res/values
          cat > android/app/src/main/res/values/strings.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${APP_NAME}</string>
          </resources>
          EOF
          
          # Update AndroidManifest.xml to use @string/app_name
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            # Replace any existing label with @string/app_name
            sed -i 's|android:label="[^"]*"|android:label="@string/app_name"|g' $MANIFEST
            # Also update package name
            sed -i "s|package=\"[^\"]*\"|package=\"$PACKAGE_NAME\"|g" $MANIFEST
          fi
          
          # Update build.gradle applicationId
          BUILD_GRADLE="android/app/build.gradle"
          if [ -f "$BUILD_GRADLE" ]; then
            sed -i "s|applicationId \".*\"|applicationId \"$PACKAGE_NAME\"|" $BUILD_GRADLE
            sed -i "s|applicationId '.*'|applicationId '$PACKAGE_NAME'|" $BUILD_GRADLE
            sed -i 's|minSdkVersion .*|minSdkVersion 21|' $BUILD_GRADLE
            sed -i 's|minSdk .*|minSdk 21|' $BUILD_GRADLE
            sed -i "s|minSdkVersion flutter.minSdkVersion|minSdkVersion 21|" $BUILD_GRADLE
          fi
          
          SETTINGS_GRADLE="android/settings.gradle"
          if [ -f "$SETTINGS_GRADLE" ]; then
            sed -i 's|org.jetbrains.kotlin.android"] version "[^"]*"|org.jetbrains.kotlin.android"] version "2.1.0"|' $SETTINGS_GRADLE
            sed -i "s|id \"org.jetbrains.kotlin.android\" version \".*\"|id \"org.jetbrains.kotlin.android\" version \"2.1.0\"|" $SETTINGS_GRADLE
          fi
          
          TOP_BUILD_GRADLE="android/build.gradle"
          if [ -f "$TOP_BUILD_GRADLE" ]; then
            sed -i 's|ext.kotlin_version = .*|ext.kotlin_version = "2.1.0"|' $TOP_BUILD_GRADLE
          fi

      - name: Setup Signing
        working-directory: ${{ env.PROJECT_DIR }}/android/app
        run: |
          echo "Setting up signing configuration..."
          
          if [ ! -f "debug.keystore" ]; then
            echo "Creating debug keystore..."
            keytool -genkey -v \
              -keystore debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi
          
          mkdir -p signing
          
          cat > signing/signing.gradle << 'EOF'
          signingConfigs {
              release {
                  storeFile file("../debug.keystore")
                  storePassword "android"
                  keyAlias "androiddebugkey"
                  keyPassword "android"
              }
          }
          buildTypes {
              release {
                  signingConfig signingConfigs.release
                  minifyEnabled true
                  shrinkResources true
                  proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
              }
          }
          EOF

      - name: Fix Firebase Configuration
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Check if main.dart imports firebase_options.dart
          if grep -q "firebase_options.dart" lib/main.dart 2>/dev/null; then
            if [ ! -f "lib/firebase_options.dart" ]; then
              echo "Creating dummy firebase_options.dart..."
              mkdir -p lib
              cat > lib/firebase_options.dart << 'EOF'
          // Dummy Firebase configuration for build purposes
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              return const FirebaseOptions(
                apiKey: 'AIzaSyDummy-Key-For-Build',
                appId: '1:123456789:android:dummy',
                messagingSenderId: '123456789',
                projectId: 'dummy-project',
                storageBucket: 'dummy-project.appspot.com',
              );
            }
          }
          EOF
            fi
          fi
          
          # Disable Crashlytics if google-services exists
          if grep -r "google-services" android/app/build.gradle > /dev/null 2>&1; then
             echo "// Auto-injected: Disable Crashlytics upload for CI build" >> android/app/build.gradle
             echo "tasks.whenTaskAdded { task ->" >> android/app/build.gradle
             echo "    if (task.name.startsWith('uploadCrashlyticsMappingFile')) {" >> android/app/build.gradle
             echo "        task.enabled = false" >> android/app/build.gradle
             echo "    }" >> android/app/build.gradle
             echo "}" >> android/app/build.gradle
             
             # Create dummy google-services.json
             cat > android/app/google-services.json << EOF
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789012:android:dummy",
                  "android_client_info": {
                    "package_name": "$PACKAGE_NAME"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "AIzaSyDummyKeyForBuild"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF
          fi

      - name: Process Icon
        run: |
          echo "Processing app icon..."
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-hdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xhdpi
          mkdir -p $PROJECT_DIR/android/app/src/main/res/mipmap-xxhdpi
          
          wget -q -O icon_original.png "$ICON_URL"
          
          convert icon_original.png -resize 48x48 $PROJECT_DIR/android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert icon_original.png -resize 72x72 $PROJECT_DIR/android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert icon_original.png -resize 96x96 $PROJECT_DIR/android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert icon_original.png -resize 144x144 $PROJECT_DIR/android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert icon_original.png -resize 192x192 $PROJECT_DIR/android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          if [ -d "$PROJECT_DIR/android/app/src/main/res/mipmap-anydpi-v26" ]; then
            convert icon_original.png -resize 108x108 $PROJECT_DIR/android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png
          fi
          
          rm icon_original.png
          echo "Icons generated successfully"

      - name: Get Dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          flutter pub get || {
            echo "First attempt failed, trying fixes..."
            flutter pub upgrade --major-versions || true
            flutter pub cache repair || true
            flutter pub get
          }

      - name: Code Generation
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          if grep -q "build_runner:" pubspec.yaml; then
            echo "Running build_runner..."
            flutter pub run build_runner build --delete-conflicting-outputs || true
          fi
          
          if grep -q "json_serializable:" pubspec.yaml || grep -q "freezed:" pubspec.yaml; then
            flutter pub run build_runner build --delete-conflicting-outputs || true
          fi

      - name: Build Universal APK (Compatible with all devices)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "Building Universal APK (arm64-v8a + armeabi-v7a)..."
          
          # Build single APK containing both architectures (fat APK)
          # This ensures compatibility with both old (32-bit) and new (64-bit) phones
          flutter build apk --$BUILD_MODE \
            --target-platform=android-arm,android-arm64 \
            --obfuscate --split-debug-info=symbols/
          
          APK_DIR="build/app/outputs/flutter-apk"
          echo "Build complete. Listing outputs:"
          ls -lh $APK_DIR/
          
          # Rename to include app name for clarity
          mv $APK_DIR/app-$BUILD_MODE.apk $APK_DIR/${APP_NAME}-${BUILD_MODE}.apk
          
          echo "APK_DIR=$APK_DIR" >> $GITHUB_ENV
          echo "APK_FILE=${APP_NAME}-${BUILD_MODE}.apk" >> $GITHUB_ENV

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }} - Build ${{ env.BUILD_ID }}"
          body: |
            ðŸš€ **Aite.studio Automated Build**
            
            **App Name:** ${{ env.APP_NAME }}
            **Package:** ${{ env.PACKAGE_NAME }}
            **Build ID:** ${{ env.BUILD_ID }}
            **Flutter Version:** ${{ steps.detect_flutter.outputs.version }}
            **Compatibility:** Universal (ARM64 + ARMv7)
            **Size:** Optimized with obfuscation
            
            This APK works on all Android devices (32-bit and 64-bit).
          files: |
            ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/${{ env.APK_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Report
        if: always()
        run: |
          echo "=========================================="
          echo "BUILD REPORT"
          echo "=========================================="
          echo "Build ID: $BUILD_ID"
          echo "App Name: $APP_NAME"
          echo "Package: $PACKAGE_NAME"
          echo "Flutter Version: ${{ steps.detect_flutter.outputs.version }}"
          echo "Status: ${{ job.status }}"
          echo "Output: ${{ env.APK_FILE }}"
          echo "=========================================="

      - name: Cleanup
        if: always()
        run: |
          rm -rf $PROJECT_DIR
          echo "Cleanup completed"
