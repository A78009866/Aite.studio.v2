name: Smart Flutter Cloud Build (AI Powered)

on:
  repository_dispatch:
    types: [build-flutter]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      icon_url:
        description: 'Icon URL'
        required: true
      zip_url:
        description: 'Project ZIP URL'
        required: true

env:
  PROJECT_DIR: ${{ github.workspace }}/flutter_project
  BUILD_ID: ${{ github.event.client_payload.request_id || github.run_id }}
  APP_NAME: ${{ github.event.client_payload.app_name || github.event.inputs.app_name }}
  SAFE_NAME: ${{ github.event.client_payload.safe_name || 'app-release' }}
  PACKAGE_NAME: ${{ github.event.client_payload.package_name || github.event.inputs.package_name }}
  ICON_URL: ${{ github.event.client_payload.icon_url || github.event.inputs.icon_url }}
  ZIP_URL: ${{ github.event.client_payload.zip_url || github.event.inputs.zip_url }}
  # ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… gpt-4o Ø£Ùˆ gpt-3.5-turbo Ø£Ùˆ Ø£ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ù…ØªÙˆØ§ÙÙ‚
  AI_MODEL: "gpt-4o" 

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
    
    steps:
      - name: Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget unzip imagemagick sed curl

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Download Project
        run: |
          wget -q --show-progress -O project.zip "$ZIP_URL"
          mkdir -p $PROJECT_DIR
          unzip -q project.zip -d temp_extract
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø°ÙƒØ§Ø¡ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ Ø£Ùˆ ÙÙŠ Ø§Ù„Ø¬Ø°Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
          if [ "$(ls -A temp_extract | wc -l)" == "1" ] && [ -d "temp_extract/$(ls -A temp_extract)" ]; then
            mv temp_extract/*/* $PROJECT_DIR/
          else
            mv temp_extract/* $PROJECT_DIR/
          fi
          rm -rf temp_extract project.zip

      # --- 1. Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© ---
      - name: Basic Fixes & Config
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù key.properties
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=androiddebugkey" >> android/key.properties
          echo "storeFile=../debug.keystore" >> android/key.properties

          # 2. Ø¥Ù†Ø´Ø§Ø¡ Keystore
          cd android
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          cd ..

          # 3. Ø¥ØµÙ„Ø§Ø­ Google Services (ÙˆÙ‡Ù…ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯)
          if [ ! -f "android/app/google-services.json" ]; then
             echo '{"project_info":{"project_number":"0","project_id":"dummy","storage_bucket":"dummy"},"client":[{"client_info":{"mobilesdk_app_id":"1:0:android:0","android_client_info":{"package_name":"'"$PACKAGE_NAME"'"}},"api_key":[{"current_key":"dummy"}]}]}' > android/app/google-services.json
          fi

          # 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
          rm -rf android/app/src/main/res/mipmap-*
          wget -q -O icon.png "$ICON_URL"
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          convert icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          # (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø­Ø¬Ø§Ù… Ù‡Ù†Ø§)

          # 5. ØªØ­Ø¯ÙŠØ« Pubspec Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
          if [ -f "pubspec.yaml" ]; then
            sed -i 's/sdk: ">=2.0.[0-9].*"/sdk: ">=2.12.0 <4.0.0"/' pubspec.yaml || true
          fi

      # --- 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„Ù‰ ---
      - name: First Build Attempt
        id: build_1
        working-directory: ${{ env.PROJECT_DIR }}
        continue-on-error: true
        run: |
          flutter pub get
          flutter build apk --release --no-android-gradle-daemon > build_log.txt 2>&1
        
      # --- 3. Ø§Ù„ØªØ¯Ø®Ù„ Ø§Ù„Ø°ÙƒÙŠ (AI Auto-Fix) ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„ ---
      - name: AI Auto-Fix (If Failed)
        if: steps.build_1.outcome == 'failure'
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          OPENAI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          echo "âŒ Build Failed. Starting AI Repair..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
          cat > ai_repair.js << 'EOF'
          const fs = require('fs');
          const https = require('https');

          const API_KEY = process.env.OPENAI_API_KEY;
          if (!API_KEY) { console.error("No API Key found!"); process.exit(1); }

          async function callAI(prompt) {
            const data = JSON.stringify({
              model: "gpt-4o", // Ø£Ùˆ gpt-3.5-turbo
              messages: [
                { role: "system", content: "You are a senior Flutter DevOps engineer. You fix build errors by correcting 'pubspec.yaml' and 'android/build.gradle'. Return ONLY the full corrected file content within code blocks." },
                { role: "user", content: prompt }
              ]
            });

            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.openai.com',
                path: '/v1/chat/completions',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${API_KEY}`
                }
              }, (res) => {
                let body = '';
                res.on('data', d => body += d);
                res.on('end', () => {
                  try {
                    const parsed = JSON.parse(body);
                    if(parsed.error) reject(parsed.error.message);
                    else resolve(parsed.choices[0].message.content);
                  } catch(e) { reject(e); }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }

          function extractCode(response) {
            const match = response.match(/```(?:yaml|gradle)?\n([\s\S]*?)\n```/);
            return match ? match[1] : response;
          }

          async function main() {
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø®Ø·Ø£
            const log = fs.readFileSync('build_log.txt', 'utf8').slice(-3000); // Ø¢Ø®Ø± 3000 Ø­Ø±Ù
            const pubspec = fs.readFileSync('pubspec.yaml', 'utf8');
            let gradle = "";
            try { gradle = fs.readFileSync('android/app/build.gradle', 'utf8'); } catch(e){}

            console.log("Analyze Error...");

            // 1. Ø¥ØµÙ„Ø§Ø­ Pubspec (Dependency Hell)
            if (log.includes("version solving failed") || log.includes("Error: Method not found")) {
                console.log("Fixing pubspec.yaml...");
                const prompt = `Fix this Flutter dependency error. \n\nERROR:\n${log}\n\nCURRENT PUBSPEC:\n${pubspec}\n\nProvide the FULL corrected pubspec.yaml file only.`;
                const newPubspec = extractCode(await callAI(prompt));
                fs.writeFileSync('pubspec.yaml', newPubspec);
                console.log("âœ… pubspec.yaml updated.");
            }

            // 2. Ø¥ØµÙ„Ø§Ø­ Gradle (Kotlin/Namespace issues)
            if (log.includes("Namespace") || log.includes("Gradle") || log.includes("minSdkVersion")) {
                console.log("Fixing build.gradle...");
                const prompt = `Fix this Android Gradle error in Flutter. \n\nERROR:\n${log}\n\nCURRENT GRADLE:\n${gradle}\n\nProvide the FULL corrected android/app/build.gradle file only. Ensure namespace is present.`;
                const newGradle = extractCode(await callAI(prompt));
                fs.writeFileSync('android/app/build.gradle', newGradle);
                console.log("âœ… build.gradle updated.");
            }
          }

          main().catch(console.error);
          EOF

          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (ÙŠØªØ·Ù„Ø¨ Node.js ÙˆÙ‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§)
          node ai_repair.js
          
          # ØªÙ†Ø¸ÙŠÙ ÙˆÙ…Ø­Ø§ÙˆÙ„Ø© ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
          flutter clean
          flutter pub get

      # --- 4. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­) ---
      - name: Retry Build (After AI Fix)
        if: steps.build_1.outcome == 'failure'
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ”„ Retrying build after AI fixes..."
          flutter build apk --release --no-android-gradle-daemon

      # --- 5. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ---
      - name: Prepare Artifact
        id: prepare_artifact
        run: |
          APK_PATH=$(find $PROJECT_DIR/build/app/outputs/flutter-apk -name "*.apk" -not -name "*-unsigned.apk" | head -n 1)
          if [ -f "$APK_PATH" ]; then
            echo "âœ… Build Success!"
            mv "$APK_PATH" "$PROJECT_DIR/${SAFE_NAME}.apk"
            echo "FINAL_APK=$PROJECT_DIR/${SAFE_NAME}.apk" >> $GITHUB_ENV
          else
            echo "âŒ Build Failed even after AI attempt."
            exit 1
          fi

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }}"
          body: |
            âœ… **ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­** (Smart Build)
            ğŸ“± **Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** ${{ env.APP_NAME }}
            ğŸ“¦ **Ø§Ù„Ø­Ø²Ù…Ø©:** ${{ env.PACKAGE_NAME }}
            âœ¨ **ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø°Ø§ØªÙŠ:** ${{ steps.build_1.outcome == 'failure' }}
          files: ${{ env.FINAL_APK }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
